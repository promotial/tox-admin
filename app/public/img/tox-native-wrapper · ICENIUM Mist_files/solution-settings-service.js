define(function(e){var h=$.Deferred(),d=e("kendo"),b=e("modules/core/core-module"),f=e("modules/core/rest-proxy"),g=f.init(window.location.host,serviceConfiguration.backendServiceScheme),c=e("noamd/asn-module");var a=window;var i=d.Class.extend({init:function(){var j=this;j._areSettingsLoaded=false;j._provisions=null;j._cryptographicIdentities=null;j._codeSignSettings=null;j._provisionSettings=null;j._solutionSettings=null;j._solutionSettingsLoadedPromise=h.promise();j.initProvisions();j.initCryptographicIdentities();j.initCertificationRequests()},getSolutionSettingsLoadedPromise:function(){var j=this;return j._solutionSettingsLoadedPromise},areSettingsLoaded:function(k){var j=this;if(k===true&&h.state()==="pending"){h.resolve()}return Property.call.apply(j,["areSettingsLoaded",k])},provisions:function(j){return Property.call.apply(this,["provisions",j])},cryptographicIdentities:function(j){return Property.call.apply(this,["cryptographicIdentities",j])},certificationRequests:function(j){return Property.call.apply(this,["certificationRequests",j])},codeSignSettings:function(j){return Property.call.apply(this,["codeSignSettings",j])},provisionSettings:function(j){return Property.call.apply(this,["provisionSettings",j])},solutionSettings:function(j){return Property.call.apply(this,["solutionSettings",j])},initProvisions:function(j){var k=this;g.mobileProvisionService.getProvisions().done(function(l){k.provisions(l);if(j){j(l)}})},initCryptographicIdentities:function(j){var k=this;g.cryptographicIdentityStoreService.getIdentities().done(function(p){for(var n=0,o=p.length;n<o;n++){var m=p[n];p[n]=k.parseCertificate(m)}k.cryptographicIdentities(p);if(j){j(p)}})},initCertificationRequests:function(){var j=this;return g.cryptographicIdentityStoreService.getCertificateRequests().done(function(k){j.certificationRequests(k)})},parseCertificate:function(j){var k=null,l=null;l=c.ASN1.decode(c.Base64.unarmor(j.Certificate));if(l){k=d.parseDate(l.sub[0].sub[4].sub[1].content())}j.expirationDate=k;return j},getProvisionById:function(l){var m=this.provisions();if(m){for(var k=0;k<m.length;k++){var j=m[k];if(j.Identifier===l){return j}}}return null},getCryptographicIdentityById:function(k){var l=this._cryptographicIdentities;for(var j=0;j<l.length;j++){if(l[j].Alias===k){return l[j]}}return null},removeProvision:function(k){var l=this;for(var j=0;j<l._provisions.length;j++){if(l._provisions[j].Identifier===k){l._provisions.splice(j,1);break}}},removeCryptographicIdentity:function(j){var l=this;for(var k=0;k<l._cryptographicIdentities.length;k++){if(l._cryptographicIdentities[k].Alias===j){l._cryptographicIdentities.splice(k,1);break}}},removeCertificateRequest:function(l){var k=this;for(var j=0;j<k._certificationRequests.length;j++){if(k._certificationRequests[j].UniqueName===l){k._certificationRequests.splice(j,1);break}}},updateCodeSigningIdentity:function(o,l,j,p){var t=this,r,s,m=t.codeSignSettings().MobileProjectCodesigningIdentities,k=m[o];if(!k){var n={};m[o]=n;k=n}k[l]=j;r=g.solutionUserSettingsService.setCodesignIdentity({solutionName:iceConfiguration.solutionName,projectIdentity:o,platform:l,identityAlias:j});if(l===a.DevicePlatforms.iOS){if(p!==undefined){var q=t.provisionSettings().MobileProjectProvisionNames;q[o]=p}s=g.solutionUserSettingsService.setMobileProvision({solutionName:iceConfiguration.solutionName,projectIdentity:o,provisionIdentifier:p})}else{s=true}return $.when(r,s)},tryGetProvisionFromSettings:function(k,l){var j=this.getCodeSignIdentityFromSettings(k,a.DevicePlatforms.iOS);l.provisionId=(j)?j.provisionId.toLowerCase().replace(/[{}]/gm,""):null;return(j)?true:false},getCodeSigningIdentities:function(k,j){var l=this;if(k===a.DevicePlatforms.Android){return l.getCryptoIdentitiesAliasList()}else{return l._matchProvisionsAndCryptoIdentities(l.getProvisionCandidates(j),l._cryptographicIdentities)}},getSelectedCodeSignIdentity:function(j,m,k){var n=this;var l=this.getCodeSignIdentityFromSettings(m,k);if(l&&n._getCodeSignIdentityExist(l,j,k)){return l}else{return n.getCodeSigningIdentities(k,j)[0]}},getCryptoIdentitiesAliasList:function(){var l=this._cryptographicIdentities,m=[];if(l!==undefined){for(var j=0;j<l.length;j++){var k=l[j];m.push({cryptographicIdentityId:k.Alias})}}return m},getCryptoIdentitiesList:function(){var l=this._cryptographicIdentities,m=[];if(l!==undefined){for(var j=0;j<l.length;j++){var k=l[j];m.push({cryptographicIdentityId:k.Alias})}}return m},getCodeSignIdentityByProvision:function(s){var v=this,t=s.Certificates,m=v._cryptographicIdentities,u=[];for(var n=0,q=t.length;n<q;n++){var r=t[n],j=null;for(var o=0,p=m.length;o<p;o++){if(m[o].Certificate.replace(/(\r\n|\n|\r)/gm,"").indexOf(r)!==-1){j=m[o];break}}if(j){u.push({name:j.Alias,isValid:true,expirationDate:j.expirationDate})}else{u.push({name:"Not Imported",isValid:false,expirationDate:null})}}u.sort(function(k,l){if(!k.name){return 1}if(!l.name){return -1}return(k.name.localeCompare(l.name))});return u},_matchProvisionsAndCryptoIdentities:function(u,q){var n=[];var m=[];var v=[];if(q&&u){for(var o=0;o<q.length;o++){var p=q[o];for(var r=0;r<u.length;r++){var t=u[r];var l=t.Certificates;for(var s=0;s<l.length;s++){if((p.Certificate.replace(/(\r\n|\n|\r)/gm,"").indexOf(l[s])!==-1)){v.push({provisionName:t.Name,provisionId:t.Identifier,cryptographicIdentityId:p.Alias,identifier:(t.Identifier+p.Alias).replace(/\s/g,"")})}}}}}return v},getCodeSignIdentityFromSettings:function(t,k){var w=this,v=w._provisionSettings,n=w._codeSignSettings,m=[],l=[],q,s,r;if(v&&n){var u=v.MobileProjectProvisionNames,j=n.MobileProjectCodesigningIdentities;if(j!==undefined){for(var o in j){if(o.toLowerCase().indexOf(t.toLowerCase())!==-1){l.push(j[o])}}}if(k===a.DevicePlatforms.Android){if(l.length>0){s=l[0];for(r in s){q=s[r];if(r===k){return{cryptographicIdentityId:q}}}}}else{if(k===a.DevicePlatforms.iOS){if(u!==undefined){for(var p in u){if(p.toLowerCase().indexOf(t.toLowerCase())!==-1){m.push(u[p])}}}if(m.length>0&&l.length>0){s=l[0];for(r in s){q=s[r];if(r===k){return{provisionId:m[0].toLowerCase(),cryptographicIdentityId:q}}}}}}}return null},getProvisionCandidates:function(j,k){var m=this._provisions,n,l;return $(m).filter(function(o){var q=m[o];if(k&&k.indexOf(q.ProvisionType)===-1){return false}l="^"+RegExp.escape(q.ApplicationIdentifier)+"$";l=l.replace("\\*",".*");n=new RegExp(l,"g");return n.test(j)})},_getCodeSignIdentityExist:function(m,j,o){var p=this;var l=p.getCodeSigningIdentities(o,j);if(l){var n;if(o===a.DevicePlatforms.Android){n=function(q){return q.cryptographicIdentityId===m.cryptographicIdentityId}}else{n=function(q){return q.cryptographicIdentityId===m.cryptographicIdentityId&&q.provisionId===m.provisionId}}for(var k=0;k<l.length;k++){if(n(l[k])){return true}}}return false}});return new i()});