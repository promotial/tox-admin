define(function(B){var v,c=B("modules/core/base-classes"),d=B("modules/core/base-commands"),g=B("modules/core/core-module"),o=B("modules/core/helpers"),l=B("modules/core/dialog-viewmodels"),k=B("modules/core/dialog-service"),G=B("modules/workspace/solution-settings-service"),H=B("modules/user/user-identity-service"),C=B("modules/core/rest-proxy"),E=C.init(window.location.host,serviceConfiguration.backendServiceScheme),x=B("text!./options-window-template.html"),s=B("text!./mobile-ios-template.html"),n=B("text!./general-certification-management-template.html"),z=B("text!./password-prompt-template.html"),h=B("text!./create-certification-request-template.html"),j=B("text!./create-self-signed-identity-template.html"),a=B("text!./application-telemetry-template.html"),K=B("text!./user-info-template.html"),q=B("modules/keymap-screen/keymap-screen-module.js");B("jqueryPlaceholder");B("css!./options-window.css");var f=window;var I;var i=l.ConfirmationDialogViewModel.extend({init:function(P,O,N){var Q=this,M={};M.accept=Q.onAccept;M.cancel=Q.onCancel;M.acceptText=f.OK_TEXT;M.rejectVisible=false;Q.actionDeffered=N;l.ConfirmationDialogViewModel.fn.init.apply(Q,[M]);Q.name=P?P:"";Q.email=O?O:"";Q.bind("bind",$.proxy(Q.onBind,Q));Q.bind("change",$.proxy(Q.checkIfValid,Q))},onBind:function(M){var N=this,O=M.view;N._validator=O.kendoValidator().data("kendoValidator"),$("input",O).placeholder()},checkIfValid:function(M){var N=this,O=N._validator&&N._validator.validate();N.set("isValid",O)},countries:["Afghanistan","Aland Islands","Albania","Algeria","American Samoa","Andorra","Angola","Anguilla","Antarctica","Antigua and Barbuda","Argentina","Armenia","Aruba","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bermuda","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Bouvet Island","Brazil","British Indian Ocean Territory","Brunei Darussalam","Bulgaria","Burkina Faso","Burundi","Cambodia","Cameroon","Canada","Cape Verde","Cayman Islands","Central African Republic","Chad","Chile","China","Christmas Island","Cocos (Keeling) Islands","Colombia","Comoros","Congo","Congo, The Democratic Republic of The","Cook Islands","Costa Rica","Cote D'ivoire","Croatia","Cuba","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Ethiopia","Falkland Islands (Malvinas)","Faroe Islands","Fiji","Finland","France","French Guiana","French Polynesia","French Southern Territories","Gabon","Gambia","Georgia","Germany","Ghana","Gibraltar","Greece","Greenland","Grenada","Guadeloupe","Guam","Guatemala","Guernsey","Guinea","Guinea-bissau","Guyana","Haiti","Heard Island and Mcdonald Islands","Holy See (Vatican City State)","Honduras","Hong Kong","Hungary","Iceland","India","Indonesia","Iran, Islamic Republic of","Iraq","Ireland","Isle of Man","Israel","Italy","Jamaica","Japan","Jersey","Jordan","Kazakhstan","Kenya","Kiribati","Korea, Democratic People's Republic of","Korea, Republic of","Kuwait","Kyrgyzstan","Lao People's Democratic Republic","Latvia","Lebanon","Lesotho","Liberia","Libyan Arab Jamahiriya","Liechtenstein","Lithuania","Luxembourg","Macao","Macedonia, The Former Yugoslav Republic of","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Martinique","Mauritania","Mauritius","Mayotte","Mexico","Micronesia, Federated States of","Moldova, Republic of","Monaco","Mongolia","Montenegro","Montserrat","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","Netherlands Antilles","New Caledonia","New Zealand","Nicaragua","Niger","Nigeria","Niue","Norfolk Island","Northern Mariana Islands","Norway","Oman","Pakistan","Palau","Palestinian Territory, Occupied","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Pitcairn","Poland","Portugal","Puerto Rico","Qatar","Reunion","Romania","Russian Federation","Rwanda","Saint Helena","Saint Kitts and Nevis","Saint Lucia","Saint Pierre and Miquelon","Saint Vincent and The Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Georgia and The South Sandwich Islands","Spain","Sri Lanka","Sudan","Suriname","Svalbard and Jan Mayen","Swaziland","Sweden","Switzerland","Syrian Arab Republic","Taiwan, Province of China","Tajikistan","Tanzania, United Republic of","Thailand","Timor-leste","Togo","Tokelau","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Turks and Caicos Islands","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","United States Minor Outlying Islands","Uruguay","Uzbekistan","Vanuatu","Venezuela","Viet Nam","Virgin Islands, British","Virgin Islands, U.S.","Wallis and Futuna","Western Sahara","Yemen","Zambia","Zimbabwe"],name:"",email:"",selectedCountry:"",isValid:false,DerObjectIdentifierNames:{C:"2.5.4.6",CN:"2.5.4.3",EmailAddress:"1.2.840.113549.1.9.1"},onAccept:function(){var N=this;if(N._validator.validate()){var M={};M[N.DerObjectIdentifierNames.CN]=N.get("name").trim();M[N.DerObjectIdentifierNames.EmailAddress]=N.get("email");M[N.DerObjectIdentifierNames.C]=N.get("selectedCountry");N.set("showProgress",true);E.cryptographicIdentityStoreService.generateCertificationRequest({subjectNameValues:M}).done(function(O){g.dataLossProtectionService.suspendOnce();document.location=E.cryptographicIdentityStoreService.getCertificateRequest.url({uniqueName:O.UniqueName});N.trigger(f.CERTIFICATE_REQUEST_GENERATED,{certificateRequest:O});N.set("showClose",true);N.set("showProgress",false)})}}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.CertificateRequest}),canAccept:function(){var M=this,N=M.get("isValid");return N},cancelText:f.CANCEL_TEXT,onCancel:function(){this.closeDialog()}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.CertificateRequest}),getTemplate:function(){return h}});var D=i.extend({init:function(N,M){var P=this,O=new Date();P.nEndDate=new Date(new Date(O).setMonth(O.getMonth()+12));P.gEndDate=new Date(2033,9,23,0,0,0);i.fn.init.apply(P,arguments);P.set("types",["Generic","Google Play"]);P.set("startDate",O);P.set("type","Google Play");P.set("endDate",P.gEndDate)},onIdentityTypeChanged:function(){var M=this;if(M.get("type")==="Google Play"){M.set("endDate",M.gEndDate)}else{M.set("endDate",M.nEndDate)}},canAccept:function(){var O=this;var N=i.fn.canAccept.apply(O,arguments);var M=N&&!!O.get("startDate")&&!!O.get("endDate");if(O.get("type")==="Generic"){return M}return N&&O.get("endDate")>=O.gEndDate},getTemplate:function(){return j},onAccept:function(){var O=this;if(O._validator.validate()){var M={};var N={};N[O.DerObjectIdentifierNames.CN]=O.get("name").trim();N[O.DerObjectIdentifierNames.EmailAddress]=O.get("email");N[O.DerObjectIdentifierNames.C]=O.get("selectedCountry");M.SubjectNameValues=N;M.StartDate=O.get("startDate");M.EndDate=O.get("endDate");O.set("showProgress",true);E.cryptographicIdentityStoreService.generateSelfSignedIdentity({generationData:M}).done(function(Q){var P=G.cryptographicIdentities();if(Q&&P!==undefined){Q=G.parseCertificate(Q);P.push(Q)}g.dataLossProtectionService.suspendOnce();document.location=E.cryptographicIdentityStoreService.getIdentity.url({identityAlias:Q.Alias,password:""});O.trigger(f.IDENTITY_GENERATED,{identity:Q});O.set("showClose",true);O.set("showProgress",false)})}}});var p=c.ViewModelBase.extend({init:function(N){var M=this;c.ViewModelBase.fn.init.apply(M,arguments);M._view=N;M.bind("bind",$.proxy(M.onBind,M))},onBind:function(){var M=this;M._panelBar=M._view.find("#mobileProvisionPanelBar").data("kendoPanelBar");M._grid=M._view.find("#provisionGrid").data("kendoGrid");M.initializeUpload();M.loadProvisions(G.provisions())},onGridBound:function(){var M=this},initializeUpload:function(){var M=this;M._view.find("#provisionFile").kendoUpload({async:{autoUpload:true,saveUrl:E.mobileProvisionService.importProvision.url(),saveField:"provision"},localization:{select:"Import",dropFilesHere:""},upload:$.proxy(M.onUploadProvision,M),success:$.proxy(M.onFileUploadedIE,M),error:$.proxy(M.onUploadError,M),showFileList:false})},onUploadProvision:function(M){var O=this,N=BrowserDetect.browser==="Explorer";O.checkForExtension(M,".mobileprovision");if(!M.isDefaultPrevented()){O.set("isLoading",true);if(!N){$.each(M.files,function(){var P=this.rawFile?this.rawFile:this;E.mobileProvisionService.importProvision({provision:P}).done($.proxy(O.onFileUploaded,O)).fail($.proxy(O.onUploadError,O))});M.preventDefault()}}}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.Provisions}),onFileUploadedIE:function(M){var N=this;if(M.response){if(M.response.ExceptionMessage!==undefined){N.fireKendoError(false,M.response.ExceptionMessage);N.set("isLoading",false)}else{this.onFileUploaded(M.response)}}},onFileUploaded:function(P){var Q=this,N=Q.get("provisions"),O=G.provisions();var M=$.grep(O,function(R){return(R.Identifier===P.Identifier)});if(M.length===0){Q.showWarningIfExpired(P);N.add(P);O.push(P)}else{Q.fireKendoError(false,"Provision already exists.")}Q.set("hasProvisions",O.length>0);Q.set("isLoading",false)},showWarningIfExpired:function(M){var N=kendo.parseDate(M.ExpirationDate),O=new Date();if(N<=O){k.showMessageBox("Provisioning profile is expired","Expired provisioning profile. You will not be able to use the matching cryptographic identity to sign and publish apps.")}},onUploadError:function(M){var O=this,N=M.serverError?M.serverError:M.XMLHttpRequest.statusText;O.set("isLoading",false);O.fireKendoError(false,N)},fireKendoError:function(M,N){var O=this;O.validator=$("#provisionFile").kendoValidator({rules:{isValid:function(){return M}},messages:{isValid:N}}).data("kendoValidator");O.validator.validate()},checkForExtension:function(M,N){var Q=this,O=M.files,P="";$.each(O,function(){if(this.extension!==N){P="Only "+N+" files can be uploaded";Q.fireKendoError(false,P);M.preventDefault()}else{Q.fireKendoError(true,"")}})},provisions:new kendo.data.DataSource({data:[]}),expandProvisionsPanel:function(){var M=this._view.find("#provisionListPanel");this._panelBar.expand(M)},reloadProvisions:function(){var M=this;solutionSettings.initProvisions().done(function(N){M.loadProvisions(N)})},loadProvisions:function(M){var N=this;N.set("hasSelectedProvision",false);N.set("provisions",new kendo.data.DataSource({data:M,schema:{model:{fields:{ProvisionType:{type:"string"},Name:{type:"string"},Identifier:{type:"string"},ExpirationDate:{type:"date"}}}}}));N.provisionsLoaded=true;N.set("hasProvisions",M.length>0);N.updateIsLoading()},updateIsLoading:function(){var M=this;if(M.provisionsLoaded&&M.isLoading){M.set("isLoading",false)}},onDeleteProvision:function(M){var P=this,O=$(M.currentTarget).data("uid"),N=P._grid.dataSource.getByUid(O);k.showConfirmationDialog("Delete Provision",{message:"Deleting a provisioning profile cannot be undone. You will not be able to use the matching cryptographic identity to sign and publish apps. Are you sure you want to delete the selected provisioning profile?",accept:function(){G.removeProvision(N.Identifier);E.mobileProvisionService.removeProvision({identifier:N.Identifier});P._grid.dataSource.remove(N);P.set("hasSelectedProvision",false);P.set("hasProvisions",P.get("provisions").total()>0)}})}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.Provisions}),onProvisionSelectionChanged:function(M){var O=this;var N=O.getSelectedItem();if(N){O.set("hasSelectedProvision",true)}else{O.set("hasSelectedProvision",false)}},onDetailInit:function(R){var Y=this,Q=R.detailRow;Q.find(".tabstrip").kendoTabStrip({animation:false});var P=Y._grid.dataItem(R.detailRow.prev());var O=G.cryptographicIdentities();var Z=[],T=[];var W=P;var X=G;var N=X.getCodeSignIdentityByProvision(W);for(var S=0;S<N.length;S++){var M=N[S];var U=M.isValid&&kendo.parseDate(M.expirationDate)>=new Date();if(U){Z.push(M)}else{T.push(M)}}if(Z.length>0){Q.find(".certificates > .valid").kendoGrid({dataSource:{type:"odata",data:Z},columns:[{title:"&nbsp;",template:"<span class='certificate-icon' />",width:"30px"},{title:"Valid Certificates",field:"name"},{title:"Expiration Date",field:"expirationDate",template:"<span>#: kendo.toString(kendo.parseDate(expirationDate),'d') #</span>"},{title:"&nbsp;",template:"<span class='validation-icon-small valid-icon' title='Certificate is valid.'/>",width:"30px"}]})}if(T.length>0){Q.find(".certificates > .invalid").kendoGrid({dataSource:{type:"odata",data:T},columns:[{title:"&nbsp;",template:"<span class='certificate-icon' />",width:"30px"},{field:"name",title:"Invalid Certificates"},{title:"Expiration Date",field:"expirationDate",template:"<span>#: kendo.toString(kendo.parseDate(expirationDate),'d') #</span>"},{title:"&nbsp;",template:"<span class='validation-icon-small #if (expirationDate) {#expired-icon#}else{#invalid-icon#}# ' title='#if (expirationDate) {#Certificate has expired.#}else{#Please, import the certificate.#}#'/>",width:"30px"}]})}var V=P.ProvisionedDevices;if(P.ProvisionType==="AppStore"||!V){Q.find(".property-panel").css("display","inline-block");return}V=$.map(V,function(aa){return{Id:aa}});Q.find(".devices").kendoGrid({dataSource:{type:"odata",data:V},columns:[{title:"&nbsp;",template:"<span class='device-icon' />",width:"30px"},{field:"Id",title:"&nbsp;"}]})},getSelectedItem:function(){var M=this._grid.select();return this._grid.dataItem(M)},isLoading:true,hasProvisions:false,provisionsLoaded:false,hasSelectedProvision:false});var u=l.MessageBoxViewModel.extend({selectedCategory:"Mobile",shouldSuspendNotifications:false,init:function(){var M=this;M.acceptClickHandler=$.proxy(M.onAccept,M);l.MessageBoxViewModel.fn.init.apply(M,[]);if(BrowserDetect.browser==="Firefox"){M.set("selectedCategory","General")}M.initializeOptionsTree();M.bind("change",$.proxy(M.onPropertyChanged,M))},onPropertyChanged:function(M){var N=this;if(!N.shouldSuspendNotifications&&(M.field==="selectedCategory")){N.clearOptionsHolder();N.initializeTreeView()}},initializeView:function(M){this._view=M;this.initializeTreeView()},initializeTreeView:function(O){var P=this,N=P.createNewHolder();var M=P.getCurrentOptions();P.setUpTreeView(N,M,M[0])},clearOptionsHolder:function(){var M=this;M._view.find("#optionsNavigatorHolder").html("")},createNewHolder:function(){var M=$("<div></div>");this._view.find("#optionsNavigatorHolder").append(M);return M},setPath:function(P){var R=this,Q=P.split("/");R.shouldSuspendNotifications=true;R.set("selectedCategory",Q[0]);R.shouldSuspendNotifications=false;R.clearOptionsHolder();var N=R.createNewHolder();var M=R.getCurrentOptions();var O=R.findOptionsNode(M,Q,1);R.setUpTreeView(N,M,O)},setUpTreeView:function(N,M,O){var P=this;P._treeView=N.kendoTreeView({select:$.proxy(P.onTreeItemSelected,P),dataSource:M}).data("kendoTreeView");o.assignTreeViewDataItems(P._treeView.element,M);P._treeView.select(O.element());P.selectDataItem(O)},findOptionsNode:function(O,P,N){if(N>=P.length){return O[0]}for(var M=0;M<O.length;M++){if(O[M].text!==P[N]){continue}if(O[M].items){return this.findOptionsNode(O[M].items,P,N+1)}else{return O[M]}}},onTreeItemSelected:function(M){var N=$(M.node).data("dataItem");this.selectDataItem(N)},selectDataItem:function(M){var N=this,O=M.viewModel;N.viewModelInstance=new O(N._view);g.viewRenderer.render(M.view,N.viewModelInstance,N._view.find("#optionsView"))},getCurrentOptions:function(){var O=this;for(var M=0,N=O.optionsTree.length;M<N;M++){if(O.optionsTree[M].category===O.selectedCategory){return O.optionsTree[M].options}}},initializeOptionsTree:function(){var P=this;P.optionsTree=[{category:"Mobile",options:[{text:"iOS",view:s,viewModel:p}]},{category:"General",options:[{text:"Certification Management",view:n,viewModel:e},{text:"Application Telemetry",view:a,viewModel:b}]}];var M=[];for(var N=0,O=P.optionsTree.length;N<O;N++){M.push(P.optionsTree[N].category)}P.set("categories",M)}});var b=c.ViewModelBase.extend({init:function(N){var M=this;c.ViewModelBase.fn.init.apply(M,arguments);M._view=N;g.userSettingsService.promise().done($.proxy(M.onUserSettingsLoaded,M))},onUserSettingsLoaded:function(){var N=this,M=g.userSettingsService.getSettings(g.userSettingsService.SETTING_TRACK_FEATURE_USAGE);N.set("isChecked",(M===undefined||M==="true"));N.set("isLoading",false)},onPropertyChange:function(M){var O=this,N=O.isChecked.toString();g.userSettingsService.setSettings(g.userSettingsService.SETTING_TRACK_FEATURE_USAGE,N)},isChecked:true,isLoading:true});var e=c.ViewModelBase.extend({init:function(N){var M=this;c.ViewModelBase.fn.init.apply(M,arguments);M._view=N;M.bind("bind",$.proxy(M.onBind,M))},onBind:function(){var O=this;var P=O._view;O._validator=P.kendoValidator().data("kendoValidator"),O._panelBar=P.find("#certificationManagementPanelBar").data("kendoPanelBar");var M=O._identitiesGrid=P.find("#identitiesGrid",P).data("kendoGrid");var N=O.certificateRequestsGrid=$("#certificateRequestsGrid",P).data("kendoGrid");O.initializeUpload();O.loadGridData(G.cryptographicIdentities());O.set("isLoading",true);O.loadCertReqData(G.certificationRequests());o.applyGridAlternation(M);o.applyGridAlternation(N)},initializeUpload:function(){var M=this;M.generateUploadWidget(M._view.find("#identityFile"),"Import");M.generateUploadWidget(M._view.find("#completeRequest"),"Complete")},generateUploadWidget:function(M,N){var O=this;O._upload=M.kendoUpload({async:{autoUpload:true,saveUrl:"/webapi/",saveField:"stream"},localization:{select:N,dropFilesHere:""},select:$.proxy(O.onFileSelect,O),upload:$.proxy(O.onFileUpload,O),success:$.proxy(O.onFileUploadedIE,O),error:$.proxy(O.onUploadError,O),showFileList:false,multiple:false}).data("kendoUpload")},onFileSelect:function(M){var Q=this,N=M.files[0],O=BrowserDetect.browser==="Explorer";Q.validatorTargetId=M.sender.element.attr("id");if(O){if(N.extension===".p12"){var P=f.prompt("Type the password for the private key.","");var R=E.cryptographicIdentityStoreService.importIdentity.url({importType:"Pkcs12",password:P});Q._upload.options.async.saveUrl=R}else{var S=E.cryptographicIdentityStoreService.importIdentity.url({importType:"X509Certificate",password:null});Q._upload.options.async.saveUrl=S}}},onFileUpload:function(M){var P=this,N=M.files[0],O=BrowserDetect.browser==="Explorer";P._checkExtensions(M);if(!O&&!M.isDefaultPrevented()){if(N.extension===".p12"){P._showPasswordDialog({message:"Type the password for the private key",accept:function(){var R=this,Q=R.password;P._uploadFile("Pkcs12",Q,N.rawFile)}})}else{P._uploadFile("X509Certificate",null,N.rawFile)}M.preventDefault()}}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.Certificates}),_uploadFile:function(N,O,M){var P=this;P.set("isLoading",true);E.cryptographicIdentityStoreService.importIdentity({importType:N,password:O,stream:M}).done($.proxy(P.onFileUploaded,P)).fail($.proxy(P.onUploadError,P))},_checkExtensions:function(N){var Q=this,O=N.files[0],M=[".cer",".p12"],P="";if(M.indexOf(O.extension)<0){P="Allowed file extensions are: "+M.join(",");Q.fireKendoError(false,P);N.preventDefault();return}else{Q.fireKendoError(true,"")}},onUploadError:function(M){var O=this,N=M.serverError?M.serverError:M.XMLHttpRequest.statusText;O.set("isLoading",false);O.fireKendoError(false,N)},fireKendoError:function(M,N){var O=this;O.validator=$("#"+O.validatorTargetId,O._view).kendoValidator({rules:{isValid:function(){return M}},messages:{isValid:N}}).data("kendoValidator");O.validator.validate()},onFileUploadedIE:function(M){this.onFileUploaded(M.response)},onFileUploaded:function(S){var T=this,P=T.get("gridData"),N=T.get("certReqData"),O=G.cryptographicIdentities(),M;if(S&&S.length>0){for(var Q=0;Q<S.length;Q++){var R=S[Q];R=G.parseCertificate(R);P.add(R);O.push(R)}G.initCertificationRequests().done(function(){M=G.certificationRequests();N.data(M);o.applyGridAlternation(T._identitiesGrid);o.applyGridAlternation(T.certificateRequestsGrid);T.set("hasRows",O.length>0);T.set("hasCertReqRows",M.length>0)}).always(function(){T.set("isLoading",false)})}else{T.set("isLoading",false);T.fireKendoError(false,"Nothing to import.")}},loadGridData:function(M){var N=this;N.set("gridData",new kendo.data.DataSource({data:M,schema:{model:{fields:{Alias:{type:"string"}}}},change:$.proxy(N.onIdentityesChange,N)}));N.set("hasRows",M.length>0);N.set("isLoading",false)},loadCertReqData:function(M){var N=this;N.set("certReqData",new kendo.data.DataSource({data:M,schema:{model:{fields:{Subject:{type:"string"}}}},change:$.proxy(N.onCertificateRequestsChange,N)}));N.set("hasCertReqRows",M.length>0);N.set("isLoading",false)},onDeleteIdentity:function(M){var P=this,O=$(M.currentTarget).data("uid"),N=P._identitiesGrid.dataSource.getByUid(O);k.showConfirmationDialog("Delete Certificate",{message:"Deleting a cryptographic identity cannot be undone. Unless you have a backup of the cryptographic identity, you will not be able to restore it and update apps already signed and published with it. Are you sure you want to delete the selected cryptographic identity?",accept:function(){E.cryptographicIdentityStoreService.removeIdentity({identityAlias:N.Alias});G.removeCryptographicIdentity(N.Alias);P._identitiesGrid.dataSource.remove(N);o.applyGridAlternation(P._identitiesGrid);P.set("hasRows",P.get("gridData").data().length>0)}})}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.Certificates}),onDeleteCertificateRequest:function(N){var P=this,M=P.get("certReqData"),O=N.data;k.showConfirmationDialog("Delete Certificate Request",{message:"Are you sure you want to delete request: "+O.Subject+" ?",accept:function(){P.set("isLoading",true);E.cryptographicIdentityStoreService.removeCertificateRequest({uniqueName:O.UniqueName}).done(function(Q){G.removeCertificateRequest(O.UniqueName);M.remove(O);o.applyGridAlternation(P.certificateRequestsGrid);P.set("hasCertReqRows",M.data().length>0)}).always(function(){P.set("isLoading",false)})}})}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.CertificateRequest}),_showPasswordDialog:function(O){var N=O.caption?O.caption:"Password",S=O.viewModel?O.viewModel:new y(O),P,R=function(T){P=T},M=o.buildDialogInputHandler(S),Q={viewInitialized:R,active:function(){M(P)},template:z,viewModel:S};if(O.validator!==undefined){Q.viewModel.validator(O.validator)}k.showModalDialog(N,Q);return Q.viewModel.getPromise()},createCertificationRequest:function(Q){var R=this,T=new i(I.userName,I.email),P,S=function(U){P=U},M=o.buildDialogInputHandler(T),N="Create a Certificate Signing Request",O={viewInitialized:S,active:function(){M(P)},template:T.getTemplate(),width:"450px",viewModel:T};T.bind(f.CERTIFICATE_REQUEST_GENERATED,$.proxy(R.certificateRequstGenerated,R));R.dialog=k.showModalDialog(N,O);Q.preventDefault();Q.stopPropagation()}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.CertificateRequest}),certificateRequstGenerated:function(N){var O=this,M=O.get("certReqData");M.add(N.certificateRequest);o.applyGridAlternation(O.certificateRequestsGrid);O.set("hasCertReqRows",M.total()>0)},createIdentity:function(Q){var R=this,T=new D(I.userName,I.email),P,S=function(U){P=U},M=o.buildDialogInputHandler(T),N="Create a Self-Signed Identity",O={viewInitialized:S,active:function(){M(P)},template:T.getTemplate(),width:"450px",viewModel:T};T.bind(f.IDENTITY_GENERATED,$.proxy(R.selfSignedIdentityGenerated,R));R.dialog=k.showModalDialog(N,O);Q.preventDefault();Q.stopPropagation()}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.SelfSignedIdentity}),selfSignedIdentityGenerated:function(N){var O=this,M=O.get("gridData");if(M!==undefined){M.add(N.identity);O.set("hasRows",O.get("gridData").total()>0)}},downloadCertificateRequest:function(N){var P=this,M=P.get("certificateRequestsGrid"),O=M.dataItem(M.select());g.dataLossProtectionService.suspendOnce();document.location=E.cryptographicIdentityStoreService.getCertificateRequest.url({uniqueName:O.UniqueName})},downloadCryptographicIdentity:function(N){var P=this,M=P.get("_identitiesGrid"),O=M.dataItem(M.select());P._showPasswordDialog({message:"Enter a password for the exported identity",accept:function(){var R=this,Q=R.password;g.dataLossProtectionService.suspendOnce();document.location=E.cryptographicIdentityStoreService.getIdentity.url({identityAlias:O.Alias,password:Q})},passwordRequired:true,confirmPassword:true})},onCertificateRequestsChange:function(){var O=this,M=O.get("certificateRequestsGrid"),N=O.checkSelection(M);O.set("hasSelectedRequest",N)},onIdentityesChange:function(){var O=this,M=O.get("_identitiesGrid"),N=O.checkSelection(M);O.set("hasSelectedIdentity",N)},checkSelection:function(O,N){var R=this,M=O.dataSource,Q,P;if(O){Q=O.select();P=O.dataItem(Q)}if(P&&M.indexOf(P)>=0){return true}else{return false}},validatorTargetId:"",hasSelectedIdentity:false,hasSelectedRequest:false,hasRows:false,hasCertReqRows:false,isLoading:false});var y=l.MessageBoxViewModel.extend({init:function(M){var Q=this;if(M===undefined){M={}}l.MessageBoxViewModel.fn.init.apply(Q,[M.message,M.accept]);if(M.passwordRequired){Q.set("passwordRequired",true)}if(M.confirmPassword){Q.set("confirmPassword",true);Q.set("placeholderText","Password")}var O=["cancel"];for(var P=0;P<O.length;P++){var N=O[P];if(M[N]!==undefined){Q[N+"ClickHandler"]=M[N]}}if(M.message){Q.message=M.message}Q.bind("bind",function(R){var S=this;S.view=R.view;if(S.confirmPassword){S.generateConfirmationValidator()}})},placeholderText:"Could be empty.",message:"",password:"",confirmationPassword:"",passwordRequired:false,confirmPassword:false,confirmationValidator:null,acceptText:f.OK_TEXT,cancelText:f.CANCEL_TEXT,generateConfirmationValidator:function(){var M=this;M.confirmationValidator=$("#confirmationInput",M.view).kendoValidator({rules:{isValid:function(){return M.password===M.confirmationPassword||M.confirmationPassword===""}},messages:{isValid:"Passwords do not match."}}).data("kendoValidator")},onCancelClicked:function(){var M=this;M._buttonClickHandler("cancelClickHandler");M._deferred.resolve()},clearValue:function(){this.set("password","")},clearConfirmationValue:function(){this.set("confirmationPassword","")},validator:function(M){return f.Property.call.apply(this,["validator",M])},canAccept:function(){var Q=this,O=Q.get("password"),N=Q.get("confirmationPassword");if(Q.passwordRequired){var P=O!=="";var M=N!=="";if(Q.confirmPassword){return P&&Q.confirmationValidator.validate()&&M}return P}else{return true}},onAccept:function(){}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.PasswordDialog}),onCancel:function(){}.attribute("track",{featureCategory:f.TrackingTags.featureCategory.Options.name,featureName:f.TrackingTags.featureCategory.Options.PasswordDialog})});var w=kendo.Observable.extend({init:function(){kendo.Observable.fn.init.apply(this,arguments)},showOptionsDialog:function(M){var N=this;var O=new u();k.showModalDialog("User Options",{template:x,viewModel:O,viewInitialized:function(P){O.initializeView(P);if(M){O.setPath(M)}N.initializeSplitter(P)},width:930,height:530});return O.getPromise()},initializeSplitter:function(N){var M=N;if(BrowserDetect.features.iOS){M=$(">.km-scroll-container",M)}M.kendoSplitter({orientation:"vertical",panes:[{collapsible:false,resizable:false,size:"40px"},{collapsible:false,resizable:false}]});N.find("#optionsMainRow").kendoSplitter({orientation:"horizontal",panes:[{collapsible:false,resizable:true,size:"220px",min:"220px"},{collapsible:false,resizable:true,size:"80%"}]})}});var L=d.CommandBase.extend({init:function(){d.CommandBase.fn.init.apply(this,arguments)},execute:function(){}});var t=d.CommandBase.extend({init:function(){var M=this;d.CommandBase.fn.init.apply(M,arguments);M.featureCategory=f.TrackingTags.featureCategory.ProjectNavigation.name;M.featureName=f.TrackingTags.featureCategory.ProjectNavigation.features.ViewOptions},canExecute:function(){if(G){return true}return false},execute:function(){v.showOptionsDialog()}});var m=d.CommandBase.extend({init:function(){var M=this;d.CommandBase.fn.init.apply(this,arguments);M.featureCategory=f.TrackingTags.featureCategory.ProjectNavigation.name;M.featureName=f.TrackingTags.featureCategory.ProjectNavigation.features.ViewFeedback},execute:function(){window.open(f.FeedbackUrl)}});var F=d.CommandBase.extend({init:function(){var M=this;d.CommandBase.fn.init.apply(this,arguments);M.featureCategory=f.TrackingTags.featureCategory.ProjectNavigation.name;M.featureName=f.TrackingTags.featureCategory.ProjectNavigation.features.ShowKeymappings},canExecute:function(){return g.keyBindingService&&q?true:false},execute:function(){q.showKeyMappingDialog()}});var r=d.CommandBase.extend({init:function(){var M=this;d.CommandBase.fn.init.apply(M,arguments);M.featureCategory=f.TrackingTags.featureCategory.ProjectNavigation.name;M.featureName=f.TrackingTags.featureCategory.ProjectNavigation.features.Logout},execute:function(){g.navigationService.logOut()}});var J=d.CommandBase.extend({renderAsHTML:true,init:function(N){var Q=this,P=kendo.template(K),M=arguments,O="";O=P(I);M[1]=O;d.CommandBase.fn.init.apply(Q,M);Q.featureCategory=f.TrackingTags.featureCategory.ProjectNavigation.name;Q.featureName=f.TrackingTags.featureCategory.ProjectNavigation.features.UserInfo},getCssClass:function(){return"menu-user-info"},execute:function(){window.open(I.userActionUrl,"myaccount")}});function A(){var M=this;M.userMenuRootCommand=new L(f.COMMAND_USERMENU_ROOT,I.userName,[f.USER_MENU_COMMANDS]);M.userMenuRootCommand.addCommand(new J(f.COMMAND_USER_INFO,"User Info",[f.USER_MENU_COMMANDS],[])).addCommand(new d.SeparatorCommand(f.COMMAND_SEPARATOR_USER_INFO,"",[f.USER_MENU_COMMANDS],null)).addCommand(new t(f.COMMAND_OPEN_OPTIONS,"Options",[f.USER_MENU_COMMANDS],[])).addCommand(new F(f.COMMAND_SHOW_KEYMAP_SCREEN,"Show Keymappings",[f.GLOBAL_NON_UI_COMMANDS,f.USER_MENU_COMMANDS],[{region:f.GLOBAL_REGION,keyShortcut:{modifiers:[f.KEY_CTRL,f.KEY_SHIFT],keys:[f.KEY_SLASH]}}])).addCommand(new m(f.COMMAND_FEEDBACK,"Feedback",[f.USER_MENU_COMMANDS],[])).addCommand(new d.SeparatorCommand(f.COMMAND_SEPARATOR_LOG_OUT,"",[f.USER_MENU_COMMANDS],null)).addCommand(new r(f.COMMAND_LOG_OUT,"Logout",[f.USER_MENU_COMMANDS],[]));g.commandService.registerCommand(M.userMenuRootCommand)}g.frameService.initializeMenu(f.USER_MENU_REGION,f.USER_MENU_COMMANDS,{shouldAddMenuClass:true});g.loaderService.triggerEvent(f.OPTIONS_LOADED);g.userSettingsService.requestSettings();H.getInitPromise().done(function(){I=H.getUserInfoDetails();if(I){$("#"+f.USER_MENU_REGION).removeClass("menu-loading");A();$("#"+f.USER_MENU_REGION).width($("#"+f.USER_MENU_REGION).width()+3)}});return v=new w()});