define(function(l){var h=l("kendo"),g=l("modules/core/helpers"),e=l("modules/core/core-module"),j=l("modules/project-navigator/project-navigator-module"),o=j.solutionController,p=j.solutionService,m=l("modules/core/rest-proxy"),n=m.init(window.location.host,serviceConfiguration.backendServiceScheme),r=l("modules/view-pane/view-pane-service"),f=l("modules/core/dialog-service"),k=j.projectNavigatorService;var d=window,b={VERSION_NAME_LATEST:"LatestVersion",VERSION_NAME_WORKSPACE:"WorkspaceVersion",SHA_DISPLAY_LENGTH:10},a={None:"None",Added:"Added",Modified:"Modified",Deleted:"Deleted",Renamed:"Renamed",Conflict:"Conflict"},c={Unchanged:"Unchanged",Inserted:"Inserted",Modified:"Modified",Deleted:"Deleted",Imaginary:"Imaginary",Conflict:"Conflict",Local:"Local",Remote:"Remote"};var i=function(){};i.prototype={add:function(s,t){if(s){this[s]=t}},get:function(s){return this[s]},remove:function(s){delete this[s]},getKeysByValue:function(v){var u=this,t=[];for(var s in u){if(u.hasOwnProperty(s)&&u[s]===v){t.push(s)}}return t}};var q=h.Observable.extend({init:function(){var s=this;h.Observable.fn.init.apply(s,arguments);s.statusHash=new i();s.originalPathHash=new i();s._repositoryState={CanCommit:true,CanRevert:true,CanRollback:true,CanReset:true,IsMerging:false,CommentText:""};s._subscribeToEvents();s.suspended=false;s._conflictingFiles=[];j.solutionService.bind(d.SOLUTION_RELOADED_WITHOUT_FILES,$.proxy(s.Track,s))},ChangeType:a,LineChangeType:c,consts:b,VERSION_CONTROL_INIT_MSG:"Retrieving Icenium repository state...",Track:function(){var t=this,s=$.Deferred();n.versionControlService.getInfo({workspaceName:iceConfiguration.solutionName}).done(function(u){t._repositoryState=u});n.versionControlService.track({workspaceName:iceConfiguration.solutionName}).done(function(u){t.statusHash=new i();t.originalPathHash=new i();if(u&&u.length&&u.length>0){for(var v=0;v<u.length;v++){var w=u[v].ChangeType;t.statusHash.add(u[v].FilePath,w);if(u[v].LastPath){t.originalPathHash.add(u[v].FilePath,u[v].LastPath)}}}t.pendingChangesInvalidated=true;o.applyInitialVersionControlStatuses(t.statusHash,p.solution());s.resolveWith(this,[u])});return s.promise()},GetStatus:function(t){var u=this,s=$.Deferred();n.versionControlService.getInfo({workspaceName:iceConfiguration.solutionName}).done(function(v){u._repositoryState=v});n.versionControlService.getStatus({workspaceName:iceConfiguration.solutionName,filePaths:t.filePaths}).done(function(v){s.resolveWith(this,[v])});return s.promise()},Rollback:function(v){var u=this,s=u.GetPendingChanges(),t=g.filterPendingChangesBySelection(s);if(v===undefined||v===""){throw new Error("VersionControlService::Rollback has some missing or invalid parameters.")}u.RevertFiles(t).done(function(){u._onFilesReverted.call(u,v)})},Reset:function(u,s){var t=this;if(u===undefined||u===""||s===undefined||s===""){throw new Error("VersionControlService::Reset has some missing or invalid parameters.")}return n.versionControlService.reset({workspaceName:iceConfiguration.solutionName,versionName:u,resetMode:s})},Commit:function(t){var x=this;if(t===undefined||t.filePaths===undefined||t.filePaths.length===undefined){throw new Error("VersionControlService::Commit has some missing or invalid parameters.")}var u=t.filePaths;for(var v=0,w=u.length;v<w;v++){if(x.originalPathHash.get(u[v])){u.push(x.originalPathHash.get(u[v]))}}var s=$.Deferred();n.versionControlService.commit(t).done(function(y){x.pendingChangesInvalidated=true;s.resolveWith(x,[y])});return s.promise()},RevertFiles:function(y){var A=this,u=[],z;for(var v=0,w=y.length;v<w;v++){var t=y[v];u.push(t.FilePath);var x=A.originalPathHash.get(t.FilePath);if(x&&x!==t.FilePath){u.push(x)}}var s=$.Deferred();n.versionControlService.revert({workspaceName:iceConfiguration.solutionName,versionName:"LatestVersion",filePaths:u}).done(function(F){A.suspended=true;z=A.getProjectFileChange(y);if(z&&z.ChangeType===a.Renamed){r.closeAll();A._updateProjectItem(z)}else{for(var C=0,E=y.length;C<E;C++){var B=y[C],D=A._updateProjectItem(B);if(D){A._removeStatus(D)}else{A.statusHash.remove(B.FilePath)}}if(z){A.pendingChangesInvalidated=true;o.reloadSolution()}}A.pendingChangesInvalidated=true;s.resolveWith(A,[F]);A.suspended=false});return s.promise()},getProjectFileChange:function(v){var x=this,w,s;for(var t=0,u=v.length;t<u;t++){s=v[t];if(s.FilePath.endsWith(".proj")){w=s}}return w},HasPendingChanges:function(){return this.GetPendingChanges().length>0},HasPendingChangesForSelection:function(){return this.GetPendingChangesForSelection().length>0},HasConflicts:function(){var t=this;for(var s in t.statusHash){if(t.statusHash[s]===a.Conflict){return true}}return false},GetRepositoryState:function(){return this._repositoryState},ensureCleanStateBeforePullPush:function(){var u=this,s=new $.Deferred();var t=u.HasPendingChanges();if(t){if(u.HasConflicts()){f.showConfirmationDialog("Version Control",{template:["This operation requires the local repository to be in a clean state without any unresolved conflicts.","Do you want to attempt resolving the conflicts now?"].join("<br/>"),accept:function(){s.resolve(2)},reject:function(){s.reject()}})}else{f.showConfirmationDialog("Version Control",{template:["This operation requires the local repository to be in a clean state without any uncommited changes.","Do you want to commit all pending changes now?"].join("<br/>"),accept:function(){s.resolve(0)},reject:function(){s.reject()}})}}else{s.resolve()}return s.promise()},pendingChanges:[],pendingChangesInvalidated:true,pendingChangeContext:null,GetPendingChangesForSelection:function(){var D=this,C=p.solution(),A=k.selectedDomElements().slice(),w=D.GetPendingChanges(),y=[],z=[];if(!C){return[]}if(A.length<=0){A=[C._element]}for(var u=0;u<A.length;u++){var B=A[u];var x=$(B).data("dataItem");if(x){z.push(x.getPathWithoutText())}}for(var v=0;v<w.length;v++){var t=w[v];for(var s=0;s<z.length;s++){if(t.name.startsWith(z[s])){y.push(t)}}}return y},GetPendingChanges:function(){var F=this,E=p.solution(),C=[E],D=[];if(!E||count(this.statusHash)===0){return[]}var w=E.childItems()[0].hiddenItems[0];C=C.concat(w);if(!F.pendingChangesInvalidated){return F.pendingChanges}while(C.length>0){var u=C.shift(),z=u.getFullPath(),x=u.iconType(),t=F.statusHash.get(z);if(t&&t!==a.None&&t!==a.Conflict&&t!==a.Deleted){var s={name:z,changeType:F.ChangeType[t],iconType:x};D.push(s)}if(u.childItems()&&u.childItems().length>0){C=C.concat(u.childItems())}}var B=F.statusHash.getKeysByValue(a.Deleted);for(var A in B){var v=B[A].replace(/\//gi,"\\"),y={name:v,changeType:a.Deleted,iconType:g.getIconTypeByFilePath(v)};D.push(y)}D.sort(function(G,H){return G.name.toLowerCase().localeCompare(H.name.toLowerCase())});F.pendingChanges=D;F.pendingChangesInvalidated=false;return D},GetChangesets:function(){return n.versionControlService.getCommits({workspaceName:iceConfiguration.solutionName})},GetChangesetItems:function(s){if(s===undefined||s.changesetId===undefined){throw new Error("VersionControlService::GetChangesetItems has some missing or invalid parameters.")}return n.versionControlService.getChanges({workspaceName:iceConfiguration.solutionName,versionName:s.changesetId})},GetCommitDetails:function(u){var t=this,s=$.Deferred();t.GetChangesets().done(function(x){var v=null;if(x.length>0){if(u==="LatestVersion"){v=x[0]}else{for(var w=0;w<x.length;w++){if(x[w]["VersionName"]===u){v=x[w]}}}}s.resolveWith(t,[v])}).fail(function(v){s.rejectWith(t,[v])});return s.promise()},GetFileHistory:function(t){if(t===undefined||t.versionName===undefined||t.path===undefined){throw new Error("VersionControlService::GetFileHistory has some missing or invalid parameters.")}var s=$.Deferred();n.versionControlService.getHistory({workspaceName:iceConfiguration.solutionName,versionName:t.versionName,filePath:t.path}).done(function(u){s.resolveWith(this,[t.path,u])});return s.promise()},GetDiff:function(t){if(t===undefined||t.contextSize===undefined||t.filePaths===undefined){throw new Error("VersionControlService::GetDiff has some missing or invalid parameters.")}var s=$.Deferred();n.versionControlService.getDiff({workspaceName:iceConfiguration.solutionName,versionName:"LatestVersion",otherVersionName:"WorkspaceVersion",contextSize:t.contextSize,filePaths:t.filePaths}).done(function(u){s.resolveWith(this,[u,t.filePaths])});return s.promise()},GetConflicts:function(t){if(t===undefined||t.contextSize===undefined||t.filePaths===undefined){throw new Error("VersionControlService::GetConflicts has some missing or invalid parameters.")}n.versionControlService.getConflicts({workspaceName:iceConfiguration.solutionName,contextSize:t.contextSize,filePaths:t.filePaths}).done(function(u){s.resolveWith(this,[u,t.filePaths])});var s=$.Deferred();return s.promise()},Resolve:function(s){if(s===undefined||s.versionToResolve===undefined||s.versionToResolve===""||s.conflictingFiles===undefined||s.conflictingFiles.length===undefined){throw new Error("VersionControlService::Resolve has some missing or invalid parameters.")}return n.versionControlService.resolve({workspaceName:iceConfiguration.solutionName,versionName:s.versionToResolve,filePaths:s.conflictingFiles})},GetContents:function(t){var u=this,s=$.Deferred();n.versionControlService.getContents({workspaceName:iceConfiguration.solutionName,versionName:t.versionName,filePath:t.filePath}).done(function(v){s.resolveWith(u,[v])}).fail(function(v){s.rejectWith(u,[v])});return s.promise()},_subscribeToEvents:function(){var s=this;o.bind(d.VERSION_CONTROL_ADD,$.proxy(s._onAddItem,s));o.bind(d.VERSION_CONTROL_DELETE,$.proxy(s._onDeleteItem,s));o.bind(d.VERSION_CONTROL_MODIFY,$.proxy(s._onModifyItem,s));o.bind(d.VERSION_CONTROL_RENAME,$.proxy(s._onRenameItem,s));o.bind(d.SOLUTION_DATA_REQUESTED,$.proxy(s.Track,s));o.bind(d.VERSION_CONTROL_PROJECT_FILE_STATUS_REFRESH,$.proxy(s.onProjectFileStatusRefresh,s));o.bind(d.VERSION_CONTROL_CONFLICT,$.proxy(s.onConflict,s));p.bind(d.SOLUTION_OPENED,$.proxy(s.onSolutionOpened,s))},onSolutionOpened:function(){var s=this;e.progressService.beginSubtask({identifier:s.VERSION_CONTROL_INIT_MSG,totalWorkCount:1});n.versionControlService.getInfo({workspaceName:iceConfiguration.solutionName}).done(function(t){s.repositoryState=t;e.progressService.updateTaskProgress({identifier:s.VERSION_CONTROL_INIT_MSG,completedUnitsCount:1})})},_onRenameItem:function(s){if(this.suspended){return}this.pendingChangesInvalidated=true;if(s.dataItem.isFolder){return}var B=this,u=s.dataItem,A=u.project.getFullPath(),z=u.project.text,w=[z,s.oldIdentifier].join("\\"),v=[z,s.newIdentifier].join("\\"),x=B.originalPathHash.get(w),y=B.originalPathHash.get(A);if(x){B.originalPathHash.remove(w)}else{x=w}B.originalPathHash.add(v,x);B.statusHash.remove(w);var C=[x,v,A];if(y){C.push(y)}var t=n.batchingManager.CreateBatch();t.Begin();n.versionControlService.move({workspaceName:iceConfiguration.solutionName,oldPaths:[w],newPaths:[v]});B.GetStatus({filePaths:C}).done(function(D){if(s.dataItem.projectItemType()===d.PROJECT_ITEM_FILE){B._removeStatus(u);if(D&&D.length&&D.length>0){B._updateStatus(D,u.project,u)}}});t.SendSequential()},_onAddItem:function(s){if(this.suspended){return}this.pendingChangesInvalidated=true;var D=this,B=s.itemPath,u=s.dataItem,C=u.project.getFullPath(),v=[B,C],y=D.originalPathHash.getKeysByValue(B),A=D.originalPathHash.get(C);for(var w=0,x=y.length;w<x;w++){var z=y[w].replace(/\//gi,"\\");v.push(z)}if(A){v.push(A)}if(s.isFile){D._removeStatus(u);var t=n.batchingManager.CreateBatch();t.Begin();n.versionControlService.add({workspaceName:iceConfiguration.solutionName,filePaths:[B]});D.GetStatus({filePaths:v}).done(function(E){if(E&&E.length&&E.length>0){D._updateStatus(E,u.project,u)}});t.SendSequential()}},_onDeleteItem:function(s){if(this.suspended){return}this.pendingChangesInvalidated=true;var z=this,u=s.dataItem,x=u.getFullPath(),v=z.originalPathHash.get(u.getFullPath()),y=u.project.getFullPath(),A=[x,y],w=z.originalPathHash.get(y);if(v){A.push(v)}if(w){A.push(w)}if(u.isFolder===undefined||u.isFolder===false){z._removeStatus(u);var t=n.batchingManager.CreateBatch();t.Begin();n.versionControlService.remove({workspaceName:iceConfiguration.solutionName,filePaths:[x]});z.GetStatus({filePaths:A}).done(function(B){if(B&&B.length&&B.length>0){z._updateStatus(B,u.project,u)}});t.SendSequential()}},_onModifyItem:function(s){if(this.suspended){return}this.pendingChangesInvalidated=true;var A=this,u=s.dataItem,y=u.getFullPath(),z=u.project.getFullPath(),v=[y,z],w=A.originalPathHash.get(y),x=A.originalPathHash.get(z);if(w){v.push(w)}if(x){v.push(x)}var t=n.batchingManager.CreateBatch();t.Begin();A.GetStatus({filePaths:v}).done(function(B){if(s.dataItem.projectItemType()===d.PROJECT_ITEM_FILE){A._removeStatus(u);if(B&&B.length&&B.length>0){A._updateStatus(B,u.project,u)}}});t.SendSequential()},onProjectFileStatusRefresh:function(s){if(this.suspended){return}var z=this,w=s.dataItem,y=w.solution,x=w.getFullPath(),u=[x],v=z.originalPathHash.get(x);if(v){u.push(v)}if(w&&y){z._removeStatus(w);var t=n.batchingManager.CreateBatch();t.Begin();z.GetStatus({filePaths:u}).done(function(A){if(A&&A.length&&A.length>0){z._updateStatus(A,w)}});t.SendSequential()}},_onFilesReverted:function(t){var s=this;n.versionControlService.rollback({workspaceName:iceConfiguration.solutionName,versionName:t}).done($.proxy(s._onRollbackCompleted,s))},_onRollbackCompleted:function(){var s=this;s.pendingChangesInvalidated=true;s.Track({workspaceName:iceConfiguration.solutionName}).done(function(t){o.reloadSolution()})},_updateProjectItem:function(t){var K=this,J=p.solution(),F=J.getMobileProject(),u=typeof t.ChangeType==="string"?K.ChangeType[t.ChangeType]:t.ChangeType;switch(u){case a.Added:var s=J.getItemByFilePath(t.FilePath);if(!s){var H=t.FilePath.split("\\").splice(2).join("\\");s=F._getResourceItem(H)}o.deleteItem(s);return s;case a.Deleted:var I;if(t.FilePath.indexOf(F.text+d.APP_RESOURCES_PATH)<0){var x=t.FilePath.split("\\"),y=x.pop(),E=x.join("\\"),v=o.ensureFolderByPath(E);I=o.addNewItem(v,y)}return I;case a.Modified:var z=J.getItemByFilePath(t.FilePath);if(z&&!z.isProject){o.reloadItemByPath(z.getPath())}return z;case a.Renamed:var D=t.LastPath?t.LastPath:t.FilePath;var G=J.getItemByFilePath(D),C=K.originalPathHash.get(t.FilePath),B=C.split("\\"),A=B.pop();C=B.join("\\");if(G){if(G.isProject){o.renameItem(G,A.replace(".proj",""),true);return G}if(C===G.parentItem.getPathWithoutText()){o.renameItem(G,A,true)}else{if(G.properties&&G.properties.DependentUpon&&C===G.parentItem.parentItem.getPathWithoutText()){o.renameItem(G,A,true)}else{var w=o.ensureFolderByPath(C);o.moveItem(w,G,true);if(G.text!==A){o.renameItem(G,A,true)}}}K.originalPathHash.remove(t.FilePath);o.reloadItemByPath(G.getPath())}return G;default:return null}},_removeStatus:function(s){var u=this,t=s.project;u.statusHash.remove(s.getFullPath());o.toggleItemChangeType(s,a.None);if(t){u.statusHash.remove(t.getFullPath());o.toggleItemChangeType(t,a.None)}},_updateStatus:function(A,w,s){var z=this,x=p.solution();z.pendingChangesInvalidated=true;if(s){z.statusHash.remove(s.getFullPath())}z.statusHash.remove(w.getFullPath());for(var t=0;t<A.length;t++){var y=A[t].ChangeType,v=A[t].FilePath;z.statusHash.add(v,y);if(s&&v===s.getFullPath()){o.toggleItemChangeType(s,y)}else{if(v===w.getFullPath()){o.toggleItemChangeType(w,y)}else{var u=x.getItemByFilePath(v);if(u){o.toggleItemChangeType(u,y)}}}}},_checkIfFileSelected:function(s,u){for(var t=0;t<u.length;t++){if(s.indexOf(u[t])===0){return true}}return false},onConflict:function(s){var t=this;t._conflictingFiles=s.conflictingFiles},HasConflictingFiles:function(){return this._conflictingFiles.length>0},GetConflictingFiles:function(){var s=this;if(s._conflictingFiles===undefined){s._conflictingFiles=[]}return s._conflictingFiles}});return new q()});