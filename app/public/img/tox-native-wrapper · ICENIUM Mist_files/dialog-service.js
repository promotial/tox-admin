define(function(i){var h=i("kendo"),g=i("modules/core/helpers"),f=i("modules/core/dialog-viewmodels"),j=i("./view-renderer"),b=i("text!../reusable-templates/confirmation-template.html"),a=i("text!../reusable-templates/confirmation-filelist-template.html"),d=i("text!../reusable-templates/credentials-dialog-template.html");var c=window;var e=h.Class.extend({init:function(){this.modalDialogs=[]},showDialog:function(k,o,t){var r=this,n=$(o.template),q=n,s=o.viewModel,l=t.activate;if(s.onClose){if(t.close){throw"Implement viewModel.onClose and call base onClose"}t.close=function(){s.onClose.apply(s,arguments)}}t.activate=function(){$(":input:visible:enabled",n).first().focus();if(o.active){o.active()}if(l){l.apply(this,arguments)}};var m=$(n).kendoWindow(t).data("kendoWindow");m.element.parent().addClass("popup");if(o.className){m.element.parent().addClass(o.className)}if(o.innerTemplate){q=r.prepareRootElement(n,o)}if(s instanceof f.DialogViewModelBase){s.dialog(m)}function p(){m.center().open();if(s!==undefined){j.bind(s,n)}r.postWindowRendering(n.parent());if(o.viewInitialized){o.viewInitialized(q)}}if(r.systemDialog!==null){r.systemDialog.viewModel.getPromise().always(p)}else{p()}return{dialog:m,viewModel:s}},showNonModalDialog:function(k,l){var n=this;var o=n.getNonModalWindowConfiguration(k,l);var m=n.showDialog(k,l,o);return m.dialog},showModalDialog:function(k,l){var n=this;var o=n.getModalWindowConfiguration(k,l);var m=n.showDialog(k,l,o);n.modalDialogs.push(m);return m.dialog},prepareRootElement:function(k,l){var m=k.find("#innerTemplateHolder");m.html(l.innerTemplate);return m.children()},getModalWindowConfiguration:function(k,m){var n=this;var l=n._getDefaultWindowConfiguration(k,m);l.modal=true;return l},getNonModalWindowConfiguration:function(k,m){var n=this;var l=n._getDefaultWindowConfiguration(k,m);l.modal=false;return l},showConfirmationDialog:function(k,l){var n=this;var m={template:b,innerTemplate:l.template,viewInitialized:l.viewInitialized,active:l.active,width:l.width,height:l.height,close:l.close};if(l.viewModel!==undefined){m.viewModel=l.viewModel}else{m.viewModel=new f.ConfirmationDialogViewModel(l)}if(l.validator!==undefined){m.viewModel.validator(l.validator)}n.showModalDialog(k,m);return m.viewModel.getPromise()},showFileListConfirmationDialog:function(k,l){var m=this;if(l.template===undefined){l.template=a}if(l.viewModel===undefined){l.viewModel=new f.ConfirmationFileListDialogViewModel(l)}return m.showConfirmationDialog(k,l)},systemDialog:null,showSystemDialog:function(k,l){if(this.systemDialog!==null){return}var m=this,n=l.viewModel;m.systemDialog={dialog:m.showModalDialog(k,l),viewModel:n};n.dialog(m.systemDialog.dialog);n.getPromise().always(function(){m.systemDialog=null});return m.systemDialog},showMessageBox:function(l,m,k){var n=new f.MessageBoxViewModel(m,k);this.showModalDialog(l,{template:b,viewModel:n});return n.getPromise()},showCredentialsDialog:function(m){var p=this,l=m.caption?m.caption:"User Credentials",r=m.viewModel?m.viewModel:new f.UserCredentialsDialogViewModel(m),n,q=function(s){n=s},k=g.buildDialogInputHandler(r),o={viewInitialized:q,active:function(){k(n)},template:d,viewModel:r,width:"410px"};if(m.validator!==undefined){o.viewModel.validator(m.validator)}p.showModalDialog(l,o);return o.viewModel.getPromise()},closeCurrentModalDialog:function(){var m=this;if(m.isModalDialogShown()){var l=m.modalDialogs;var k=l[l.length-1];if(k.viewModel.onCancelClicked){k.viewModel.onCancelClicked()}else{k.dialog.close()}}},isModalDialogShown:function(){return this.modalDialogs.length>0},postWindowRendering:function(m){var l=$(":input:visible:enabled",m),k;$(m).keydown(function(n){if(n.keyCode===c.KEY_TAB){k=$(":input:focus",m);if(n.shiftKey&&k[0]===l.first()[0]){n.preventDefault();l.last().focus()}else{if(!n.shiftKey&&k[0]===l.last()[0]){n.preventDefault();l.first().focus()}}}})},_getDefaultWindowConfiguration:function(k,l){var m=this;return{title:k,actions:l.actions&&l.actions.length>0?l.actions:["Close"],draggable:true,width:l.width,height:l.height,minWidth:l.minWidth,minHeight:l.minHeight,resizable:l&&l.resizable===true?true:false,animation:{open:{effects:"fade:in"},close:{effects:"fade:in",reverse:true}},deactivate:function(o){var n=o.sender;m.modalDialogs.pop();n.destroy()},close:l&&l.close?l.close:null,resize:l&&l.resize?l.resize:null}}});return new e()});