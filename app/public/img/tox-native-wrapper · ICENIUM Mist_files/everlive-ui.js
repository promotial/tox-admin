define(function(D){var q,w=D("kendo"),f=D("modules/core/core-module"),b=D("modules/core/base-classes"),c=D("modules/core/base-commands"),g=D("modules/core/dialog-service"),p=D("./everlive-data"),r=D("text!./everlive-ui-nav-template.html"),m=D("modules/everlive/everlive-api"),x=D("modules/logging/logging-service"),A=D("modules/core/progress-service"),G=D("modules/tracking/tracking-service");D("css!./everlive.css");D("modules/workspace/sidebar-module");D("modules/project-navigator/project-navigator-module");var e=window;var t={everliveroot:"everliveroot",app:"app",contenttype:"contenttype",field:"field"};var v={0:"Unknown",1:"Text",2:"Number",3:"DateTime",4:"YesNo",5:"GeoPoint",6:"File",7:"Relation"};var z={1:"System",2:"UserDefined"};var n=c.CommandBase.extend({init:function(){var L=this;c.CommandBase.fn.init.apply(L,arguments);L.featureCategory=e.TrackingTags.featureCategory.Everlive.name},canExecute:function(){return true},isApplicable:function(){var O=this;var Q=this.getType();var P=a.data("kendoTreeView");var N=P.select();if(!N){return false}var M=P.dataItem(N);if(!M){return false}var L=O.getApplicableCommandTypes(M.NodeType);return L.indexOf(Q)!==-1},commandsPerNodeType:{everliveroot:[e.COMMAND_EVERLIVE_NAVIGATE_TO_PORTAL],app:[e.COMMAND_EVERLIVE_SHOW_APPLICATION,e.COMMAND_EVERLIVE_VIEW_CLOUD_CODE_LOG,e.COMMAND_EVERLIVE_EDIT_USERS,e.COMMAND_EVERLIVE_EDIT_ROLES,e.COMMAND_EVERLIVE_EDIT_FILES,COMMAND_EVERLIVE_EDIT_SETTINGS,e.COMMAND_EVERLIVE_PROPERTIES],contenttype:[e.COMMAND_EVERLIVE_EDIT_FIELDS,e.COMMAND_EVERLIVE_VIEW_CLOUD_CODE,e.COMMAND_EVERLIVE_VIEW_PERMISSIONS,e.COMMAND_EVERLIVE_SHOW_ITEMS,e.COMMAND_EVERLIVE_PROPERTIES],field:[e.COMMAND_EVERLIVE_EDIT_FIELDS,e.COMMAND_EVERLIVE_PROPERTIES]},getApplicableCommandTypes:function(L){var N=this;var O=L.replace("-","");var M=N.commandsPerNodeType[O];if(M===undefined){return[]}return M},getSelectedNode:function(){var M=a.data("kendoTreeView");var L=M.select();if(!L){return null}return L},getSelectedNodeType:function(){var O=this;var P=a.data("kendoTreeView");var N=O.getSelectedNode();if(!N){return""}var L=P.dataItem(N);if(!L){return""}var M=L.NodeType;if(!M){return""}return M}});var B=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments)},execute:function(){var L=this.scope;if(!L.isPropertyGridVisible()){L.closePropertyGrid()}},getType:function(){return e.COMMAND_EVERLIVE_PROPERTIES}});var o=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.ViewContentType},canExecute:function(){var L=this.getSelectedNodeType();return L==="content-type"}});var y=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.ViewPortal},canExecute:function(){return true},execute:function(){var O=this;var P=a.data("kendoTreeView");var N=P.select();if(!N){return}var L=P.dataItem(N);var M=O.getSelectedNodeType().replace("-","");var Q=O.getPortalUrlByNodeType(L,M);window.open(Q,M)},getPortalUrlByNodeType:function(M,N){var L,O;if(!N||!M){return}if(N===t.everliveroot){return m.getPortalUrl()}else{if(N===t.app){L=M.Id;return w.format(m.getPortalApps(),L)}else{if(N===t.contenttype){L=M.ApplicationId;O=M.Id;return w.format(m.getPortalTypes(),L,O)}else{if(N===t.field){L=M.parentNode().ApplicationId;O=M.ContentTypeId;return w.format(m.getPortalTypes(),L,O)}}}}},getType:function(){return e.COMMAND_EVERLIVE_NAVIGATE_TO_PORTAL}});var E=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.ViewApplication},execute:function(){var O=this;var P=a.data("kendoTreeView");var N=P.select();if(!N){return}var L=P.dataItem(N);var M=O.getSelectedNodeType().replace("-","");var Q=O.getPortalUrlByNodeType(L,M);window.open(Q,M)},getPortalUrlByNodeType:function(M,N){if(!N||!M){return}if(N===t.everliveroot){return m.getPortalUrl()}else{if(N===t.app){var L=M.Id;return w.format(m.getPortalApps(),L)}else{if(N===t.contenttype){var L=M.ApplicationId;var O=M.Id;return w.format(m.getPortalTypes(),L,O)}else{if(N===t.field){var L=M.parentNode().ApplicationId;var O=M.ContentTypeId;return w.format(m.getPortalTypes(),L,O)}}}}},getType:function(){return e.COMMAND_EVERLIVE_SHOW_APPLICATION}});var h=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.ViewFields},execute:function(){var O=this;var P=a.data("kendoTreeView");var N=P.select();if(!N){return}var L=P.dataItem(N);var M=O.getSelectedNodeType().replace("-","");var Q=O.getPortalUrlByNodeType(L,M);window.open(Q,M)},getPortalUrlByNodeType:function(M,N){var L,O;if(!N||!M){return}if(N===t.everliveroot){return m.getPortalUrl()}else{if(N===t.app){L=M.Id;return w.format(m.getPortalApps(),L)}else{if(N===t.contenttype){L=M.ApplicationId;O=M.Id;return w.format(m.getPortalTypes(),L,O)}else{if(N===t.field){L=M.parentNode().ApplicationId;O=M.ContentTypeId;return w.format(m.getPortalTypes(),L,O)}}}}},getType:function(){return e.COMMAND_EVERLIVE_EDIT_FIELDS}});var H=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.EditCloudCode},execute:function(){var Q=m.getCloudCodeUrl();var O=a.data("kendoTreeView");var N=O.select();if(!N){return}var M=O.dataItem(N);if(!M){return}var L=M.ApplicationId;var P=M.Id;Q=w.format(Q,L,P);window.open(Q,"cloudCode")},getType:function(){return e.COMMAND_EVERLIVE_VIEW_CLOUD_CODE}});var I=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.ViewLog},execute:function(){var P=m.getCloudCodeLogUrl();var O=a.data("kendoTreeView");var N=O.select();if(!N){return}var M=O.dataItem(N);if(!M){return}var L=M.Id;P=w.format(P,L);window.open(P,"cloudCodeLog")},getType:function(){return e.COMMAND_EVERLIVE_VIEW_CLOUD_CODE_LOG}});var K=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.ViewPermissions},canExecute:function(){var N=a.data("kendoTreeView");var M=N.select();if(!M){return}var L=N.dataItem(M);if(!L){return false}return L.NodeType==="content-type"},execute:function(){var Q=m.getPermissionsUrl();var O=a.data("kendoTreeView");var N=O.select();if(!N){return}var M=O.dataItem(N);if(!M){return}var L=M.ApplicationId;var P=M.Id;Q=w.format(Q,L,P);window.open(Q,"cloudCodeLog")},getType:function(){return e.COMMAND_EVERLIVE_VIEW_PERMISSIONS}});var l=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.EditUsers},execute:function(){var P=m.getPortalUsersUrl();var O=a.data("kendoTreeView");var N=O.select();if(!N){return}var M=O.dataItem(N);if(!M){return}var L=M.Id;P=w.format(P,L);window.open(P,"users")},getType:function(){return e.COMMAND_EVERLIVE_EDIT_USERS}});var j=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.EditRoles},execute:function(){var P=m.getPortalRolesUrl();var O=a.data("kendoTreeView");var N=O.select();if(!N){return}var M=O.dataItem(N);if(!M){return}var L=M.Id;P=w.format(P,L);window.open(P,"roles")},getType:function(){return e.COMMAND_EVERLIVE_EDIT_ROLES}});var i=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.EditFields},execute:function(){var P=m.getPortalFilesUrl();var O=a.data("kendoTreeView");var N=O.select();if(!N){return}var M=O.dataItem(N);if(!M){return}var L=M.Id;P=w.format(P,L);window.open(P,"files")},getType:function(){return e.COMMAND_EVERLIVE_EDIT_FILES}});var k=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.EditSettings},execute:function(){var P=m.getPortalSettingsUrl();var O=a.data("kendoTreeView");var N=O.select();if(!N){return}var M=O.dataItem(N);if(!M){return}var L=M.Id;P=w.format(P,L);window.open(P,"settings")},getType:function(){return e.COMMAND_EVERLIVE_EDIT_SETTINGS}});var F=n.extend({init:function(){var L=this;n.fn.init.apply(L,arguments);L.featureName=e.TrackingTags.featureCategory.Everlive.features.ShowItems},execute:function(){var Q=m.getPortalItemsUrl();var O=a.data("kendoTreeView");var N=O.select();if(!N){return}var M=O.dataItem(N);if(!M){return}var L=M.ApplicationId;var P=M.Id;Q=w.format(Q,L,P);window.open(Q,"items")},getType:function(){return e.COMMAND_EVERLIVE_SHOW_ITEMS}});var s=b.ViewModelBase.extend({init:function(L){var M=this;M.propertyGridVisible=false;M.placeHolder=null;M.treeView=null;M.propertiesDS=new w.data.DataSource({data:[]});b.ViewModelBase.fn.init.apply(M,arguments);M.bind("bind",$.proxy(M.onBind,M));M.config=L;M.adapter=L.adapter;M.adapter.bind(e.EVERLIVE_FAILURE,$.proxy(M.onEverliveFail,M));f.keyBindingService.bind(e.REGION_FOCUS_CHANGE,$.proxy(M.onRegionFocusChange,M));M.everliveEnablePanelVisible=false;M.everliveInfoPanelVisible=false},onBind:function(L){var M=this;if(L){M.placeHolder=L.view}ice.server.everliveService.getAccountKeyAsync().done(function(N){if(N){M.renderEverliveTree(N);M.renderPropertyGrid();M.set("refreshEnabled",true);M.set("everliveInfoPanelVisible",false);M.set("everliveEnablePanelVisible",false)}else{M.set("refreshEnabled",false);M.set("propertyGridVisible",false);M.set("everliveInfoPanelVisible",false);M.set("everliveEnablePanelVisible",true)}}).fail(function(N){x.logOutputMessage(["Everlive","Everlive authentication failed."].join(": "));M.set("refreshEnabled",true);M.set("everliveInfoPanelVisible",true);M.set("everliveEnablePanelVisible",false)})},onEnableClicked:function(){var L=this;A.showProgress("Enabling Everlive...");ice.server.everliveService.provisionAccountAsync().done(function(M){A.hideProgress();if(M){L.renderEverliveTree(M);L.renderPropertyGrid();L.set("refreshEnabled",true);L.set("everliveInfoPanelVisible",false);L.set("everliveEnablePanelVisible",false)}}).fail(function(M){A.hideProgress();x.logOutputMessage(["Everlive","Everlive authentication failed."].join(": "));L.set("refreshEnabled",true);L.set("everliveInfoPanelVisible",true);L.set("everliveEnablePanelVisible",false)})},onEverliveFail:function(L){var N=this;var M=$("button.everlive-retry-button",a);M.click(function(P){var Q=$(P.srcElement).parent().parent().parent().parent().parent();var O=N._treeView.dataItem(Q);O.loaded(false);O.load();P.preventDefault();P.stopPropagation()});M.parent().parent().children("span.k-icon.k-plus").hide()},renderEverliveTree:function(L){var O=this,M=$(O.placeHolder).find("#everliveTreePane");a=$("<div></div>");a.appendTo(M);O._treeView=a.kendoTreeView({animation:false,dataSource:O.adapter.GetDataSource(L),loadOnDemand:true,select:$.proxy(O.onTreeItemSelected,O),template:w.template("<span class='everlive-type-icon ico-#= item.NodeType # ico-type-#=item.Type #' ></span><span class='everlive-node retry-text'>#= item.Title #</span># if (item.NodeType === 'err') { #<button class='everlive-retry-button'></button># } #")}).data("kendoTreeView");var N=O._treeView.dataItem(".k-item:first");O._buildContextMenus(N)},renderPropertyGrid:function(){var L=this;$("#everlivePropGrid").kendoGrid({dataSource:L.propertiesDS,columns:[{field:"Prop",title:"Property"},{field:"Val",title:"Value"}],scrollable:true}).data("kendoGrid")},_buildContextMenus:function(M){var S=this;var L=f.commandService.getCommandsByCategory(e.EVERLIVE_NAVIGATOR_NODE_COMMANDS);var N=a;var O=function(T){var V=T.item;var U=$(V).data("command");if(U&&U.canExecute()){var W=$(V).data("menu");W.hideContextMenu();U.execute();U.executeLogLambda(function(){G.logEvent(U.featureCategory,U.featureName)})}};S.contextMenu=f.commandMenuService.buildContextMenu(L,O,{shouldAddMenuClass:true,dataItem:M});var P=function(T){var U=this;S._treeView.select(U);S.onTreeItemSelected({node:U});R();S.contextMenu.openOn($(">div",U),T.pageX,T.pageY);T.preventDefault();T.stopPropagation()};var Q=function(T){if(S.contextMenu&&S.contextMenu.element&&$(S.contextMenu.element).is(":visible")){S.contextMenu.hideContextMenu()}else{S.contextMenu.openOn(this)}};$(N).delegate(".k-item","contextmenu",P);var R=function(){S.contextMenu.disposeContextMenu();f.commandService.unbind(e.COMMAND_REGISTERED,R);$(N).undelegate(".k-item","contextmenu",P);var T=S._treeView.dataItem(".k-item:first");S._buildContextMenus(T)};f.commandService.bind(e.COMMAND_REGISTERED,R)},onTreeItemSelected:function(L){var P=this;var Q=a.data("kendoTreeView");var M=Q.dataItem(L.node);this.selectNodes([L.node]);var O=M.NodeType;var N=null;if(O==="everlive-root"){N=[]}else{if(O==="app"){N=[{Prop:"Name",Val:M.Name},{Prop:"Title",Val:M.Title},{Prop:"Api Key",Val:M.APIKey}]}else{if(O==="content-type"){N=[{Prop:"Name",Val:M.Name},{Prop:"Title",Val:M.Title},{Prop:"Kind",Val:z[M.Kind]}]}else{if(O==="field"){N=[{Prop:"Name",Val:M.Name},{Prop:"Title",Val:M.Title},{Prop:"DataType",Val:v[M.DataType]}]}}}}if(N!==null){P.propertiesDS.data(N)}},selectNodes:function(L){this._treeView.select(L);q.raiseSelectionChanged()},selectedDomElements:function(L){return e.Property.call.apply(this,["selectedDomElements",elements])},raiseSelectionChanged:function(){this.trigger(e.EVERLIVE_NAVIGATOR_SELECTION_CHANGED)},onRegionFocusChange:function(L){var M=this;if(L.oldRegionName===e.EVERLIVE_NAVIGATOR_REGION&&M._treeView){this._treeView.select([])}},onRefreshClicked:function(){var L=this;L.destroyTree();L.onBind()},destroyTree:function(){var M=this;M.set("refreshEnabled",false);if(!M._treeView){return}M._treeView.destroy();var L=a;L.remove()},isPropertyGridVisible:function(){return this.propertyGridVisible},closePropertyGrid:function(){this.set("propertyGridVisible",!this.propertyGridVisible)},refreshEnabled:false});var u=w.Observable.extend({init:function(){var L=this;w.Observable.fn.init.apply(L,arguments)},raiseSelectionChanged:function(){this.trigger(e.EVERLIVE_NAVIGATOR_SELECTION_CHANGED)},});function C(){f.commandService.registerCommand(new y(e.COMMAND_EVERLIVE_NAVIGATE_TO_PORTAL,"Open Portal",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new E(e.COMMAND_EVERLIVE_SHOW_APPLICATION,"Show Application",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new H(e.COMMAND_EVERLIVE_VIEW_CLOUD_CODE,"Edit Cloud Code",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new h(e.COMMAND_EVERLIVE_EDIT_FIELDS,"Edit Fields",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new I(e.COMMAND_EVERLIVE_VIEW_CLOUD_CODE_LOG,"Show Log",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new K(e.COMMAND_EVERLIVE_VIEW_PERMISSIONS,"Edit Permissions",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new l(e.COMMAND_EVERLIVE_EDIT_USERS,"Edit Users",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new j(e.COMMAND_EVERLIVE_EDIT_ROLES,"Edit Roles",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new i(e.COMMAND_EVERLIVE_EDIT_FILES,"Edit Files",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new k(e.COMMAND_EVERLIVE_EDIT_SETTINGS,"Edit Settings",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new F(e.COMMAND_EVERLIVE_SHOW_ITEMS,"Show Items",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}])).registerCommand(new B(e.COMMAND_EVERLIVE_PROPERTIES,"Properties",[e.EVERLIVE_NAVIGATOR_NODE_COMMANDS],[{region:e.EVERLIVE_NAVIGATOR_REGION,keyShortcut:{modifiers:[],keys:[]}}],J))}var a=null;q=new u();var J=new s({adapter:p});var d={name:"Data Navigator",iconClass:"everlive-nav",template:r,viewModel:J};f.frameService.addItemToRegion(e.SIDEBAR_REGION,d);C();return q});