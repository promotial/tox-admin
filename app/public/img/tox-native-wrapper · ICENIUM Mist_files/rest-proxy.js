define(function(o){var j=o("kendo"),p=o("text!./../../api.json"),k=o("../logging/logging-service"),l,a=null;if(typeof p==="string"){p=JSON.parse(p)}function e(){this.isCustom=true;this.fields=[];this.boundary="----FormDataPolyfillBoundary"+Math.random()}e.prototype.append=function(u,w){var v=(typeof w==="string")?w:JSON.stringify(w);this.fields.push({name:u,value:v})};e.prototype.toString=function(){var v=this,u=[];v.fields.forEach(function(w){u.push("--");u.push(v.boundary);u.push("\r\n");u.push('Content-Disposition: form-data; name="');u.push(w.name);u.push('"\r\n\r\n');u.push(w.value);u.push("\r\n")});u.push("--");u.push(v.boundary);u.push("--\r\n");return u.join("")};var m=j.Observable.extend({events:{REQUEST_COMPLETED:"requestCompleted",REQUEST_ERROR:"requestError"},init:function(){var u=this;j.Observable.fn.init.apply(u,arguments);u._currentRunningRequest=null;u._requestsQueue=[]},hasPendingRequests:function(){return this._requestsQueue.length>0},executeRequest:function(u){var v=this;u.bind(u.events.REQUEST_COMPLETED,$.proxy(v.onRequestCompleted,v));u.bind(u.events.REQUEST_ERROR,$.proxy(v.onRequestError,v));u.open()},enqueueRequest:function(u){var v=this;v._requestsQueue.push(u);v._executeNextRequest()},_executeNextRequest:function(){var v=this;if(!v._currentRunningRequest){v._currentRunningRequest=v._requestsQueue.shift();var u=v._currentRunningRequest;if(u){v.executeRequest(u)}}},onRequestCompleted:function(){var u=this;if(u._currentRunningRequest){u._currentRunningRequest.unbind(u._currentRunningRequest.events.REQUEST_COMPLETED);u._currentRunningRequest.unbind(u._currentRunningRequest.events.REQUEST_ERROR);u.trigger(u.events.REQUEST_COMPLETED,u._currentRunningRequest);u._currentRunningRequest=null}u._executeNextRequest()},onRequestError:function(u){this.trigger(this.events.REQUEST_ERROR,u)}});var n=j.Observable.extend({events:{REQUEST_COMPLETED:"requestCompleted",REQUEST_ERROR:"requestError"},init:function(u,v,w){var x=this;j.Observable.fn.init.apply(x,arguments);$.extend(x,$.Deferred());x.handleFail();x._ajaxSettings=u;x._context=v;x._isBatched=false;x._isAsync=w},isAsync:function(){return this._isAsync},handleFail:function(){var v=this,u=v.fail;v.fail=function(w){v._susspendErrors=true;return u.apply(this,arguments)}},open:function(){var u=this;if(u._isBatched){throw new Error("The request participates in a batch and cannot be called atomary")}u._xhr=$.ajax(u._ajaxSettings).done($.proxy(u._onSuccess,u)).fail($.proxy(u._onError,u)).always($.proxy(u._onCompleted,u));if(u._context===undefined){u._context=u._xhr}return u._xhr},feed:function(u){var w=this;if(u.statusCode>=200&&u.statusCode<=308){var v={};if(u.body){v=JSON.parse(u.body)}w._onSuccess.call(w._context,v)}else{w._onError.call(w._context,u)}},_susspendErrors:false,_onSuccess:function(){this.resolveWith(this._context,arguments)},_onCompleted:function(){this.trigger(this.events.REQUEST_COMPLETED)},_onError:function(u){var y=this,v="",x=u.statusText;if(u.responseText){try{x=JSON.parse(u.responseText)}catch(w){}}if(x&&x.ExceptionMessage){v=x.ExceptionMessage}else{if(x&&x.Message){v=x.Message}else{v=x||u.reasonPhrase}}if(u.status===402){u.isHandled=true}u.serverError=v;u.webApiUrl=y._ajaxSettings.url;y.trigger(y.events.REQUEST_ERROR,{errorCode:u.status,error:u.statusText,message:u.serverError,webApiUrl:u.webApiUrl});if(!y._susspendErrors){k.logOutputMessage(["Server error: ",y._ajaxSettings.url,u.serverError].join(" : "))}y.rejectWith(this._context,arguments);return y.promise()}});var c=j.Observable.extend({init:function(u){var v=this;v.restApiUrl=u;v.batchesQueue=[]},CreateBatch:function(w){var x=this;if(w){for(var v=0;v<x.batchesQueue.length;v++){if(x.batchesQueue[v].GetName()===w){throw new Error("A batch with "+w+" already exists.")}}}if(w===undefined){w=j.guid()}var u=new b(w,x.restApiUrl);u.bind("batchDisposed",$.proxy(x.onBatchDisposed,x));x.batchesQueue.push(u);return u},onBatchDisposed:function(w){var x=this,u=w.GetName();for(var v=0;v<x.batchesQueue.length;v++){if(x.batchesQueue[v].GetName()===u){x.batchesQueue.splice(v,1);return}}},GetCurrentBatch:function(){var u=this;if(u.batchesQueue.length===0){return null}return u.batchesQueue[u.batchesQueue.length-1]},CanBeginNewBatch:function(u){var x=this;if(u===undefined){throw new Error("you should provide a batch instance")}if(x.batchesQueue.length===0){return true}var v=u.GetName();for(var w=0;w<x.batchesQueue.length;w++){if(x.batchesQueue[w].GetName()===v){if(w>=1){return x.batchesQueue[w-1].IsSent()}}}return true}});var b=j.Observable.extend({init:function(u,v){var w=this;w.restApiUrl=v;w.isBatching=false;w.isSent=false;w.isSequential=false;w.requestQueue={};w.name=u;j.Observable.fn.init.apply(this,arguments)},GetName:function(){return this.name},IsBatching:function(){return this.isBatching},IsSent:function(){return this.isSent},Begin:function(){var u=this;if(u.isBatching){throw new Error("Batching already started")}if(!a.batchingManager.CanBeginNewBatch(u)){throw new Error("There is an active batch which is not sent yet.")}this.isBatching=true},SendSequential:function(){var u=this;u.isSequential=true;return u.Send()},SendParalel:function(){var u=this;u.isSequential=false;return u.Send()},Send:function(){var A=this,z=[];if(!A.isBatching){throw new Error("Batch.Begin should be called first prior to calling SendBatch")}if(A.isSent){throw new Error("Batch with name "+A.name+" is already sent to server and cannot enqueue additional request")}if(A.requestQueue===undefined){A.isBatching=false;A.isSent=false;return}var w=[];for(var x in A.requestQueue){var y=A.requestQueue[x];w.push({id:x,method:y._ajaxSettings.type,url:y._ajaxSettings.url,body:y._ajaxSettings.data,headers:y._ajaxSettings.headers});if(y._context===undefined){y._context=y}z.push(y)}if(w.length===0){A.isBatching=false;A.isSent=false;A.dispose();return}var u={type:"POST",url:[A.restApiUrl,"batch"].join("/"),data:JSON.stringify(w),contentType:"application/json",processData:false,xhrFields:{withCredentials:true}};if(A.isSequential){u.headers={"X-Sequential-Batch":true}}var v=new n(u,A);v.done(function(F){try{var E=JSON.parse(F);for(var B=0;B<E.length;B++){var D=E[B];var C=A.requestQueue[D.requestId];if(C===undefined){continue}C.feed.call(C._context,D);if((D.statusCode<200||D.statusCode>308)&&A.isSequential){break}}}finally{A.isBatching=false;A.isSent=false;A.dispose()}}).fail(function(B){A.isSent=false;A.isBatching=false;A.dispose()});z.push(v);l.enqueueRequest(v);A.isSent=true;return $.when.apply($,z)},EnqueueRequest:function(u){this.requestQueue[j.guid()]=u},dispose:function(){var v=this;if(v.isBatching){return}for(var u in v.requestQueue){delete v.requestQueue[u]}v.requestQueue={};v.trigger("batchDisposed",this)}});function d(u){return u.substring(0,1).toLowerCase()+u.substring(1)}function h(x,v){var y=v||"https",w=y+"://"+x,u=w+"/api";return i(u)}function i(A,u){if(a!==null){return a}a=u||{};a.batchingManager=new c(A);for(var v=0;v<p.length;v++){var C=p[v],D=d(C.name.replace(/I(\w*)Contract/,"$1")),B=a[D]||{};a[D]=B;if(C.endpoint.indexOf("/")===0){C.endpoint=C.endpoint.substring(1)}for(var w=0;w<C.operations.length;w++){var y=C.operations[w],x=d(y.name),z=x+"Async";B[x]=r(C,y,A);B[x].url=g(C,y,A);B[x].httpMethod=s(y,A);B[x].IsAsync=false;if(y.httpMethod==="GET"||y.httpMethod==="POST"){B[z]=r(C,y,A);B[z].url=g(C,y,A);B[z].httpMethod=s(y,A);B[z].IsAsync=true}}}return a}function g(w,u,v){return function(){return f(w,u,v,arguments)}}function f(I,A,F,u){var v=u[0]||{},L=[F,I.endpoint].join("/"),G=[],E=[];if(A.routePrefixes&&A.routePrefixes.length>0){for(var C=0;C<A.routePrefixes.length;C++){var D=A.routePrefixes[C];if(D){L=[L,D].join("/")}}}if(A.actionName!==""){G.push(A.actionName)}for(var w=0,z=A.parameters.length;w<z;w++){var B=A.parameters[w],M=(v&&v[B.name]);switch(B.binding.type){case"Route":if(M===undefined||M===null){continue}if(B.routePrefixes&&B.routePrefixes.length&&B.routePrefixes.length>0){for(var x=0;x<B.routePrefixes.length;x++){G.push(B.routePrefixes[x])}}G.push(encodeURI(M.replace(/\\/g,"/")));if(B.routeSuffixes&&B.routeSuffixes.length&&B.routeSuffixes.length>0){for(var y=0;y<B.routeSuffixes.length;y++){G.push(B.routeSuffixes[y])}}break;case"Query":E.push(B.name+"="+encodeURIComponent(M));break;default:}}if(G.length>0){G.unshift("");var H=G.join("/");L=L+H.replace(/\/\//g,"/")}if(A.routeSuffixes&&A.routeSuffixes.length>0){for(var J=0;J<A.routeSuffixes.length;J++){var K=A.routeSuffixes[J];if(K){L=[L,K].join("/")}}}if(E.length>0){L=[L,E.join("&")].join("?")}return L}function s(u,v){return function(){return u.httpMethod}}function r(w,u,v){return function(){var y=t(w,u,v,arguments);var x=a.batchingManager.GetCurrentBatch();if(x&&x.IsBatching()&&!x.IsSent()){x.EnqueueRequest(y);return y}return q(y)}}function t(L,G,K,u){var y=u[0]||{},x=u[1],M=f(L,G,K,u),w=[],J,B=G.httpMethod.toUpperCase(),A={Accept:"application/json; charset=utf-8"},v=a.batchingManager.GetCurrentBatch();if(!v||(v&&!v.IsBatching())){if(B!=="POST"&&B!=="PUT"&&B!=="GET"&&B!=="DELETE"){A["X-HTTP-Method-Override"]=B;B="POST"}}if(G.responseType){A.Accept=G.responseType}for(var C=0,F=G.parameters.length;C<F;C++){var H=G.parameters[C];if(H.binding.type==="Body"){H.paramIndex=C;w.push(H)}}if(w.length===1){if(w[0].binding.contentType==="application/json"){J=JSON.stringify(y[w[0].name])}else{J=y[w[0].name]}A["Content-Type"]=w[0].binding.contentType}else{if(w.length>1){var z=new e();for(var D=0,E=w.length;D<E;D++){if(w[0].binding.contentType==="application/json"){z.append(w[D].name,JSON.stringify(y[w[D].name]))}else{z.append(w[D].name,y[w[D].name])}}A["Content-Type"]="multipart/form-data; boundary="+z.boundary;J=z.toString()}}if(J===undefined){J=""}var I=new n({type:B,url:M,data:J,contentType:false,processData:false,xhrFields:{withCredentials:true},headers:A},x,u.callee.IsAsync);return I}function q(u){if(u.isAsync()){l.executeRequest(u)}else{l.enqueueRequest(u)}return u}l=new m();return{init:h,initByUrl:i,proxy:a,requestService:l}});