(function(global,doc){var queue=[],supportsAsyncFalse=doc.createElement("script").async==true,readyStates={loaded:1,interactive:1,complete:1},orsc="onreadystatechange",head=doc.head||doc.getElementsByTagName("head")[0],waitForOrderedScript;function loadScript(def,success,failure){var deadline,el;deadline=new Date().valueOf()+(def.timeout||300)*1000;el=doc.createElement("script");function process(ev){ev=ev||global.event;if(ev.type=="load"||readyStates[el.readyState]){el.onload=el[orsc]=el.onerror="";if(!def.test||testGlobalVar(def.test)){success(el)}else{fail()}}}function fail(e){el.onload=el[orsc]=el.onerror="";if(failure){failure(new Error("Script error or http error: "+def.url))}}function poller(){if(el.onload&&readyStates[el.readyState]){process({})}else{if(el.onload&&deadline<new Date()){fail()}else{setTimeout(poller,10)}}}if(failure&&def.test){setTimeout(poller,10)}el.type=def.mimetype||"text/javascript";el.onload=el[orsc]=process;el.onerror=fail;el.charset=def.charset||"utf-8";el.async=def.async;el.src=def.url;head.insertBefore(el,head.firstChild)}function fetch(def,promise){loadScript(def,function(el){var next=queue.shift();waitForOrderedScript=queue.length>0;if(next){fetch.apply(null,next)}promise.resolve(el)},function(ex){promise.reject(ex)})}function testGlobalVar(varName){try{eval("global."+varName);return true}catch(ex){return false}}define({load:function(name,require,callback,config){var order,testPos,test,prefetch,def,promise;order=name.indexOf("!order")>0;testPos=name.indexOf("!test=");test=testPos>0&&name.substr(testPos+6);prefetch="prefetch" in config?config.prefetch:true;name=order||testPos>0?name.substr(0,name.indexOf("!")):name;def={name:name,url:require.toUrl(name),async:!order,order:order,test:test,timeout:config.timeout};promise=callback.resolve?callback:{resolve:function(o){callback(o)},reject:function(ex){throw ex}};if(order&&!supportsAsyncFalse&&waitForOrderedScript){queue.push([def,promise]);if(prefetch){def.mimetype="text/cache";loadScript(def,function(el){el.parentNode.removeChild(el)},false);def.mimetype=""}}else{waitForOrderedScript=waitForOrderedScript||order;fetch(def,promise)}}})}(this,document));