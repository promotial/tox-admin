define(function(j,f,h){var g=j("kendo"),c=j("modules/core/core-module"),d=j("modules/core/dialog-service"),e=j("modules/core/dialog-viewmodels"),b=j("modules/code-editor/code-editor-module"),u=j("modules/view-pane/view-pane-service"),t=j("modules/version-control/version-control-service"),n=t.consts,k=j("modules/core/rest-proxy"),l=k.init(window.location.host,serviceConfiguration.backendServiceScheme),i=j("modules/project-navigator/project-navigator-module"),m=i.solutionService,o=j("text!./version-control-diff-dialog-template.html"),r=j("text!./version-control-diff-template.html");var a={MESSAGE_DIFF_TOOL_TITLE:"Diff Tool",PLACEHOLEDR_DIFF_TAB:"#diff-tab",PLACEHOLEDR_DIFF_BOX:".diff-box",PLACEHOLEDR_DIFF_BOX_HEADER:".panel-box-header",PLACEHOLEDR_DIFF_BOX_FOOTER:".panel-box-footer",PLACEHOLEDR_DIFF_MERGE_TOOL:".CodeMirror-merge, .CodeMirror-merge-2pane, .CodeMirror, .CodeMirror-gutters",PLACEHOLEDR_DIFF_TOOL_CODE_MIRROR:".CodeMirror",PLACEHOLDER_VERSION_HEADER_COMPONENT:"span",DIFF_TOOL_SOURCES_MIN:2,DIFF_TOOL_SOURCES_MAX:2};var s=e.MessageBoxViewModel.extend({_mergeView:null,_initialContent:"",_filePath:null,leftSideVersionHeader:{},rightSideVersionHeader:{},isModified:false,init:function(v){var w=this;e.MessageBoxViewModel.fn.init.apply(w,arguments)},initDiff:function(w){var z=this,x=w.leftSideVersionHeader,y=w.rightSideVersionHeader,v=$(a.PLACEHOLEDR_DIFF_BOX,$(a.PLACEHOLEDR_DIFF_TAB));z._initialContent=w.rightSideContent;z._filePath=w.filePath;z.set("leftSideVersionHeader",x);z.set("rightSideVersionHeader",y);z._mergeView=CodeMirror.MergeView(v[0],{value:w.rightSideContent||"",origLeft:w.leftSideContent||"",orig:null,mode:w.language.mode||"",readOnly:w.readOnly||false,lineNumbers:true});if(w.readOnly){v.addClass("read-only")}z._mergeView.edit.on("change",function(){z.set("isModified",true)})},onReset:function(){var v=this;v.reset()},reset:function(){var v=this;v._mergeView.edit.setValue(v._initialContent);v.set("isModified",false)},onSave:function(){var v=this;v.save()},save:function(){var w=this,v="\\"+m.solution().text+"\\"+w._filePath;l.fileSystemService.save({path:v,content:w._mergeView.edit.getValue(),validatorTypeName:""}).done(function(){w.set("isModified",false);w._initialContent=w._mergeView.edit.getValue();u.reloadFileslWithConfirmation({filePathsList:[v]})}).fail(function(x){})},resize:function(){var A=this,w=$(a.PLACEHOLEDR_DIFF_TAB),y=$(a.PLACEHOLEDR_DIFF_BOX_HEADER,w).outerHeight(true),z=$(a.PLACEHOLEDR_DIFF_BOX_FOOTER,w).outerHeight(true),v=$(a.PLACEHOLEDR_DIFF_MERGE_TOOL,w),x=$(a.PLACEHOLEDR_DIFF_TOOL_CODE_MIRROR,w);v.outerHeight(w.height()-y-z);x.outerHeight(v.height());A._mergeView.left.forceUpdate()}});var p=e.MessageBoxViewModel.extend({tabList:[],init:function(w){var x=this,v=w.substring(w.indexOf("\\")+1,w.length);x.tabList=[v];x.selectedTab=v;e.MessageBoxViewModel.fn.init.apply(x,arguments)}});var q=g.Observable.extend({init:function(){var v=this;g.Observable.fn.init.apply(v,arguments)},showDiff:function(v){var F=this,A,B,D,C,y=v.filePath,z=v.leftSideVersionName||n.VERSION_NAME_LATEST,E=v.rightSideVersionName||n.VERSION_NAME_WORKSPACE,w=l.batchingManager.CreateBatch(),x=new p(y);c.progressService.showProgress();w.Begin();D=t.GetCommitDetails(z);C=t.GetCommitDetails(E);A=t.GetContents({versionName:z,filePath:y});B=t.GetContents({versionName:E,filePath:y});$.when(A,B,D,C).done(function(H,J,I,K){var G=b.getLanguage(y);b.loadLanguage(G,function(){var L=new s();x.bind("bind",function(M){c.viewRenderer.render(r,L,$(a.PLACEHOLEDR_DIFF_TAB));L.initDiff({readOnly:v.readOnly,filePath:v.filePath,leftSideContent:H,rightSideContent:J,leftSideVersionHeader:F._getVersionHeader(z,I),rightSideVersionHeader:F._getVersionHeader(E,K),language:G});L.resize()});d.showModalDialog(a.MESSAGE_DIFF_TOOL_TITLE,{template:o,viewModel:x,actions:["Maximize","Close"],width:930,height:530,minWidth:630,minHeight:360,resizable:true,resize:function(){L.resize()}})})}).fail(function(G){if(!G.isHandled){d.showMessageBox(a.MESSAGE_ICENIUM,G.statusText)}}).always(function(){c.progressService.hideProgress()});x.getPromise().always(function(){t.Track()});w.SendSequential()},_getVersionHeader:function(y,w){var v,x=[];if(w!==null&&w!==undefined&&w.VersionName!==undefined&&w.CommitTime!==undefined){v=new Date(w.CommitTime);x={leftSide:g.format("{0}, {1}",w.CommitterName,g.toString(v,"dd/MM/yyyy hh:mm:ss tt")),rightSide:g.format("SHA: {0} ",w.VersionName.substring(0,n.SHA_DISPLAY_LENGTH))}}else{x={leftSide:y}}return x}});h.exports={consts:a,versionControlDiffService:new q()}});