define(function(x){var h=x("modules/core/core-module"),n=x("modules/core/helpers"),c=x("modules/core/base-commands"),p=x("modules/logging/logging-service"),j=x("modules/core/dialog-viewmodels"),i=x("modules/core/dialog-service"),q=x("modules/project-navigator/project-navigator-module"),C=q.solutionController,r=q.projectNavigatorService,y=x("modules/core/rest-proxy"),A=y.init(window.location.host,serviceConfiguration.backendServiceScheme),m=x("modules/core/duplex-proxy"),l=m.init(window.location.host,serviceConfiguration.backendServiceScheme),w=x("modules/version-control/remote-providers-controller"),O=x("modules/version-control/version-control-service"),H=x("modules/version-control/version-control-commit-module"),M=x("modules/version-control/version-control-history-module"),I=x("modules/version-control/version-control-conflicts-module"),L=x("modules/version-control/version-control-diff-dialog-module"),J=x("text!./version-control-dialog-template.html");x("css!./version-control-dialog-styles.css");x("js!noamd/jquery.signalR.js");x("kendo");var g=window,b={},a={MESSAGE_PULL_WITH_CREDENTIALS:"Pulling with credentials...",MESSAGE_PUSH_WITH_CREDENTIALS:"Pushing with credentials...",MESSAGE_PULL_ERROR:"Pull Error.",MESSAGE_PUSH_ERROR:"Push Error",MESSAGE_PULLING:"Pulling...",MESSAGE_PUSHING:"Pushing...",MESSAGE_PULL:"Pull.",MESSAGE_PUSH:"Push",MESSAGE_PULL_COMPLETED_SUCCESSFULLY:"Pull has completed successfully!",MESSAGE_PUSH_COMPLETED_SUCCESSFULLY:"Push has completed successfully!",MESSAGE_PULL_HAS_CONFLICTS:"Pull has conflicts",MESSAGE_CREDENTIALS_TITLE:"Git Authentication"};b.credentials={};var F={Changes:"Changes",History:"History",Conflicts:"Conflicts"};var D=[F.Changes,F.History,F.Conflicts];var E={};E[F.Changes]="changesTab";E[F.History]="historyTab";E[F.Conflicts]="conflictsTab";var G={CompleteWithSuccess:0,CompleteWithWarning:1,VersionControlError:2,InvalidRemoteError:3,PushConflictsError:4,PullConflictsError:5,InvalidCredentials:6};var N=c.CommandBase.extend({init:function(){var P=this;c.CommandBase.fn.init.apply(P,arguments)},execute:function(){},getType:function(){return g.COMMAND_VERSION_CONTROL_ROOT}});var e=c.CommandBase.extend({init:function(){var P=this;c.CommandBase.fn.init.apply(P,arguments);P.featureCategory=g.TrackingTags.featureCategory.VersionControl.name;P.featureName=g.TrackingTags.featureCategory.VersionControl.features.ConfigureRemoteRepository},execute:function(){var P=this;A.versionControlService.getRemote({workspaceName:iceConfiguration.solutionName}).done($.proxy(P._showConfigRemoteRepoDialog,P))},_showConfigRemoteRepoDialog:function(P){w.showConfigRemoteRepoDialog(P)},getType:function(){return g.COMMAND_VERSION_CONTROL_CONFIG_REMOTE_REPO}});var v=c.CommandBase.extend({_messageProgressWithCredentials:"",_messageActionError:"",init:function(){var P=this;c.CommandBase.fn.init.apply(P,arguments)},execute:function(){var Q=this,P=Q.scope;O.ensureCleanStateBeforePullPush().done(function(R){if(R!==undefined){B.call(Q.scope,R);return}A.versionControlService.getRemote({workspaceName:iceConfiguration.solutionName}).done($.proxy(Q.onRemoteRepoUrlReceived,Q))})},onRemoteRepoUrlReceived:function(P){var Q=this;if(P===undefined||P===null||P===""){Q.askForRemoteRepoUrl()}else{Q.performAction()}},askForRemoteRepoUrl:function(){var P=this;w.showConfigRemoteRepoDialog().done(function(){P.performAction()})},performAction:function(){},populateCredentials:function(P){var T=this,Q,R=new $.Deferred();function S(W,U){for(var V in P.credentials){if(P.credentials.hasOwnProperty(V)){if(P.credentials[V].Type===g.CredentialType.Password){P.credentials[V].Value=U}else{if(P.credentials[V].Type===g.CredentialType.Username){P.credentials[V].Value=W}}}}h.progressService.showProgress(T._messageProgressWithCredentials);R.resolve(P.credentials)}h.progressService.hideProgress();if(T.hasCredentials()){Q=T.getCredentials();S(Q.username,Q.password)}else{i.showCredentialsDialog({caption:a.MESSAGE_CREDENTIALS_TITLE,optionVisible:true}).done(function(W,U,V){if(V){T.storeCredentials(W,U)}S(W,U)}).fail(function(){R.reject()})}return R.promise()},onActionError:function(P){var Q=this;h.progressService.hideProgress();if(P){if(P.StatusCode===G.InvalidCredentials){Q.clearCredentials()}i.showMessageBox(Q._messageActionError,P,Q.askForCredentials)}},storeCredentials:function(R,Q){var P=btoa([R,Q].join(":"));sessionStorage.setItem("Iceniumbt",P)},hasCredentials:function(){var P=sessionStorage.getItem("Iceniumbt");if(P!==null&&P!==""){return true}return false},getCredentials:function(){var Q,P=sessionStorage.getItem("Iceniumbt");if(P!==null&&P!==""){Q=atob(P).split(":");username=Q.shift();password=Q.join("")}return{username:username,password:password}},clearCredentials:function(){sessionStorage.removeItem("Iceniumbt")}});var s=v.extend({init:function(){var P=this;v.fn.init.apply(P,arguments);P.featureCategory=g.TrackingTags.featureCategory.VersionControl.name;P.featureName=g.TrackingTags.featureCategory.VersionControl.features.Pull;P._messageProgressWithCredentials=a.MESSAGE_PULL_WITH_CREDENTIALS;P._messageActionError=a.MESSAGE_PULL_ERROR},performAction:function(){var Q=this,P=h.progressService;P.showProgress(a.MESSAGE_PULLING);l.versionControlService.pull.start({workspaceName:iceConfiguration.solutionName}).done(function(){l.versionControlService.pull.client.populateCredentials($.proxy(Q.populateCredentials,Q)).beginSubtask($.proxy(P.beginSubtask,P)).updateProgress($.proxy(P.updateProgress,P)).endSubtask($.proxy(P.endSubtask,P));l.versionControlService.pull.server.pull({}).done($.proxy(Q.onActionSucess,Q)).fail($.proxy(Q.onActionError,Q)).always(function(){l.versionControlService.pull.stop()})}).fail($.proxy(Q.onActionError,Q))},onActionSucess:function(Q){var R=this,P;h.progressService.hideProgress();if(Q.StatusCode===G.CompleteWithSuccess){C.reloadSolution();p.logOutputMessage(a.MESSAGE_PULL_COMPLETED_SUCCESSFULLY)}else{if(Q.StatusCode===G.PullConflictsError){C.reloadSolution();i.showMessageBox(a.MESSAGE_PULL,a.MESSAGE_PULL_HAS_CONFLICTS)}else{P=Q.MessageText;if(Q.StatusCode===G.InvalidCredentials){R.clearCredentials()}i.showMessageBox(a.MESSAGE_PULL,P)}}},getType:function(){return g.COMMAND_VERSION_CONTROL_PULL}});var t=v.extend({init:function(){var P=this;v.fn.init.apply(P,arguments);P.featureCategory=g.TrackingTags.featureCategory.VersionControl.name;P.featureName=g.TrackingTags.featureCategory.VersionControl.features.Push;P._messageProgressWithCredentials=a.MESSAGE_PUSH_WITH_CREDENTIALS;P._messageActionError=a.MESSAGE_PUSH_ERROR},performAction:function(){var Q=this,P=h.progressService;P.showProgress(a.MESSAGE_PUSHING);l.versionControlService.push.start({workspaceName:iceConfiguration.solutionName}).done(function(){l.versionControlService.push.client.populateCredentials($.proxy(Q.populateCredentials,Q)).beginSubtask($.proxy(P.beginSubtask,P)).updateProgress($.proxy(P.updateProgress,P)).endSubtask($.proxy(P.endSubtask,P));l.versionControlService.push.server.push({}).done($.proxy(Q.onActionSucess,Q)).fail($.proxy(Q.onActionError,Q)).always(function(){l.versionControlService.push.stop()})}).fail($.proxy(Q.onActionError,Q))},onActionSucess:function(Q){var R=this,P;h.progressService.hideProgress();if(Q.StatusCode!==0){P=Q.MessageText;if(Q.StatusCode===G.InvalidCredentials){R.clearCredentials()}i.showMessageBox(a.MESSAGE_PUSH,P,R.askForCredentials)}else{p.logOutputMessage(a.MESSAGE_PUSH_COMPLETED_SUCCESSFULLY)}},getType:function(){return g.COMMAND_VERSION_CONTROL_PUSH}});var k=c.CommandBase.extend({init:function(){var P=this;c.CommandBase.fn.init.apply(P,arguments);P.featureCategory=g.TrackingTags.featureCategory.VersionControl.name;P.featureName=g.TrackingTags.featureCategory.VersionControl.features.Diff},canExecute:function(){var P,Q=r.getSelectedItems();if(Q.length<1){return false}P=Q[0];if(P.isSolution||P.isProject||P.isFolder||P.isSpecialFolder){return false}return O.HasPendingChangesForSelection()},execute:function(){var R=this,P,Q=r.getSelectedItems();if(Q.length<1){return}P=Q[0];L.versionControlDiffService.showDiff({filePath:P.getFullPath()})},getType:function(){return g.COMMAND_VERSION_CONTROL_DIFF}});var d=c.CommandBase.extend({init:function(){var P=this;g=window;c.CommandBase.fn.init.apply(P,arguments);P.featureCategory=g.TrackingTags.featureCategory.VersionControl.name;P.featureName=g.TrackingTags.featureCategory.VersionControl.features.CommitChanges},canExecute:function(){var P=O.GetRepositoryState();return P.CanCommit&&(P.IsMerging||O.HasPendingChanges())},execute:function(){var P=this;B.call(P.scope,0)},getType:function(){return g.COMMAND_VERSION_CONTROL_COMMIT}});var z=c.CommandBase.extend({init:function(){var P=this;g=window;c.CommandBase.fn.init.apply(P,arguments);P.featureCategory=g.TrackingTags.featureCategory.VersionControl.name;P.featureName=g.TrackingTags.featureCategory.VersionControl.features.RevertChanges},canExecute:function(){return O.HasPendingChangesForSelection()},execute:function(){var P=O.GetPendingChangesForSelection(),Q=n.filterPendingChangesBySelection(P);i.showFileListConfirmationDialog("Version Control Revert",{message:"Are you sure you want to revert these items?",fileList:Q,accept:function(){O.RevertFiles(Q).done(function(){O.Track()})}})},getType:function(){return g.COMMAND_VERSION_CONTROL_REVERT}});var o=c.CommandBase.extend({init:function(){var P=this;c.CommandBase.fn.init.apply(P,arguments);P.featureCategory=g.TrackingTags.featureCategory.VersionControl.name;P.featureName=g.TrackingTags.featureCategory.VersionControl.features.ReviewHistory},canExecute:function(){return true},execute:function(){var P=this;B(1)},getType:function(){return g.COMMAND_VERSION_CONTROL_HISTORY}});var f=c.CommandBase.extend({init:function(){var P=this;g=window;c.CommandBase.fn.init.apply(P,arguments);P.featureCategory=g.TrackingTags.featureCategory.VersionControl.name;P.featureName=g.TrackingTags.featureCategory.VersionControl.features.ReviewConflicts},canExecute:function(){return O.HasConflictingFiles()},execute:function(){var P=this;B.call(P.scope,2)},getType:function(){return g.COMMAND_VERSION_CONTROL_CONFLICTS}});var K=j.MessageBoxViewModel.extend({init:function(S,P,R,Q){var T=this;T._tabIndex=S;if(T._tabIndex>D.length-1||D<0){throw new Error("VersionControlDialog: tabIndex is out of bounds")}T.selectedTab=D[T._tabIndex];T.tabList=[F.Changes,F.History,F.Conflicts];T._tabName2ViewModel={};T._tabName2ViewModel[F.Changes]=P;T._tabName2ViewModel[F.History]=R;T._tabName2ViewModel[F.Conflicts]=Q;T._splitterInitialized={};T._splitterInitialized[F.Changes]=false;T._splitterInitialized[F.History]=false;T._splitterInitialized[F.Conflicts]=false;j.MessageBoxViewModel.fn.init.apply(T,arguments)},onTabChanged:function(){var P=this;P.ensureSplitter();P._tabName2ViewModel[P.selectedTab].prepare();P.resize()},resize:function(){var Z=this;var W=Z.selectedTab;if(W===undefined){return}var X=E[W];var Y=$("#"+X);if(Y.children().length>0){Y.data("kendoSplitter").trigger("resize")}var aa=Z.dialog().element;var V=$(".k-tabstrip > .k-content > .k-splitter > .k-pane:visible",aa);for(var T=0;T<V.length;T++){var U=V[T];var S=$(".panel-box-header",U).height();var P=$(".panel-box-footer",U).height();var R=$(U).height()-(S+P+55);var Q=$(".panel-box-content > .k-grid-content",U);Q.height(R)}},ensureSplitter:function(){var S=this;var P=S._splitterInitialized[S.selectedTab]===true;if(P){return}var Q=E[S.selectedTab];var R=$("#"+Q);if(R.children().length===0){return}R.kendoSplitter({orientation:"horizontal",panes:[{collapsible:true,resizable:true,size:"50%",min:"270px",scrollable:false},{collapsible:true,resizable:true,size:"50%",min:"320px",scrollable:false}]});S._splitterInitialized[S.selectedTab]=true}});function B(W){var X=this,P=H.getTemplate(),Q=H.getViewModel(),U=M.getTemplate(),V=M.getViewModel(),R=I.getTemplate(),S=I.getViewModel(),Y=new K(W,Q,V,S),T=i.showModalDialog("Version Control",{template:J,viewModel:Y,viewInitialized:function(aa){var Z=this,ab=h.viewRenderer;ab.render(P,Q,$("#changesTab"));ab.render(U,V,$("#historyTab"));ab.render(R,S,$("#conflictsTab"));Z.viewModel.ensureSplitter.call(Z.viewModel);Z.viewModel.resize()},resizable:true,actions:["Maximize","Close"],width:930,height:530,minWidth:630,minHeight:360,resize:function(){Y.resize()}});Y.getPromise().always(function(){O.Track()});Q.dialog(T);V.dialog(T);S.dialog(T)}function u(){var P=this;var Q=new N(g.COMMAND_VERSION_CONTROL_ROOT,"Version Control",[g.SOLUTION_MENU_COMMANDS,g.PROJECT_NAVIGATOR_NODE_COMMANDS]);Q.addCommand(new k(g.COMMAND_VERSION_CONTROL_DIFF,"Compare with Latest Version",[],[],this)).addCommand(new d(g.COMMAND_VERSION_CONTROL_COMMIT,"Commit",[],[],this)).addCommand(new z(g.COMMAND_VERSION_CONTROL_REVERT,"Revert",[],[])).addCommand(new o(g.COMMAND_VERSION_CONTROL_HISTORY,"History",[],[],this)).addCommand(new f(g.COMMAND_VERSION_CONTROL_CONFLICTS,"Conflicts",[],[],this)).addCommand(new t(g.COMMAND_VERSION_CONTROL_PUSH,"Push",[],[],this)).addCommand(new s(g.COMMAND_VERSION_CONTROL_PULL,"Pull",[],[],this)).addCommand(new e(g.COMMAND_VERSION_CONTROL_CONFIG_REMOTE_REPO,"Configure Remote Repository",[],[],this));h.commandService.registerCommand(Q)}u();O.Track()});