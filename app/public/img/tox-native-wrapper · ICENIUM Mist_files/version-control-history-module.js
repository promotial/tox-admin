define(function(g){var d=g("modules/core/dialog-viewmodels"),c=g("modules/core/dialog-service"),b=g("modules/core/core-module"),f=g("modules/project-navigator/project-navigator-module"),i=f.solutionController,p=g("modules/version-control/version-control-service"),j=g("modules/version-control/version-control-file-history-dialog-module"),n=g("text!./version-control-history-template.html"),o=g("text!./version-control-reset-dialog-template.html"),k=g("text!./version-control-history-grid-templates.html");g("css!./version-control-history-styles.css");var a=window;var h=d.ConfirmationDialogViewModel.extend({resetMode:"hard",init:function(){var q=this;d.ConfirmationDialogViewModel.fn.init.apply(q,[{rejectText:"Cancel"},{acceptText:"Ok"}])},getResetMode:function(){return this.get("resetMode")}});var e=d.MessageBoxViewModel.extend({init:function(q){var r=this;r.versionControlFileHistoryModule=q.versionControlFileHistoryModule;d.MessageBoxViewModel.fn.init.apply(r,arguments);r.changeSets=[];r.changeSetsDS=new kendo.data.DataSource();r.bind("bind",$.proxy(r.onBind,r))},prepare:function(){var q=this;p.GetChangesets().done($.proxy(q.onChangeSetsReceived,q))},onChangeSetsReceived:function(q){var r=this;r.set("changeSets",q);r.changeSetsDS.data(q)},onBind:function(){var u=this,q=$(k),r=$("#commit-history-details",q).html(),t=$("#commit-history-time",q).html(),s=$("#commit-history-changed-files-details",q).html();u._generateSummary();u.changeSetsDetailsDS=new kendo.data.DataSource({data:[],model:{fields:{FilePath:{type:"string"},ChangeType:{type:"string"}}}});u.changeSetsGrid=$("#changeSetsGrid").kendoGrid({dataSource:u.changeSetsDS,columns:[{title:"Commit",width:"275px",template:r},{title:"Time",width:"75px",template:t}],dataBound:function(v){var w=this;w.select(w.tbody.find(">tr:first"))},change:function(w){var x=this;var y=x.tbody.find(">tr.k-state-selected");var v=x.dataItem(y);u._showChangeSetDetails.call(u,v.VersionName)},selectable:"row",scrollable:true,navigatable:true}).data("kendoGrid");u.changeSetsDetailsGrid=$("#changedFilesGrid").kendoGrid({dataSource:u.changeSetsDetailsDS,columns:[{title:"Name",field:"filePath",width:"325px"},{title:"Status",field:"changeType",width:"50px",template:s}],dataBound:function(v){var w=this;w.select(w.tbody.find(">tr:first"))},change:function(w){var x=this;var y=x.tbody.find(">tr.k-state-selected");var v=x.dataItem(y);u._showChangeSetDetails.call(u,v.VersionName)},selectable:"row",scrollable:true,navigatable:true}).data("kendoGrid")},numberOfCommits:function(){var s=this,q=s.get("changeSets"),r=q===undefined?0:q.length;return[r,"commits"].join(" ")},_showChangeSetDetails:function(r){var q=this;if(r===undefined){return}p.GetChangesetItems({changesetId:r}).done($.proxy(q._onChangeSetDetailsReceived,q))},_onChangeSetDetailsReceived:function(r){var t=this;if(r===undefined||r.length===0){return}var q=[];for(var s=0;s<r.length;s++){q.push({filePath:r[s].FilePath,changeType:r[s].ChangeType})}t.changeSetsDetailsDS.data(q);t._generateSummary()},_generateSummary:function(){var w=this,q=0,u=0,v=0,s=0,x=p;var r=[];if(w.changeSetsDetailsDS!==undefined){r=w.changeSetsDetailsDS.data()}for(var t=0;t<r.length;t++){switch(r[t].changeType){case x.ChangeType.Added:q++;break;case x.ChangeType.Modified:u++;break;case x.ChangeType.Renamed:v++;break;case x.ChangeType.Deleted:s++;break;default:}}w.set("pendingSummary",[[q,"added"].join(" "),[u,"modified"].join(" "),[v,"renamed"].join(" "),[s,"deleted"].join(" ")].join(", "))},onRollbackClicked:function(){var r=this;var q=r.changeSetsGrid.tbody.find(">tr.k-state-selected");if(q.length===0){return}var s=r.changeSetsGrid.dataItem(q).VersionName;c.showConfirmationDialog("Confirm Rollback?",{template:["Are you sure you want to rollback to this version.","This operation will undo all local pending changes."].join("<br/>"),accept:function(){p.Rollback(s);r.closeDialog()}})}.attribute("track",{featureCategory:a.TrackingTags.featureCategory.VersionControl.name,featureName:a.TrackingTags.featureCategory.VersionControl.features.Rollback}),onResetClicked:function(){var r=this;var q=r.changeSetsGrid.tbody.find(">tr.k-state-selected");if(q.length===0){return}var s=r.changeSetsGrid.dataItem(q).VersionName;var t=new h();c.showConfirmationDialog("Reset Changes",{template:o,viewModel:t}).done(function(){var u=t.getResetMode();u=u==="hard"?0:1;p.Reset(s,u).done(function(){i.reloadSolution();r.prepare()})})}.attribute("track",{featureCategory:a.TrackingTags.featureCategory.VersionControl.name,featureName:a.TrackingTags.featureCategory.VersionControl.features.ResetChanges}),onHistoryClicked:function(){var s=this;var r=s.changeSetsDetailsGrid.tbody.find(">tr.k-state-selected");if(r.length===0){return}var q=s.changeSetsDetailsGrid.dataItem(r).filePath;r=s.changeSetsGrid.tbody.find(">tr.k-state-selected");if(r.length===0){return}var t=s.changeSetsGrid.dataItem(r).VersionName;p.GetFileHistory({solutionName:iceConfiguration.solutionName,versionName:t,path:q}).done($.proxy(s._onFileHistoryReceived,s))}.attribute("track",{featureCategory:a.TrackingTags.featureCategory.VersionControl.name,featureName:a.TrackingTags.featureCategory.VersionControl.features.ReviewHistory}),_onFileHistoryReceived:function(r,q){var s=this;var t=s.versionControlFileHistoryModule.getTemplate();var u=s.versionControlFileHistoryModule.getViewModel({fileName:r,fileHistory:q});c.showModalDialog("History",{template:t,viewModel:u,viewInitialized:function(v){b.viewRenderer.render(t,u,$("#fileHistoryDialogContent"))},width:"600px",height:"380px"})}});function m(){this.versionControlFileHistoryModule=j}m.prototype={init:function(){},getTemplate:function(){return n},getViewModel:function(){return new e({versionControlFileHistoryModule:this.versionControlFileHistoryModule})}};var l=new m();l.init();return l});