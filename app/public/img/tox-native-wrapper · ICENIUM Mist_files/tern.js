(function(){CodeMirror.TernServer=function(I){var K=this;this.options=I||{};var J=this.options.plugins||(this.options.plugins={});if(!J.doc_comment){J.doc_comment=true}if(this.options.useWorker){this.server=new H(this)}else{this.server=new tern.Server({getFile:function(M,L){return n(K,M,L)},async:true,defs:this.options.defs||[],plugins:J})}this.docs=Object.create(null);this.trackChange=function(M,L){E(K,M,L)};this.cachedArgHints=null;this.activeArgHints=null;this.jumpStack=[]};CodeMirror.TernServer.prototype={addDoc:function(K,J){var I={doc:J,name:K,changed:null};this.server.addFile(K,i(this,I));CodeMirror.on(J,"change",this.trackChange);return this.docs[K]=I},delDoc:function(J){var I=this.docs[J];if(!I){return}CodeMirror.off(I.doc,"change",this.trackChange);delete this.docs[J];this.server.delFile(J)},hideDoc:function(J){e(this);var I=this.docs[J];if(I&&I.changed){z(this,I)}},complete:function(I){var J=this;CodeMirror.showHint(I,function(L,K){return p(J,L,K)},{async:true})},getHint:function(J,I){return p(this,J,I)},showType:function(I){C(this,I)},updateArgHints:function(I){G(this,I)},jumpToDef:function(I){r(this,I)},jumpBack:function(I){q(this,I)},rename:function(I){y(this,I)},request:function(J,L,I){var N=this;var K=m(this,J.getDoc());var M=d(this,K,L);this.server.request(M,function(P,O){if(N.options.responseFilter){O=N.options.responseFilter(K,L,M,P,O)}I(P,O)})}};var w=CodeMirror.Pos;var f="CodeMirror-Tern-";var c=250;function n(L,K,J){var I=L.docs[K];if(I){J(i(L,I))}else{if(L.options.getFile){L.options.getFile(K,J)}else{J(null)}}}function m(N,J,M){for(var L in N.docs){var I=N.docs[L];if(I.doc==J){return I}}if(!M){for(var K=0;;++K){L="[doc"+(K||"")+"]";if(!N.docs[L]){M=L;break}}}return N.addDoc(M,J)}function E(O,M,J){var L=m(O,M);var I=O.cachedArgHints;if(I&&I.doc==M&&g(I.start,J.to)<=0){O.cachedArgHints=null}var K=L.changed;if(K==null){L.changed=K={from:J.from.line,to:J.from.line}}var N=J.from.line+(J.text.length-1);if(J.from.line<K.to){K.to=K.to-(J.to.line-N)}if(N>=K.to){K.to=N+1}if(K.from>J.from.line){K.from=J.from.line}if(M.lineCount()>c&&J.to-K.from>100){setTimeout(function(){if(L.changed&&L.changed.to-L.changed.from>100){z(O,L)}},200)}}function z(J,I){J.server.request({files:[{type:"full",name:I.name,text:i(J,I)}]},function(K){if(K){console.error(K)}else{I.changed=null}})}function p(K,J,I){K.request(J,{type:"completions",types:true,docs:true,urls:true},function(Q,P){if(Q){return B(K,J,Q)}var O=[],L="";var R=P.start,U=P.end;if(J.getRange(w(R.line,R.ch-2),R)=='["'&&J.getRange(U,w(U.line,U.ch+2))!='"]'){L='"]'}for(var S=0;S<P.completions.length;++S){var N=P.completions[S],M=F(N.type);if(P.guess){M+=" "+f+"guess"}O.push({text:N.name+L,displayText:N.name,className:M,data:N})}var T={from:R,to:U,list:O};var V=null;CodeMirror.on(T,"close",function(){x(V)});CodeMirror.on(T,"update",function(){x(V)});CodeMirror.on(T,"select",function(X,Y){x(V);var W=K.options.completionTip?K.options.completionTip(X.data):X.data.doc;if(W){V=s(Y.parentNode.getBoundingClientRect().right+window.pageXOffset,Y.getBoundingClientRect().top+window.pageYOffset,W);V.className+=" "+f+"hint-doc"}});I(T)})}function F(J){var I;if(J=="?"){I="unknown"}else{if(J=="number"||J=="string"||J=="bool"){I=J}else{if(/^fn\(/.test(J)){I="fn"}else{if(/^\[/.test(J)){I="array"}else{I="object"}}}}return f+"completion "+f+"completion-"+I}function C(J,I){J.request(I,"type",function(L,K){if(L){return B(J,I,L)}if(J.options.typeTip){var M=J.options.typeTip(K)}else{var M=j("span",null,j("strong",null,K.type||"not found"));if(K.doc){M.appendChild(document.createTextNode(" — "+K.doc))}if(K.url){M.appendChild(document.createTextNode(" "));M.appendChild(j("a",null,"[docs]")).href=K.url}}D(I,M)})}function G(X,K){e(X);if(K.somethingSelected()){return}var T=K.getTokenAt(K.getCursor()).state;var O=CodeMirror.innerMode(K.getMode(),T);if(O.mode.name!="javascript"){return}var P=O.state.lexical;if(P.info!="call"){return}var J,R=P.pos||0,W=K.getOption("tabSize");for(var Q=K.getCursor().line,L=Math.max(0,Q-9),N=false;Q>=L;--Q){var U=K.getLine(Q),M=0;for(var R=0;;){var V=U.indexOf("\t",R);if(V==-1){break}M+=W-(V+M)%W-1;R=V+1}J=P.column-M;if(U.charAt(J)=="("){N=true;break}}if(!N){return}var S=w(Q,J);var I=X.cachedArgHints;if(I&&I.doc==K.getDoc()&&g(S,I.start)==0){return A(X,K,R)}X.request(K,{type:"type",preferFunction:true,end:S},function(Z,Y){if(Z||!Y.type||!(/^fn\(/).test(Y.type)){return}X.cachedArgHints={start:R,type:v(Y.type),name:Y.exprName||Y.name||"fn",guess:Y.guess,doc:K.getDoc()};A(X,K,R)})}function A(Q,K,N){e(Q);var J=Q.cachedArgHints,P=J.type;var O=j("span",J.guess?f+"fhint-guess":null,j("span",f+"fname",J.name),"(");for(var L=0;L<P.args.length;++L){if(L){O.appendChild(document.createTextNode(", "))}var I=P.args[L];O.appendChild(j("span",f+"farg"+(L==N?" "+f+"farg-current":""),I.name||"?"));if(I.type!="?"){O.appendChild(document.createTextNode(":\u00a0"));O.appendChild(j("span",f+"type",I.type))}}O.appendChild(document.createTextNode(P.rettype?") ->\u00a0":")"));if(P.rettype){O.appendChild(j("span",f+"type",P.rettype))}var M=K.cursorCoords(null,"page");Q.activeArgHints=s(M.right+1,M.bottom,O)}function v(N){var I=[],K=3;function M(R){var O=0,Q=K;for(;;){var P=N.charAt(K);if(R.test(P)&&!O){return N.slice(Q,K)}if(/[{\[\(]/.test(P)){++O}else{if(/[}\]\)]/.test(P)){--O}}++K}}if(N.charAt(K)!=")"){for(;;){var J=N.slice(K).match(/^([^, \(\[\{]+): /);if(J){K+=J[0].length;J=J[1]}I.push({name:J,type:M(/[\),]/)});if(N.charAt(K)==")"){break}K+=2}}var L=N.slice(K).match(/^\) -> (.*)$/);return{args:I,rettype:L&&L[1]}}function r(K,I){function J(N){var M={type:"definition",variable:N||null};var L=m(K,I.getDoc());K.request(I,M,function(P,O){if(P){return B(K,I,P)}if(!O.file&&O.url){window.open(O.url);return}if(O.file){var R=K.docs[O.file],Q;if(R&&(Q=l(R.doc,O))){K.jumpStack.push({file:L.name,start:I.getCursor("from"),end:I.getCursor("to")});t(K,L,R,Q.start,Q.end);return}}B(K,I,"Could not find a definition.")})}if(!b(I)){h(I,"Jump to variable",function(L){if(L){J(L)}})}else{J()}}function q(L,I){var K=L.jumpStack.pop(),J=K&&L.docs[K.file];if(!J){return}t(L,m(L,I.getDoc()),J,K.start,K.end)}function t(M,I,J,L,K){J.doc.setSelection(K,L);if(I!=J&&M.options.switchToDoc){e(M);M.options.switchToDoc(J.name)}}function l(N,L){var I=L.context.slice(0,L.contextOffset).split("\n");var T=L.start.line-(I.length-1);var S=w(T,(I.length==1?L.start.ch:N.getLine(T).length)-I[0].length);var U=N.getLine(T).slice(S.ch);for(var J=T+1;J<N.lineCount()&&U.length<L.context.length;++J){U+="\n"+N.getLine(J)}if(U.slice(0,L.context.length)==L.context){return L}var K=N.getSearchCursor(L.context,0,false);var Q,R=Infinity;while(K.findNext()){var P=K.from(),M=Math.abs(P.line-S.line)*10000;if(!M){M=Math.abs(P.ch-S.ch)}if(M<R){Q=P;R=M}}if(!Q){return null}if(I.length==1){Q.ch+=I[0].length}else{Q=w(Q.line+(I.length-1),I[I.length-1].length)}if(L.start.line==L.end.line){var O=w(Q.line,Q.ch+(L.end.ch-L.start.ch))}else{var O=w(Q.line+(L.end.line-L.start.line),L.end.ch)}return{start:Q,end:O}}function b(I){var J=I.getCursor("end"),K=I.getTokenAt(J);if(K.start<J.ch&&(K.type=="comment"||K.type=="string")){return false}return/\w/.test(I.getLine(J.line).slice(Math.max(J.ch-1,0),J.ch+1))}function y(K,I){var J=I.getTokenAt(I.getCursor());if(!/\w/.test(J.string)){B(K,I,"Not at a variable")}h(I,"New name for "+J.string,function(L){K.request(I,{type:"rename",newName:L,fullDocs:true},function(N,M){if(N){return B(K,I,N)}a(K,M.changes)})})}var u=0;function a(Q,J){var P=Object.create(null);for(var M=0;M<J.length;++M){var I=J[M];(P[I.file]||(P[I.file]=[])).push(I)}for(var L in P){var N=Q.docs[L],K=P[L];if(!N){continue}K.sort(function(R,S){return g(S,R)});var O="*rename"+(++u);for(var M=0;M<K.length;++M){var I=K[M];N.doc.replaceRange(I.text,I.start,I.end,O)}}}function d(Q,K,O){var L=[],N=0,I=!O.fullDocs;if(!I){delete O.fullDocs}if(typeof O=="string"){O={type:O}}O.lineCharPositions=true;if(O.end==null){O.end=K.doc.getCursor("end");if(K.doc.somethingSelected()){O.start=K.doc.getCursor("start")}}var P=O.start||O.end;if(K.changed){if(K.doc.lineCount()>c&&I!==false&&K.changed.to-K.changed.from<100&&K.changed.from<=P.line&&K.changed.to>O.end.line){L.push(o(K,P,O.end));O.file="#0";var N=L[0].offsetLines;if(O.start!=null){O.start=w(O.start.line- -N,O.start.ch)}O.end=w(O.end.line-N,O.end.ch)}else{L.push({type:"full",name:K.name,text:i(Q,K)});O.file=K.name;K.changed=null}}else{O.file=K.name}for(var M in Q.docs){var J=Q.docs[M];if(J.changed&&J!=K){L.push({type:"full",name:J.name,text:i(Q,J)});J.changed=null}}return{query:O,files:L}}function o(I,V,K){var J=I.doc;var S=null,T=null,L,W=4;for(var U=V.line-1,R=Math.max(0,U-50);U>=R;--U){var P=J.getLine(U),M=P.search(/\bfunction\b/);if(M<0){continue}var O=CodeMirror.countColumn(P,null,W);if(S!=null&&S<=O){continue}S=O;T=U}if(T==null){T=R}var Q=Math.min(J.lastLine(),K.line+20);if(S==null||S==CodeMirror.countColumn(J.getLine(V.line),null,W)){L=Q}else{for(L=K.line+1;L<Q;++L){var O=CodeMirror.countColumn(J.getLine(L),null,W);if(O<=S){break}}}var N=w(T,0);return{type:"part",name:I.name,offsetLines:N.line,text:J.getRange(N,w(L,0))}}function g(I,J){return I.line-J.line||I.ch-J.ch}function j(M,I){var J=document.createElement(M);if(I){J.className=I}for(var L=2;L<arguments.length;++L){var K=arguments[L];if(typeof K=="string"){K=document.createTextNode(K)}J.appendChild(K)}return J}function h(I,K,J){if(I.openDialog){I.openDialog(K+": <input type=text>",J)}else{J(prompt(K,""))}}function D(J,K){var M=J.cursorCoords();var L=s(M.right+1,M.bottom,K);function I(){if(!L.parentNode){return}J.off("cursorActivity",I);k(L)}setTimeout(I,1700);J.on("cursorActivity",I)}function s(K,L,I){var J=j("div",f+"tooltip",I);J.style.left=K+"px";J.style.top=L+"px";document.body.appendChild(J);return J}function x(I){var J=I&&I.parentNode;if(J){J.removeChild(I)}}function k(I){I.style.opacity="0";setTimeout(function(){x(I)},1100)}function B(K,I,J){if(K.options.showError){K.options.showError(I,J)}else{D(I,String(J))}}function e(I){if(I.activeArgHints){x(I.activeArgHints);I.activeArgHints=null}}function i(J,I){var K=I.doc.getValue();if(J.options.fileFilter){K=J.options.fileFilter(K,I.name,I.doc)}return K}function H(L){var M=new Worker(L.options.workerScript);M.postMessage({type:"init",defs:L.options.defs,plugins:L.options.plugins,scripts:L.options.workerDeps});var I=0,J={};function K(O,N){if(N){O.id=++I;J[I]=N}M.postMessage(O)}M.onmessage=function(O){var N=O.data;if(N.type=="getFile"){n(L,name,function(P,Q){K({type:"getFile",err:String(P),text:Q,id:N.id})})}else{if(N.type=="debug"){console.log(N.message)}else{if(N.id&&J[N.id]){J[N.id](N.err,N.body);delete J[N.id]}}}};M.onerror=function(N){for(var O in J){J[O](N)}J={}};this.addFile=function(N,O){K({type:"add",name:N,text:O})};this.delFile=function(N){K({type:"del",name:N})};this.request=function(N,O){K({type:"req",body:N},O)}}})();