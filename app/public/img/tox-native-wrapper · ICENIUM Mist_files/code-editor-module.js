define(function(x){var q=x("kendo"),b=x("modules/core/base-classes"),n=x("modules/core/helpers"),c=x("modules/core/base-commands"),l=x("modules/core/core-module"),h=x("text!./code-editor-template.html"),y=x("modules/find-replace/search-controler"),C=x("modules/view-pane/view-pane-adapter"),G=x("modules/view-pane/view-pane-service"),E=x("modules/view-pane/view-pane-renderer-base"),u=x("modules/project-navigator/project-navigator-module"),A=x("modules/workspace/solution-frame-service"),F=x("modules/view-pane/view-pane-renderer-base"),d=x("./code-analysis-module");x("noamd/loader-codemirror");CodeMirror.modeURL="../js/noamd/codemirror/mode/%N.js";var k=window,a={MODE_JS:"javascript",LANGUAGE_JAVASCRIPT:"javascript",LANGUAGE_CLIKE:"clike",LANGUAGE_CSS:"css",LANGUAGE_HTMLMIXED:"htmlmixed",LANGUAGE_XML:"xml"};var i=b.ViewModelBase.extend({init:function(){var H=this;b.ViewModelBase.fn.init.apply(H,[H]);y.bind(k.CLEAR_FIND_IN_DOCUMENT,$.proxy(H.onClearFindInDocument,H));y.bind(k.FIND_IN_DOCUMENT,$.proxy(H.onFindInDocument,H));y.bind(k.FIND_NEXT_IN_DOCUMENT,$.proxy(H.onFindNextInDocument,H));y.bind(k.FIND_PREVIOUS_IN_DOCUMENT,$.proxy(H.onFindPreviousInDocument,H));y.bind(k.REPLACE_CURRENT_SELECTION,$.proxy(H.onReplaceCurrentSelection,H));y.bind(k.REPLACE_ALL_MATCHS,$.proxy(H.onReplaceAllMatchs,H))},onClearFindInDocument:function(H){var I=H.editor.codeEditor;var K=H.editor.searchState;if(BrowserDetect.browser==="Explorer"){var J=I.getOption("readOnly");I.setOption("readOnly",true)}I.operation(function(){if(K&&K.marked){var N=K.marked;for(var M=0;M<N.length;M++){N[M].clear()}}var L=H.callback;if(L){L()}if(BrowserDetect.browser==="Explorer"){I.setOption("readOnly",J)}})},onFindInDocument:function(H){var P=this;var I=H.editor.codeEditor;var J=H.isCaseSense;var K=H.isRegex;var O=H.text;var M=H.replaceText;var N={marked:[],text:O,replaceText:M,isCaseSense:J,isRegex:K};var L=P._getSearchQuery(N);N.query=L;I.operation(function(){if(I.getValue().length<20000){var U=[];P._iterateAllSearchMatchs(I,N,function(W){U.push(W)});if(U.length>0){for(var S=0;S<U.length;S++){var T=U[S],R=T.from,V=T.to;N.marked.push(I.markText(R,V,"CodeMirror-searching"))}}}N.posFrom=N.posTo=I.getCursor();var Q=H.callback;if(Q){Q(N)}})},onFindNextInDocument:function(H){var I=H.editor.codeEditor;var J=H.editor.searchState;this._searchInEditor(I,J,H.callback)},onFindPreviousInDocument:function(H){var I=H.editor.codeEditor;var K=H.editor.searchState;var J=true;this._searchInEditor(I,K,H.callback,J)},onReplaceCurrentSelection:function(H){var I=H.editor.codeEditor;var J=I.getSelection();if(J.length>0){var K=H.editor.searchState.replaceText;I.replaceSelection(K)}},onReplaceAllMatchs:function(H){var M=this;var I=H.editor.codeEditor;var L=H.editor.searchState;if(L){var J=M._getSearchQuery(L);L.query=J;var K=L.replaceText;I.operation(function(){M._iterateAllSearchMatchs(I,L,function(O){I.replaceRange(K,O.from,O.to)});L.posFrom=L.posTo=I.getCursor();var N=H.callback;if(N){N(L)}})}},_iterateAllSearchMatchs:function(I,N,K){var H=I.getSearchCursor(N.query,null,!N.isCaseSense);var L="0000";while(H.findNext()){var J=H.from(),O=H.to(),M=[J.line,J.ch,O.line,O.ch].join("");if(L!==M){K({from:J,to:O});L=M}else{break}}},_searchInEditor:function(I,O,H,N){var K=O.isCaseSense;var L=O.isRegex;var M=O.query;M=(!K&&!L)?M.toLowerCase():M;var J=true;I.operation(function(){var P=I.getSearchCursor(M,N?O.posFrom:O.posTo,!K);if(!P.find(N)){P=I.getSearchCursor(M,N?{line:I.lineCount()-1}:{line:0,ch:0},!K);if(!P.find(N)){I.setCursor(I.getCursor());J=false}}if(J){var Q=O.posFrom=P.from(),R=O.posTo=P.to();I.setSelection(Q,R);if(H){H(O)}}})},_getSearchQuery:function(M){var I=M.isRegex,N=M.text,K=N;if(I){try{var J=N.match(/^\/(.*)\/([a-z]*)$/);var L=new RegExp(J[1],J[2].indexOf("i")===-1?"":"i");K=L}catch(H){}}return K}});var e=c.CommandBase.extend({init:function(){c.CommandBase.fn.init.apply(this,arguments)},canExecute:function(){var H=this._editor=f.getEditorByFile(G.activeItem().key);return(H?true:false)}});var B=e.extend({init:function(){e.fn.init.apply(this,arguments)},execute:function(){}});var s=e.extend({init:function(){e.fn.init.apply(this,arguments)},execute:function(){var I=this._editor;if(I&&!I.isReadOnly){var H=I.codeEditor;var M=H.getCursor(true).line;if(M>0){var J=M-1;var O=H.getCursor(true);var N=H.getCursor(false);O.line--;N.line--;var K=H.getLine(J);H.removeLine(J);var L=H.getCursor(false).line;if(L===(H.lineCount()-1)){K="\n"+K}else{K=K+"\n"}H.replaceRange(K,{line:L+1,ch:0});H.setSelection(O,N)}}}});var r=e.extend({init:function(){e.fn.init.apply(this,arguments)},execute:function(){var I=this._editor;if(I&&!I.isReadOnly){var H=I.codeEditor;var O=H.getCursor(false).line;var J=H.lineCount()-1;if(O<J){var K=O+1;var L=H.getLine(K)+"\n";if((K===J)&&(K>0)){var R=H.getCursor(true);var Q=H.getCursor(false);var N=K-1;var M=H.getLine(N).length;H.removeLine(K);H.replaceRange("",{line:N,ch:M},{line:K,ch:0});H.setSelection(R,Q)}else{H.removeLine(K)}var P=H.getCursor(true).line;H.replaceRange(L,{line:P,ch:0})}}}});var p=e.extend({init:function(){e.fn.init.apply(this,arguments)},execute:function(){}});var o=e.extend({init:function(){e.fn.init.apply(this,arguments)},execute:function(){}});var m=e.extend({init:function(){e.fn.init.apply(this,arguments)},execute:function(){var J=this._editor;if(J){var H=J.codeEditor;CodeMirror.commands.deleteLine(H);var L=H.lineCount(),I=H.getCursor(),M=I.line;if(M===0){if(L>1){H.replaceRange("",I,{line:M+1,ch:0})}}else{var N=M-1;var K=H.getLine(N).length;H.replaceRange("",{line:N,ch:K},I)}}}});var z=e.extend({init:function(){e.fn.init.apply(this,arguments)},execute:function(){var I=this._editor;if(I){var H=I.codeEditor;CodeMirror.commands.goLineEnd(H);CodeMirror.commands.newlineAndIndent(H)}}});var g=q.Observable.extend({contentNotificationsSuspended:false,init:function(){var I=this;I.languageLoaded=false;q.Observable.fn.init.apply(I,arguments);I.buildLanguages();I.editors=[];I.currentEditor=null;u.solutionController.bind(k.PROJECT_ITEM_IDENTIFIER_UPDATE,$.proxy(I.onProjectItemIdentifierUpdate,I));u.solutionController.bind(k.PROJECT_ITEM_RENAMED,$.proxy(I.onProjectItemRenamed,I));u.solutionController.bind(k.PROJECT_RENAMED,$.proxy(I.onProjectRenamed,I));y.bind(k.FIND_IN_DOCUMENT_STATE_CHANGED,$.proxy(I.onFindInDocumentStateChange,I));l.keyBindingService.bind(k.REGION_FOCUS_CHANGE,$.proxy(I.onRegionFocusChange,I));A.bind(k.LEFT_CENTER_SPLITTER_RESIZE,$.proxy(I.resizeElements,I));if(G.hasOpenItems()){var H=G.activeItem();f.content(H.fileContent);I.onCodeEditorFileLoading({file:H})}},onFindInDocumentStateChange:function(H){var I=H.editor;I.searchState=H.state},onContentChanged:function(H){var I=this;if(!I.contentNotificationsSuspended){I.trigger(k.CODEEDITOR_CONTENT_CHANGED,{content:I.content()})}},onRegionFocusChange:function(I){var J=this.currentEditor,H;if(G){H=G.activeItem()}if(I.oldRegionName===k.VIEWPANE_REGION&&I.newRegionName!==k.VIEWPANE_REGION){if(J){$("textarea",J.wrapper).blur()}}if(I.newRegionName===k.VIEWPANE_REGION&&J&&J.codeEditor&&H!==null&&H.codeEditorRender){J.codeEditor.focus()}},resizeElements:function(){this.resizeActiveEditor()},resizeActiveEditor:function(){var H=this;window.setTimeout(function(){var I=H.currentEditor;if(I){H.resizeElement(".CodeMirror-scroll",I.wrapper);var J=I.codeEditor;J.refresh()}},1)},resizeElement:function(I,J){var H=f.codeEditorsHolder,K=H.height();$(I,J).height(K)},initializeNewEditor:function(H){var J=this;if(J.currentEditor){J.currentEditor.wrapper.hide()}var I=J.createEditor(H);J.clearCodeAnalysis();J.editors.push(I);J.currentEditor=I;J.onCodeEditorFileLoading({file:H});I.codeEditor.on("change",$.proxy(J.onContentChanged,J));if(!BrowserDetect.features.iOS){J.focusEditor()}return I},restoreEditor:function(I){var J=this,H=J.editors[I];if(J.currentEditor!==H){J.currentEditor.wrapper.hide();H.wrapper.show();J.currentEditor=H}J.clearCodeAnalysis();J.focusEditor();J.resizeActiveEditor();J.trigger(k.CODE_EDITOR_ACTIVATED,{editor:H});return H},clearCodeAnalysis:function(){var H=d;for(var I in H.docs){H.delDoc(I)}},focusEditor:function(){var H=this;H.currentEditor.codeEditor.focus()},createEditor:function(J){var P=this,I,O,L=J.filePath,N=J.isReadOnly,K=J.fileContent,H=d,Q=$("<div></div>");P.codeEditorsHolder.append(Q);N=(N!==undefined&&N)?N:false;function M(R,S){return R.getModeAt(R.getCursor()).name===S}O={"Ctrl-I":function(R){if(M(R,a.MODE_JS)){H.showType(R)}},"Ctrl-Space":function(R){if(M(R,a.MODE_JS)){H.complete(R)}},"Ctrl-.":function(R){H.jumpToDef(R)},"Ctrl-,":function(R){H.jumpBack(R)},Esc:function(){y.closeFindDialog()},"Ctrl-D":function(){},"Ctrl-F":function(){},"Shift-Ctrl-F":function(){},"Ctrl-Enter":function(){},"Shift-Ctrl-Down":function(){},"Shift-Ctrl-C":function(R){I.foldCode(I.getCursor())}};if(k.BrowserDetect.OS==="Mac"){O.Home="goDocStart";O.End="goDocEnd"}I=new CodeMirror(Q[0],{value:K,readOnly:N,lineNumbers:true,lineWrapping:false,matchBrackets:true,indentUnit:4,indentWithTabs:false,extraKeys:O,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],wordWrap:true,highlightSelectionMatches:true,foldGutter:true,autoCloseTags:true,autoCloseBrackets:true});I.on("cursorActivity",function(R){if(M(R,a.MODE_JS)){H.updateArgHints(R)}});return{filePath:L,isReadOnly:N,codeEditor:I,wrapper:Q}},getEditorIndex:function(H){var J=this;for(var I=0;I<J.editors.length;I++){if(J.editors[I].filePath===H){return I}}return -1},setCursor:function(I,H){this.currentEditor.codeEditor.focus();this.currentEditor.codeEditor.setCursor(I,H)},updateFilePath:function(J,I){var K=this;var H=K.getEditorIndex(J);if(H!==-1){K.editors[H].filePath=I}},updateAllFilesPath:function(K,I){var N=this,L="\\\\"+K.replace("\\","\\\\"),J="\\"+I,M=new RegExp("^"+L);for(var H=0;H<N.editors.length;H++){N.editors[H].filePath=N.editors[H].filePath.replace(M,J)}},setLanguageMode:function(J,K){var L=this,I,H;if(K){I=L.getEditorIndex(K);if(I!==-1){H=L.editors[I].codeEditor}}else{H=this.currentEditor.codeEditor}if(H){H.setOption("mode",J)}},content:function(H){var I=this;if(H!==undefined){I.setCodeEditorContent(H);I.trigger(k.CODEEDITOR_CONTENT_CHANGED,{content:H});return I}else{if(I.currentEditor){return I.currentEditor.codeEditor.getValue()}return""}},setCodeEditorContent:function(H,I){var J=this;if(!I){I=J.currentEditor}J.contentNotificationsSuspended=true;I.codeEditor.setValue(H);J.contentNotificationsSuspended=false},setDefaultContent:function(){var H=G.activeItem();if(H){H.defaultContent=this.content()}},getEditorByFile:function(I){var K=this,H=null,J;if(I){J=K.getEditorIndex(I);H=K.editors[J]}return H},getLanguage:function(J){var M=this;var H=n.getFileExtension(J);for(var L=0;L<M.languages.length;L++){var I=$(M.languages[L].extensions);var K=I.filter(function(N){return(I[N]===H)});if(K.length>0){return M.languages[L]}}return t},buildLanguages:function(){var H=this;this.languages=[{language:a.LANGUAGE_JAVASCRIPT,mode:"text/javascript",extensions:["js"]},{language:a.LANGUAGE_JAVASCRIPT,mode:"text/x-c++src",extensions:["cpp"]},{language:a.LANGUAGE_CLIKE,mode:"text/x-csharp",extensions:["cs"]},{language:a.LANGUAGE_CLIKE,mode:"text/x-java",extensions:["java"]},{language:a.LANGUAGE_CLIKE,mode:"text/x-objectivec",extensions:["h","m","mm"]},{language:a.LANGUAGE_HTMLMIXED,mode:"text/html",extensions:["htm","html","aspx","cshtml"],loadedDependencies:0},{language:a.LANGUAGE_CSS,mode:"text/css",extensions:["css"]},{language:a.LANGUAGE_XML,mode:"application/xml",extensions:["xml","config","svg","xib","plist"]}]},onCodeEditorFileLoading:function(H){this.updateActiveEditorLanguage(H.file.fileName)},onProjectItemIdentifierUpdate:function(H){var I=H.dataItem;var J=H.newIdentifier;f.updateFilePath(I.getPath(),I.getPathFromIdentifier(J))},onProjectRenamed:function(H){f.updateAllFilesPath(H.oldIdentifier,H.newIdentifier)},onProjectItemRenamed:function(H){this.updateEditorLanguage(H.newKey,H.dataItem.itemText())},updateActiveEditorLanguage:function(H){var I=this.getLanguage(H);this.loadLanguage(I,function(){f.setLanguageMode(I.mode)})},updateEditorLanguage:function(J,H){var I=this.getLanguage(H);this.loadLanguage(I,function(){f.setLanguageMode(I.mode,J)})},loadLanguage:function(I,H){if(I.language!==undefined){CodeMirror.requireMode(I.language,function(){H()})}else{H()}}});var t={mode:"text/plain"};var j={init:function(){var H=this;F.fn.init.apply(H,arguments);f.bind(k.CODEEDITOR_CONTENT_CHANGED,$.proxy(H.onEditorChange,H))},onEditorChange:function(H){var I=this;I.trigger(I.EVENT_CHANGE,H)},appendToElement:function(){var H=this;F.fn.appendToElement.apply(H,arguments);H._viewModel=new i();H._$element=l.viewRenderer.renderInside(h,H._viewModel,H._$container);f.codeEditorsHolder=$("#codeEditorsHolder",H._$element)},loadViewItem:function(H){var I=f.getEditorIndex(H.filePath);if(I>=0){f.setCodeEditorContent(H.fileContent,f.editors[I])}else{f.initializeNewEditor(H)}},activateEditorByKey:function(I){var H=f.getEditorIndex(I);if(H>=0){f.restoreEditor(H)}},replaceRange:function(H,K,J){var I=f.currentEditor.codeEditor;I.replaceRange(H,K,J)},setSelection:function(J,I){var H=f.currentEditor.codeEditor;if($(H.getWrapperElement()).width()>0){H.setSelection(J,I)}},getContent:function(){if(f.currentEditor){return f.currentEditor.codeEditor.getValue()}return""},closeByKey:function(J){var I=f.getEditorIndex(J);if(I>=0){var H=f.editors[I];H.wrapper.remove();f.editors.splice(I,1);f.clearCodeAnalysis()}},resize:function(){f.resizeActiveEditor()}};function v(){l.commandService.registerCommand(new B(k.COMMAND_TOGGLE_CODE_FOLDING,"Toggle Code-Folding",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL,k.KEY_SHIFT],keys:[k.KEY_C],modifiersOSX:[k.KEY_CMD,k.KEY_SHIFT],preventDefaultBrowserAction:true}}])).registerCommand(new s(k.COMMAND_MOVE_LINES_UP,"Move Lines Up",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL,k.KEY_SHIFT],keys:[k.KEY_UP_ARROW],modifiersOSX:[k.KEY_ALT,k.KEY_SHIFT]}}])).registerCommand(new r(k.COMMAND_MOVE_LINES_DOWN,"Move Lines Down",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL,k.KEY_SHIFT],keys:[k.KEY_DOWN_ARROW],modifiersOSX:[k.KEY_ALT,k.KEY_SHIFT],preventDefaultBrowserAction:true}}])).registerCommand(new p(k.COMMAND_INDENT_SELECTED_LINES,"Indent Selection",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[],keys:[k.KEY_TAB]}}])).registerCommand(new o(k.COMMAND_INDENT_LESS_SELECTED_LINES,"Indent Less Selection",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_SHIFT],keys:[k.KEY_TAB]}}])).registerCommand(new m(k.COMMAND_DELETE_LINE,"Delete Line",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL],keys:[k.KEY_D],modifiersOSX:[k.KEY_CMD],preventDefaultBrowserAction:true}}])).registerCommand(new z(k.COMMAND_SMART_NEW_LINE,"Smart New Line",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL],keys:[k.KEY_ENTER],modifiersOSX:[k.KEY_CMD]}}])).registerCommand(new c.VirtualCommand(k.COMMAND_SHOW_IDENTIFIER_TYPE,"Show Identifier Type",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL],keys:[k.KEY_I]}}])).registerCommand(new c.VirtualCommand(k.COMMAND_CODE_COMPLETE,"Code Complete",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL],keys:[k.KEY_SPACE]}}])).registerCommand(new c.VirtualCommand(k.COMMAND_GO_TO_DEFINITION,"Go To Identifier Definition",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL],keys:[k.KEY_DOT]}}])).registerCommand(new c.VirtualCommand(k.COMMAND_GO_BACK,"Go Back",[k.CODE_EDITOR_COMMANDS],[{region:k.VIEWPANE_REGION,keyShortcut:{modifiers:[k.KEY_CTRL],keys:[k.KEY_COMMA]}}]))}var f=new g();l.loaderService.triggerEvent(k.CODEEDITOR_LOADED);var D=E.extend(j);var w=new D();C.registerViewRender(k.VIEW_PANE_RENDER_CODE_EDITOR,w);v();return f});