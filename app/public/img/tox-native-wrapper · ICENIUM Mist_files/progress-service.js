define(function(i){var j=i("./view-renderer"),a=i("modules/core/base-classes"),c=i("./data-loss-protection-service"),d=i("text!../reusable-templates/progress-template.html");var b=window;var f=a.ViewModelBase.extend({init:function(){var k=this;k.caption=k.DEFAULT_CAPTION;k.isVisible=false;a.ViewModelBase.fn.init.apply(k,[k]);k.bind("bind",$.proxy(k.onBind,k))},onBind:function(k){var l=this;l.placeHolder=$(".global-progress",k.view)}});var e=kendo.Observable.extend({DEFAULT_CAPTION:"Loading...",DATA_PROTECTION_CAPTION:"Operations are in progress.",ViewModel:f,init:function(){var k=this;kendo.Observable.fn.init.apply(this,arguments);c.bind(b.APP_BEFORE_UNLOAD,$.proxy(k.onAplicationUnloading,k))},onAplicationUnloading:function(k){var l=this;if(l.viewModel!==undefined&&l.viewModel.get("isVisible")){k.objections.push(l.DATA_PROTECTION_CAPTION)}},showProgress:function(k){var l=this;if(l.viewModel===undefined){l.viewModel=new l.ViewModel();j.renderInside(d,l.viewModel,document.body)}l.viewModel.set("caption",k===undefined?l.DEFAULT_CAPTION:k);l.viewModel.set("isVisible",true)},hideProgress:function(){var k=this;if(k.viewModel!==undefined){k.viewModel.set("isVisible",false)}}});var h=f.extend({hasTasks:false,init:function(){var k=this;k.runningTasks=0;f.fn.init.apply(k,[k]);k.set("taskList",new kendo.data.DataSource({data:[]}))},clearTasks:function(){var l=this,k=l.get("taskList");k.data([]);l.runningTasks=0;l.set("hasTasks",false)},addTask:function(l,n){var m=this,k=m.get("taskList");m.currentTaskRow=k.add({taskName:l,maxValue:n,value:0});m.set("hasTasks",true);m.runningTasks++},updateProgress:function(k){var o=this,l=o.currentTaskRow.get("value"),m=o.currentTaskRow.get("maxValue"),n=l+k;o.currentTaskRow.set("value",n);if(n===m){o.runningTasks--}return o.runningTasks},updateTaskProgress:function(o,k){var t=this,m=t.get("taskList").data(),s=null;for(var n=0;n<m.length;n++){var p=m[n];if(p.taskName===o){var l=p.get("value"),r=l+k,q=p.get("maxValue");p.set("value",r);if(r===q){t.runningTasks--}break}}return t.runningTasks}});var g=e.extend({ViewModel:h,init:function(){e.fn.init.apply(this,arguments)},showProgress:function(){var k=this;e.fn.showProgress.apply(this,arguments);k.viewModel.clearTasks()},beginSubtask:function(k){var l=this;if(l.viewModel===undefined||!l.viewModel.get("isVisible")){l.showProgress()}l.viewModel.addTask(k.identifier,k.totalWorkCount)},updateProgress:function(k){var l=this;l.viewModel.updateProgress(k.completedUnitsCount);l.initiateHideProgress()},updateTaskProgress:function(k){var l=this;l.viewModel.updateTaskProgress(k.identifier,k.completedUnitsCount);l.initiateHideProgress()},initiateHideProgress:function(){var k=this;setTimeout(function(){var l=k.viewModel.get("runningTasks");if(l===0){k.hideProgress()}},100)},endSubtask:function(){}});return new g()});