define(function(F){var w,B,r=F("kendo"),e=F("modules/core/base-classes"),h=F("modules/core/core-module"),l=F("modules/core/helpers"),y=F("modules/project-properties/project-properties-service"),i=F("modules/core/dialog-service"),J=F("modules/version-control/version-control-service"),I=F("modules/workspace/solution-settings-service"),L=F("modules/view-pane/view-pane-renderer-base"),K=F("modules/view-pane/view-pane-adapter"),G=F("modules/core/rest-proxy"),H=G.init(window.location.host,serviceConfiguration.backendServiceScheme),m=F("text!./data/ios-background-modes.json"),v=F("text!./project-properties-container.html"),z=F("text!./project-properties-template.html"),j=F("text!./inner-templates/general-properties-template.html"),n=F("text!./inner-templates/ios-general-properties-template.html"),p=F("text!./inner-templates/ios-icons-properties-template.html"),q=F("text!./inner-templates/ios-splash-screens-properties-template.html"),b=F("text!./inner-templates/android-general-properties-template.html"),c=F("text!./inner-templates/android-permissions-properties-template.html"),t=F("text!./inner-templates/plugins-properties-template.html");F("css!./project-properties.css");m=l.ensureJSON(m);var f=window,a={EVENT_VIEW_LOAD:"viewLoad",EVENT_VIEW_CLOSE:"viewClose",EVENT_IMAGE_SOURCE_CHANGED:"imageSourceChanged",MESSAGE_ERROR:"Error",MESSAGE_NOT_SUPPORTED_FORMAT:"The file {0} is not a valid image",MESSAGE_REMOVE_PERMISSION_CAPTION:"Remove Permission",MESSAGE_REMOVE_PERMISSION_TEXT:"Are you sure you want to remove this permission?",MESSAGE_NOT_VALID_9PATCH_IMAGE:"This isn't a valid 9 Patch image.",ENUM_IOS_DEVICE_FAMILY_VALUES:{IPhoneAndIPod:"1",IPad:"2"},ENUM_IOS_DEVICE_FAMILY_DATA:{"1":{name:"iphone",displayName:"iPhone/iPod Touch"},"2":{name:"ipad",displayName:"iPad"}},ENUM_DEVICE_ORIENTATIONS_VALUES:{portrait:"Portrait",landscape:"Landscape"},ENUM_DEVICE_ORIENTATIONS_DATA:{Portrait:{name:"portrait",displayName:"Portrait"},Landscape:{name:"landscape",displayName:"Landscape"}}};var C=L.extend({appendToElement:function(){var M=this;L.fn.appendToElement.apply(M,arguments);M._$element=$(v).appendTo(M._$container)},loadViewItem:function(N){var O=this,M=$.Deferred();O.trigger(a.EVENT_VIEW_LOAD,{deferred:M,project:N,placeHolder:O._$element});return M.promise()},closeViewItem:function(){var M=this;M.trigger(a.EVENT_VIEW_CLOSE)}});var D=h.ViewRendererBase.extend({bind:function(M){var N=this;N.viewModel=M.viewModel;N.$view=$(M.view);N.setInitialSelection()},setInitialSelection:function(){var N=this,M,O=$("#categoriesTree",N.$view).data("kendoTreeView");M=N.viewModel.get("categoriesList").find(function(P){if(P.id===y.consts.GROUP_NAME_GENERAL.id){return true}});O.select(O.findByUid(M.uid))}});var u=h.ViewRendererBase.extend({viewModel:null,$view:null,bind:function(M){var N=this;N.viewModel=M.viewModel;N.$view=$(M.view);N.viewModel.validator=N.$view.data("kendoValidator");N.viewModel.bind(a.EVENT_IMAGE_SOURCE_CHANGED,$.proxy(N.onImageUploaded,N));$(".image-setting-image").on("error",function(){this.onerror=null;$(this).parents(".image-setting-container").addClass("no-image")})},onImageUploaded:function(N){var M=N.$element;M.parents(".image-setting-container").removeClass("no-image")}});var s=h.ViewRendererBase.extend({viewModel:null,$view:null,bind:function(M){var N=this;N.viewModel=M.viewModel;N.$view=$(M.view);N.viewModel.validator=N.$view.data("kendoValidator");N.attachAddPluginCommands()},attachAddPluginCommands:function(){var N=this,M=h.commandService.getCommandFromCategory(f.PLUGIN_PROPERTIES_COMMANDS,f.COMMAND_ADD_PLUGIN_FROM_ARCHIVE);N.openPluginXmlCommand=h.commandService.getCommandFromCategory(f.PLUGIN_PROPERTIES_COMMANDS,f.COMMAND_OPEN_PLUGIN_XML);$("#importCustomPlugin",N.$view).on("click",$.proxy(M.execute,M));$("#openPluginXml",N.$view).on("click",$.proxy(N.handleOpenXmlRequested,N))},handleOpenXmlRequested:function(){var M=this;M.openPluginXmlCommand.execute.apply(M.openPluginXmlCommand,[M.viewModel.describePlugin.xmlUri]);M.viewModel.set("isDescriptionShown",false)}});var A=e.ViewModelBase.extend({categoriesList:null,init:function(M){var N=this;N.categoriesList=M;e.ViewModelBase.fn.init.apply(N,[N])},setViewModels:function(N){var M=this;M._viewModels=N},dispose:function(){var N=this,O=N._viewModels;for(var M in O){if(O.hasOwnProperty(M)){O[M].dispose()}}},onSelect:function(N){var P=this,M=N.sender.dataItem(N.sender.select()),O=N.sender.dataItem(N.node);if(!P.validateViewModel(M.id)){N.preventDefault()}else{P.selectCategory(O.id)}},validateViewModel:function(M){var N=this;if(N._viewModels[M]!==undefined&&!N._viewModels[M].isValid()){return false}return true},selectCategory:function(N){var O=this,P=O._viewModels;if(P[N]===undefined){return}for(var M in P){if(P.hasOwnProperty(M)){P[M].deactivate()}}P[N].activate();P[N].isValid()}});var E=e.ViewModelBase.extend({isVisible:false,model:null,init:function(M){var N=this;N.model=M;e.ViewModelBase.fn.init.apply(N,[N]);N._changeHandler=$.proxy(N.saveModel,N);N.model.bind(N.model.events.MODEL_CHANGED,N._changeHandler)},activate:function(){var M=this;M.set("isVisible",true)},deactivate:function(){var M=this;M.set("isVisible",false)},dispose:function(){var M=this;M.model.unbind(M.model.events.MODEL_CHANGED,M._changeHandler)},isValid:function(){var M=this,N=M.validator;if(N!==undefined&&!N.validate()){return false}return true},saveModel:function(M){var N=this;if(N.isValid()){N.model.saveData(M)}},onSelectImage:function(M){var P=this,O=M.files[0],N=O.extension.toLowerCase();if(N.length>0){N=N.substring(1,N.length)}if(f.IMAGE_FILE_TYPES.indexOf(N)===-1){i.showMessageBox(a.MESSAGE_ERROR,r.format(a.MESSAGE_NOT_SUPPORTED_FORMAT,O.name));M.preventDefault()}},onUploadImage:function(M){var R=this,N=M.files[0],O=M.data,Q=O.get("imageUrl").split("?")[0],P=l.getNonCachedUrl(Q);O.uploadImage(N.rawFile).done(function(){O.set("imageUrl",P);R.trigger(a.EVENT_IMAGE_SOURCE_CHANGED,{item:O,newUrl:P,oldUrl:Q,$element:M.sender.element})}).fail(function(S){i.showMessageBox(a.MESSAGE_ERROR,S.message)});M.preventDefault()}});var k=E.extend({isVisible:true,deviceOrientationList:null,init:function(){var M=this;E.fn.init.apply(M,arguments);M.set("deviceOrientationList",M._getOrientationList())},clearApplicationIdentifier:function(M){var N=this;N.model.set("applicationIdentifier","")},clearAppVersion:function(M){var N=this;N.model.set("appVersion","")},onOrientationOptionToggle:function(M){var N=this;N.updateOrientationList()},updateOrientationList:function(){var O=this,N=[],M=O.get("deviceOrientationList");N=$.map(M,function(P){if(!P.get("selected")){return}return P.get("value")});O.model.set("deviceOrientations",N.join(";"))},_getOrientationList:function(){var Q=this,N,O=[],P=Q.model.get("deviceOrientations").split(";");for(var M in a.ENUM_DEVICE_ORIENTATIONS_VALUES){if(a.ENUM_DEVICE_ORIENTATIONS_VALUES.hasOwnProperty(M)){O.push(a.ENUM_DEVICE_ORIENTATIONS_VALUES[M])}}N=$.map(O,function(R){var S=false;if(P.indexOf(R)>=0){S=true}return{value:R,name:a.ENUM_DEVICE_ORIENTATIONS_DATA[R].name,displayName:a.ENUM_DEVICE_ORIENTATIONS_DATA[R].displayName,iconName:a.ENUM_DEVICE_ORIENTATIONS_DATA[R].name,selected:S}});return N}});var o=E.extend({isVisible:false,backgroundModesList:null,deviceFamilyList:null,codeSignIdentitiesList:null,statusBarStylesList:f.STATUS_BAR_STYLES,init:function(){var M=this;E.fn.init.apply(M,arguments);M.set("backgroundModesList",M._getBackgroundModesList());M.set("deviceFamilyList",M._getDeviceFamilyList());M.set("codeSignIdentitiesList",M._getCodeSignIdentitiesList())},clearDisplayName:function(){var M=this;M.model.set("iOSDisplayName","")},onBackgroundModeToggle:function(M){var N=this;N.updateBackgroundMode()},updateBackgroundMode:function(){var O=this,N=[],M=O.get("backgroundModesList");N=$.map(M,function(P){if(!P.get("selected")){return}return P.get("value")});O.model.set("iOSBackgroundMode",N.join(";"))},onDeviceFamilyToggle:function(M){var N=this;N.updateDeviceFamily()},updateDeviceFamily:function(){var O=this,N=[],M=O.get("deviceFamilyList");N=$.map(M,function(P){if(!P.get("selected")){return}return P.get("value")});O.model.set("iOSDeviceFamily",N.join(";"))},_getBackgroundModesList:function(){var O=this,N,M=O.model.get("iOSBackgroundMode").split(";");N=$.map(m,function(P){var Q=false;if(M.indexOf(P.id)>=0){Q=true}return{value:P.id,displayName:P.displayName,description:P.description,iconName:P.id,selected:Q}});return N},_getDeviceFamilyList:function(){var Q=this,O,N=[],P=Q.model.get("iOSDeviceFamily").split(";");for(var M in a.ENUM_IOS_DEVICE_FAMILY_VALUES){if(a.ENUM_IOS_DEVICE_FAMILY_VALUES.hasOwnProperty(M)){N.push(a.ENUM_IOS_DEVICE_FAMILY_VALUES[M])}}O=$.map(N,function(R){var S=false;if(P.indexOf(R)>=0){S=true}return{value:R,iconName:a.ENUM_IOS_DEVICE_FAMILY_DATA[R].name,displayName:a.ENUM_IOS_DEVICE_FAMILY_DATA[R].displayName,selected:S}});return O},_getCodeSignIdentitiesList:function(){var N=this,M=N.model.getProject().properties.AppIdentifier;return I.getCodeSigningIdentities(f.DevicePlatforms.iOS,M)}});var d=E.extend({isVisible:false,clearVersionCode:function(){var M=this;M.model.set("androidVersionCode","")},onUploadSplashImage:function(N){var P=this,M=N.data,O=N.files[0].rawFile;N.preventDefault();l.validate9PatchImage(O).done(function(Q){N.data=M;if(Q){P.onUploadImage(N)}else{i.showMessageBox(a.MESSAGE_ERROR,a.MESSAGE_NOT_VALID_9PATCH_IMAGE)}})},deleteSplash:function(M){var T=this,N=M.data,R=T.model.getProject(),Q=N.uploadUrl.split("\\").splice(4).join("\\"),S=R._getResourceItem(Q,"Resource"),P=N.get("imageUrl").split("?")[0],O=l.getNonCachedUrl(P);if(S!==undefined){T.deleteSplashFromFS(N).done(function(){T.deleteSplashFromVC(N).done(function(){N.set("imageUrl",O);T.trigger(a.EVENT_IMAGE_SOURCE_CHANGED,{item:N,newUrl:O,oldUrl:P,$element:$(M.target)});J.Track()})})}},deleteSplashFromFS:function(M){return H.fileSystemService.remove({path:M.uploadUrl})},deleteSplashFromVC:function(M){var O=this,N=M.uploadUrl.split("\\").splice(2).join("\\");return H.versionControlService.remove({workspaceName:iceConfiguration.solutionName,filePaths:[N]})}});var g=E.extend({isVisible:false,describePlugin:{name:"",version:"",description:"",docAddress:"",xmlUri:""},onDescriptionIconClick:function(M){var N=this;N.set("describePlugin",M.data);N.set("isDescriptionShown",true)},closeDescriptionWindow:function(){var M=this;M.set("isDescriptionShown",false)},isDescriptionShown:false});var x=r.Observable.extend({categoriesMap:{general:{},"ios-general":{"ios-icons":{},"ios-splash-screens":{}},"android-general":{"android-permissions":{}},"cordova-plugins":{}},viewModelsMap:{general:{viewModel:k,template:j,viewRenderer:u},"ios-general":{viewModel:o,template:n,viewRenderer:u},"ios-icons":{viewModel:E,template:p,viewRenderer:u},"ios-splash-screens":{viewModel:E,template:q,viewRenderer:u},"android-general":{viewModel:d,template:b,viewRenderer:u},"android-permissions":{viewModel:E,template:c,viewRenderer:u},"cordova-plugins":{viewModel:g,template:t,viewRenderer:s}},init:function(){var M=this;r.Observable.fn.init.apply(M,arguments);B.bind(a.EVENT_VIEW_LOAD,$.proxy(M.loadProjectProperties,M));B.bind(a.EVENT_VIEW_CLOSE,$.proxy(M.closeProjectProperties,M))},loadProjectProperties:function(P){var T=this,U,M,N,Q=y.getAllProperties(P.project),O=T.getCategoriesData(Q),S=new D(),R=T.projectPropertiesViewModel=new A(O);M=S.render(z,R,P.placeHolder);N=$("#propertiesView",M);T.createViewModels(Q,N).done(function(V){R.setViewModels(V);P.deferred.resolve()})},closeProjectProperties:function(M){var N=this;N.projectPropertiesViewModel.dispose()},getCategoriesData:function(O){var P=this,N,M;N=P.getCategoriesHash(O);M=P.buildCategoriesDataByMap(N,P.categoriesMap);return M},getCategoriesHash:function(R){var S=this,P,Q,M,N={};for(var O=0;O<R.length;O++){P=R[O];Q=P.get("id");M={text:P.get("displayName"),id:Q,expanded:true};N[Q]=M}return N},buildCategoriesDataByMap:function(M,N){var S=this,P,R,Q=[];for(var O in N){R=S.buildCategoriesDataByMap(M,N[O]);P=M[O];P.items=R;Q.push(P)}return Q},createViewModels:function(T,M){var U=this,R,O,P=$.Deferred(),V={},S=[];function N(X){var W=X.model.get("id");V[W]=X}for(var Q=0;Q<T.length;Q++){R=T[Q];O=U.createViewModel(R,M);O.done(N);S.push(O)}$.when.apply(null,S).done(function(){P.resolve(V)});return P.promise()},createViewModel:function(P,M){var Q=this,N=P.get("id"),O=$.Deferred();if(Q.viewModelsMap[N]===undefined){O.reject()}P.loadData().done(function(){var R=new Q.viewModelsMap[N].viewModel(P),S=new Q.viewModelsMap[N].viewRenderer();S.renderInside(Q.viewModelsMap[N].template,R,M);O.resolve(R)});return O.promise()}});B=new C();K.registerViewRender(f.VIEW_PANE_RENDER_PROJECT_PROPERTIES,B);w=new x();return w});