define(function(o){var t,k=o("kendo"),e=o("modules/core/core-module"),h=o("modules/core/helpers"),b=o("modules/core/base-commands"),f=o("modules/core/dialog-service"),r=o("modules/view-pane/view-pane-adapter"),l=o("modules/project-navigator/project-navigator-module"),a={MESSAGE_RELOAD_FILES_TITLE:"Confirm Reload",MESSAGE_RELOAD_FILES_TEXT:"The following open files are modified outside of their editor.</br> Do you want to reload them discarding the local changes?",MSG_SaveFileChangesMessage:"Save changes to the following files?<br />",MSG_SaveFileChangesCaption:"Save files?"};var d=window;var q=k.data.ObservableObject.extend({key:"",viewRenders:[],isDirty:false,init:function(){var v=this;k.data.ObservableObject.fn.init.apply(v,arguments);v.renderPromise=r.getRenderComponentsAsync(v.viewRenders)},type:function(){},itemClass:function(){return"type-"+this.get("type")},open:function(){},activate:function(){},deactivate:function(){},close:function(){},reload:function(){},save:function(){}});var g=q.extend({init:function(v){var w=this;w.key=v.filePath;q.fn.init.apply(w,arguments)}});var m=g.extend({viewRenders:[d.VIEW_PANE_RENDER_PROJECT_PROPERTIES],_project:null,init:function(v,w){var x=this;g.fn.init.apply(x,[v]);x._project=w},open:function(){var v=this;v.loading=v.load();return $.when(v.loading,v.renderPromise)},close:function(){var w=this,v=$.Deferred();w.renderPromise.done(function(x){x.closeViewItem();v.resolve()});return v.promise()},activate:function(){var v=this;v.renderPromise.done(function(w){r.showOnly(v.viewRenders)});return $.when(v.loading,v.renderPromise)},deactivate:function(){var v=this;r.supress(v.viewRenders)},reload:function(){var v=this;return $.when(v.loading,v.renderPromise)},load:function(){var w=this,v=$.Deferred();w.renderPromise.done(function(x){x.loadViewItem(w._project).done(function(){v.resolve()})});return v.promise()}});var j=g.extend({viewRenders:[d.VIEW_PANE_RENDER_IMAGE],open:function(){var v=this;v.loading=v.renderPromise;return $.when(v.loading,v.renderPromise)},activate:function(){var v=this;v.renderPromise.done(function(w){v._render(w)});return $.when(v.loading,v.renderPromise)},deactivate:function(){var v=this;r.supress(v.viewRenders);return $.when(v.loading,v.renderPromise)},reload:function(){var v=this;v.renderPromise.done(function(w){v._render(w);w.supress()});return $.when(v.loading,v.renderPromise)},_render:function(w){var v=this;w.loadViewItem(v);r.showOnly(v.viewRenders)}});var c=g.extend({viewRenders:[d.VIEW_PANE_RENDER_CODE_EDITOR],init:function(){var v=this;g.fn.init.apply(v,arguments);v.renderPromise.then(function(w){v.codeEditorRender=w})},open:function(){var v=this,w;v.loading=v.loadFileContent();return $.when(v.loading,v.renderPromise)},activate:function(){var v=this;$.when(v.renderPromise,v.loading).then(function(w){r.showOnly(v.viewRenders);w.activateEditorByKey(v.key);v.codeEditorRender.bind(v.codeEditorRender.EVENT_CHANGE,$.proxy(v.onEditorChange,v))});return $.when(v.loading,v.renderPromise)},deactivate:function(){var v=this;v.set("fileContent",v.codeEditorRender.getContent());r.supress(v.viewRenders);v.codeEditorRender.unbind(v.codeEditorRender.EVENT_CHANGE);return $.when(v.loading,v.renderPromise)},reload:function(){var w=this,v=w.loading;w.loading=w.loadFileContent();return $.when(v,w.loading,w.renderPromise)},loadFileContent:function(){var y=this,w=new $.Deferred(),x=y.loading||true,v;if(y.get("isVirtual")){v=$.when(y.get("fileContent"))}else{v=ice.server.fileSystemService.getContent({path:y.get("filePath")})}$.when(y.renderPromise,x).then(function(){v.done(function(z){y.set("fileContent",z);y.set("defaultContent",z);y.codeEditorRender.loadViewItem(y);w.resolve(z)}).fail(function(z){w.reject(z)})});return w.promise()},close:function(){var v=this;v.renderPromise.done(function(w){v.set("fileContent",w.closeByKey(v.key))});return $.when(v.loading,v.renderPromise)},onEditorChange:function(v){var w=this;if(v.content!==undefined){w.set("fileContent",v.content);w.set("isDirty",v.content!==w.get("defaultContent"));t.fireItemChange(w)}}});var i=c.extend({viewRenders:[d.VIEW_PANE_RENDER_CODE_EDITOR,d.VIEW_PANE_RENDER_HTML_DESIGNER,d.VIEW_PANE_RENDER_SPLIT_VIEW_CONTROLS],init:function(){var v=this;g.fn.init.apply(v,arguments);v.renderPromise.then(function(w,x,y){v.codeEditorRender=w;v.htmlDesignerRender=x;v.splitViewControls=y})},activate:function(){var v=this;$.when(v.renderPromise,v.loading).then(function(){var w={editor:v.codeEditorRender};r.showOnly(v.viewRenders);v.splitViewControls.loadViewItem(w);v.codeEditorRender.activateEditorByKey(v.key);v.htmlDesignerRender.setMarkup(v.codeEditorRender.getContent());v.codeEditorRender.bind(v.codeEditorRender.EVENT_CHANGE,$.proxy(v.onEditorChange,v));v.htmlDesignerRender.bind(v.htmlDesignerRender.EVENT_CHANGE,$.proxy(v.onDesignerChange,v));v.htmlDesignerRender.bind(v.htmlDesignerRender.EVENT_SELECT,$.proxy(v.onDesignerSelect,v));v.splitViewControls.bind(v.splitViewControls.EVENT_CHANGE,$.proxy(v.onSplitArrangementChange,v))});return $.when(v.loading,v.renderPromise)},reload:function(){var v=this;return $.when(c.fn.reload.apply(v,arguments)).then(function(){v.htmlDesignerRender.setMarkup(v.codeEditorRender.getContent())})},deactivate:function(){var v=this;v.htmlDesignerRender.unbind(v.htmlDesignerRender.EVENT_CHANGE);v.htmlDesignerRender.unbind(v.htmlDesignerRender.EVENT_SELECT);v.splitViewControls.unbind(v.splitViewControls.EVENT_CHANGE);return c.fn.deactivate.apply(v,arguments)},onEditorChange:function(v){var w=this;if(w.htmlDesignerRender._$element.width()>0){w.htmlDesignerRender.setMarkup(v.content)}c.fn.onEditorChange.apply(w,arguments)},onDesignerChange:function(v){var y=this,x={line:v.from.row,ch:v.from.col},w={line:v.to.row,ch:v.to.col};y.codeEditorRender.replaceRange(v.code,x,w)},onDesignerSelect:function(v){var y=this,x={line:v.from.row,ch:v.from.col},w={line:v.to.row,ch:v.to.col};y.codeEditorRender.setSelection(x,w)},onSplitArrangementChange:function(v){var w=this;w.codeEditorRender.resize(v);if(v.fromMode!==v.toMode){if(v.fromMode==w.splitViewControls.SPLIT_MODES.code){w.htmlDesignerRender.setMarkup(w.codeEditorRender.getContent())}}}});var u=k.Observable.extend({openedItems:[],_activeItem:null,init:function(){var v=this;k.Observable.fn.init.apply(v,arguments);l.solutionController.bind(d.FILE_OPEN_REQUESTED,$.proxy(v.onOpenView,v));l.solutionController.bind(d.FILE_RELOAD_REQUESTED,$.proxy(v.onReloadView,v));l.solutionController.bind(d.FILE_SYSTEM_REFERENCE_DELETE,$.proxy(v.onProjectItemDeleted,v));l.solutionController.bind(d.PROJECT_ITEM_IDENTIFIER_UPDATED,$.proxy(v.onProjectItemIdentifierUpdate,v));l.solutionController.bind(d.PROJECT_RENAMED,$.proxy(v.onProjectRenamed,v));l.solutionController.bind(d.SOLUTION_RENAMED,$.proxy(v.onSolutionRenamed,v));l.solutionController.bind(d.SOLUTION_RELOADED,$.proxy(v.onSolutionReloaded,v));e.dataLossProtectionService.bind(d.APP_BEFORE_UNLOAD,$.proxy(v.onAplicationUnloading,v))},openView:function(w){var v=this;w.set("isLoading",true);v.openedItems.push(w);v.trigger(d.VIEW_OPENED,{viewItem:w});w.open().done(function(){v.activeItem(w);w.set("isLoading",false);v.trigger(d.VIEW_LOADED,{viewItem:w,index:v.openedItems.length-1,key:w.key,type:w.type,name:w.fileName})})},isItemOpen:function(w){var v=this;return v.openedItems.indexOf(w)!==-1},onOpenView:function(v){var w=this,x=w.getItemByKey(v.filePath);if(x!==undefined){if(w._activeItem!==x&&!x.isLoading){w.activeItem(x)}}else{x=w.createViewItem(v);w.openView(x)}e.keyBindingService.focusRegion(d.VIEWPANE_REGION)},createViewItem:function(v){var x=this,y=x.getItemByKey(v.filePath),w={filePath:v.filePath,fileName:v.fileName,type:v.iconType,isReadOnly:v.readOnly,isVirtual:v.virtual,fileContent:v.fileContent};if(v.dataItem.projectItemType()==d.PROJECT_ITEM_PROPERTIES_DIRECTORY){y=new m(w,v.dataItem.project)}else{if(h.isImageFile(w.filePath)){y=new j(w)}else{if("html"===h.getDocumentTypeByFilePath(w.filePath)&&$.browser.webkit===true&&$.browser.chrome===true){y=new i(w)}else{y=new c(w)}}}return y},fireItemChange:function(w){var v=this;v.trigger(d.VIEW_CHANGED,{viewItem:w,index:v.openedItems.indexOf(w)})},onReloadView:function(v){var w=this,x=w.getItemByKey(v.filePath);if(x!==undefined){x.reload().done(function(){x.set("isDirty",false)}).fail(function(){if(w.isItemOpen(x)){w._closeItem(x)}})}},onProjectItemIdentifierUpdate:function(C){var B=this,D,A,w=false,x=C.dataItem.getPathFromIdentifier(C.newIdentifier),y=C.dataItem.itemText(),z=C.dataItem.iconType(),v=B.getItemIndexByKey(C.dataItem.getPathFromIdentifier(C.oldIdentifier));if(v>=0){D=B.openedItems[v];A=D.type;if(x&&D.filePath!==x){D.set("filePath",x);D.set("key",x);if(B._activeItem===D){w=true}B.trigger(d.VIEW_KEY_CHANGE,{index:v,newKey:x,isActive:w});if(y&&D.fileName!==y){D.set("fileName",y);D.set("type",z);B.trigger(d.VIEW_RENAMED,{index:v,oldType:A,newType:z,newName:y})}}}},onProjectRenamed:function(v){var C=this,z="\\\\"+v.oldIdentifier.replace("\\","\\\\"),y="\\"+v.newIdentifier,A=C.openedItems,B=new RegExp("^"+z),x=false;for(var w=0;w<A.length;w++){A[w].filePath=A[w].filePath.replace(B,y);if(A[w]===C._activeItem){x=true}C.trigger(d.VIEW_KEY_CHANGE,{index:w,newPath:A[w].filePath,isActive:x})}},onProjectItemDeleted:function(v){var w=this,x=w.getItemByKey(v.filePath);if(x){w._closeItem(x)}},onAplicationUnloading:function(v){var w=this,x=w._getUnsavedFilesFullPathList();if(x.length){x.unshift("You have unsaved changes in following items");v.objections.push(x.join("\n"))}},activeItem:function(y){var x=this,v=x._activeItem,w=x.openedItems.indexOf(x._activeItem);if(y!==undefined){if(v&&v!==y){x._activeItem=null;v.deactivate();x.trigger(d.VIEW_DEACTIVATED,{file:v,index:w})}if(y!==null&&v!==y){x._activeItem=y;y.activate();x.trigger(d.VIEW_ACTIVATED,{file:y,index:x.openedItems.indexOf(y)})}}return x._activeItem},activeIndex:function(v){var w=this,x=w.openedItems[v];if(x!==undefined){if(w._activeItem!==x){w.activeItem(x)}return v}else{return w.openedItems.indexOf(w._activeItem)}},activateNextItem:function(v){var y=this,w,x;if(y.openedItems.length>1){w=y.activeIndex();y.activeIndex((w+y.openedItems.length+v)%y.openedItems.length)}},hasOpenItems:function(){return(this.openedItems.length>0)},reloadAllFiles:function(){var x=this;if(x.openedItems===undefined||x.openedItems.length===0){return}for(var v=0;v<x.openedItems.length;v++){var w=x.openedItems[v];x.onReloadView({filePath:w.filePath})}},reloadFileslWithConfirmation:function(v){var A=this,x=v.filePathsList||[],B=[],C=A._getUnsavedItemsDialogList(),w=new $.Deferred(),z=false;for(var y=0;y<C.length;y++){if(x.indexOf(C[y].FilePath)>=0){B.push(C[y])}}if(B.length!==0){f.showFileListConfirmationDialog(a.MESSAGE_RELOAD_FILES_TITLE,{message:a.MESSAGE_RELOAD_FILES_TEXT,fileList:B,accept:function(){z=true;w.resolve(true);A.reloadAllFiles()},reject:function(){z=true;w.resolve(false)},cancelVisible:false}).always(function(){if(!z){w.reject()}})}else{A.reloadAllFiles();w.resolve(true)}return w.promise()},closeItem:function(w){var v=this;if(w){if(w.isDirty){f.showFileListConfirmationDialog(a.MSG_SaveFileChangesCaption,{message:a.MSG_SaveFileChangesMessage,fileList:[{FilePath:w.key,IconType:w.get("type")}],accept:function(){v._saveItem(w,function(){v._closeItem(w)})},reject:function(){v._closeItem(w)},cancelVisible:true})}else{v._closeItem(w)}}},closeByIndex:function(v){var w=this;var x=w.openedItems[v];if(x){w.closeItem(x)}},closeActive:function(){this.closeItem(this._activeItem)},closeAll:function(){while(this.openedItems.length>0){this._closeByIndex(0)}},_closeByIndex:function(v){var w=this,x=w.openedItems[v];w._closeItem(x)},_closeItem:function(x){var w=this,v=w.openedItems.indexOf(x);if(x){if(w._activeItem===x){w._activeItem=null;x.deactivate();w.trigger(d.VIEW_DEACTIVATED,{file:x,index:v})}w.openedItems.splice(w.openedItems.indexOf(x),1);x.close();w.trigger(d.VIEW_CLOSED,{file:x,index:v})}},saveModifiedItemsWithConfirmation:function(){var x=this,y=x._getUnsavedItemsDialogList(),v=new $.Deferred(),w=false;if(y.length!==0){f.showFileListConfirmationDialog(a.MSG_SaveFileChangesCaption,{message:a.MSG_SaveFileChangesMessage,fileList:y,accept:function(){w=true;x._saveAllModifiedFilesDiffered().done(function(){v.resolve(true)}).fail(function(){f.showMessageBox("Icenium","An error occured, while saving your changes!");v.reject()})},reject:function(){w=true;v.resolve(false)},cancelVisible:true}).always(function(){if(!w){v.reject()}})}else{v.resolve(true)}return v.promise()},saveModifiedFiles:function(v){this._saveModifiedFiles(0,v)},saveAllModifiedFiles:function(){var v=this;return v._saveAllModifiedFilesBool()},_saveModifiedFiles:function(x,v){var y=this;if(x===y.openedItems.length){v();return}for(var w=x;w<y.openedItems.length;w++){if(y.openedItems[w].isDirty){y._saveItem(y.openedItems[w],$.proxy(y._saveModifiedFiles,y,w+1,v));return}}v()},_saveAllModifiedFilesBool:function(){var x=this,v=x.saveAllModifiedFilesDifferedArray(),w=v.length>0;if(v.length!==0){$.when.apply(null,v).then(function(y){x.trigger(d.ALL_FILES_SAVED)},function(y){x.trigger(d.SAVING_FILES_FAILED);f.showMessageBox("Icenium","An error occured, while saving your changes!")})}return w},_saveAllModifiedFilesDiffered:function(){var x=this,w=x.saveAllModifiedFilesDifferedArray(),v=new $.Deferred();if(w.length!==0){$.when.apply(null,w).then(function(y){v.resolve()},function(y){v.reject()})}return v.promise()},saveAllModifiedFilesDifferedArray:function(){var x=this,v=[];for(var w=0;w<x.openedItems.length;w++){if(x.openedItems[w].isDirty){v.push(x._saveFileDiferred(x.openedItems[w]))}}return v},_getUnsavedFilesFullPathList:function(){var x=this,w=[];for(var v=0;v<x.openedItems.length;v++){if(x.openedItems[v].isDirty){w.push(x.openedItems[v].key)}}return w},_getUnsavedItemsDialogList:function(){var x=this,w=[];for(var v=0;v<x.openedItems.length;v++){var y=x.openedItems[v];if(y.isDirty){w.push({FilePath:y.get("filePath"),IconType:y.get("type")})}}return w},saveActiveItem:function(){var v=this;v._saveItem(v.activeItem())},_saveItem:function(x,v){var w=this;w.trigger(d.FILE_SAVING,{file:x,index:w.openedItems.indexOf(x)});ice.server.fileSystemService.save({path:x.filePath,content:x.fileContent,validatorTypeName:""}).done(function(){var y=x.filePath.split("\\").splice(2).join("\\");w.trigger(d.FILE_SAVED,{file:x,index:w.openedItems.indexOf(x)});l.solutionController.markFileAsModified(y);if(v){v()}x.defaultContent=x.fileContent;x.set("isDirty",false)}).fail(function(y){f.showConfirmationDialog("Icenium",{message:["Last save operation was not successful!","Do you want to retry?"].join("<br/>"),accept:function(){w._saveItem.call(w,x,v)}})})},_saveFileDiferred:function(x){var w=this,v=new $.Deferred();ice.server.fileSystemService.save({path:x.filePath,content:x.fileContent,validatorTypeName:""}).done(function(){var y=x.filePath.split("\\").splice(2).join("\\");w.trigger(d.FILE_SAVING,{file:x,index:w.openedItems.indexOf(x)});l.solutionController.markFileAsModified(y);x.set("defaultContent",x.fileContent);x.set("isDirty",false);w.trigger(d.FILE_SAVED,{file:x,index:w.openedItems.indexOf(x)});v.resolve()}).fail(function(){v.reject()});return v.promise()},getItemIndexByKey:function(w){var x=this;for(var v=0;v<x.openedItems.length;v++){if(x.openedItems[v].key===w){return v}}return -1},getItemByKey:function(w){var x=this,v=x.getItemIndexByKey(w);if(v>=0){return x.openedItems[v]}},onSolutionRenamed:function(v){var y=this,w=v.dataItem,x=v.newText;y.saveModifiedItemsWithConfirmation().done(function(z){y._syncSolution(w,x,z)})},_syncSolution:function(w,y,v){var z=w.childItems(0),A=z.getProjectIdentifier(),x=y+"\\"+z.text;if(!v){e.dataLossProtectionService.suspend()}l.solutionController.renameSolutionOnServer(w,y).done(function(){iceConfiguration.solutionName=y;w.itemText(y);e.navigationService.navigateToSolution(y)}).fail(function(){if(!v){e.dataLossProtectionService.resume()}})},onSolutionReloaded:function(){var v=this;v.reloadAllFiles()}});var s=k.data.ObservableObject.extend({componentRegister:{},init:function(w){var v=this;k.data.ObservableObject.fn.init.apply(v,[v]);v.$viewPaneRegionElement=$(w)},getRenderComponentsAsync:function(w){var z=this,y=[];for(var v=0,x=w.length;v<x;v++){if(z.componentRegister[w[v]]===undefined){z.componentRegister[w[v]]={component:null,deferred:new $.Deferred()}}y.push(z.componentRegister[w[v]].deferred.promise())}return $.when.apply(this,y)},registerViewRender:function(v,x){var w=this;if(w.componentRegister[v]===undefined){w.componentRegister[v]={component:x,deferred:new $.Deferred()}}else{w.componentRegister[v].component=x}x.appendToElement(w.$viewPaneRegionElement);x._$element.hide();w.componentRegister[v].deferred.resolve(x)},showOnly:function(w){var x=this;for(var v in x.componentRegister){if(x.componentRegister.hasOwnProperty(v)&&x.componentRegister[v].component!==undefined){if(w.indexOf(v)>=0){x.componentRegister[v].component._$element.show()}else{x.componentRegister[v].component.supress();x.componentRegister[v].component._$element.hide()}}}},supress:function(w){var x=this;for(var v in x.componentRegister){if(x.componentRegister.hasOwnProperty(v)&&x.componentRegister[v].component!==undefined){if(w.indexOf(v)>=0){x.componentRegister[v].component.supress();x.componentRegister[v].component._$element.hide()}}}}});var p=b.CommandBase.extend({init:function(){var v=this;b.CommandBase.fn.init.apply(v,arguments);t.bind(d.VIEW_ACTIVATED,$.proxy(v.onActiveViewChanged,v));t.bind(d.VIEW_DEACTIVATED,$.proxy(v.onActiveViewChanged,v));t.bind(d.VIEW_CHANGED,$.proxy(v.onActiveViewChanged,v))},canExecute:function(){var v=t.activeItem();return(v&&v.isDirty)?true:false},execute:function(){t.saveActiveItem()},onActiveViewChanged:function(){this.raiseCanExecuteChanged()}});function n(){e.commandService.registerCommand(new p(d.COMMAND_SAVE_FILE,"Save",[d.SOLUTION_MENU_COMMANDS],[{region:d.VIEWPANE_REGION,keyShortcut:{modifiers:[d.KEY_CTRL],keys:[d.KEY_S],modifiersOSX:[d.KEY_CMD],preventDefaultBrowserAction:true}}],null,true))}t=new u();n();return t});