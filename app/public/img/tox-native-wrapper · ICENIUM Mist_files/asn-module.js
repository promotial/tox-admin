define(function(){function c(d,e){if(d instanceof c){this.enc=d.enc;this.pos=d.pos}else{this.enc=d;this.pos=e}}c.prototype.get=function(d){if(d==undefined){d=this.pos++}if(d>=this.enc.length){throw"Requesting byte offset "+d+" on a stream of length "+this.enc.length}return this.enc[d]};c.prototype.hexDigits="0123456789ABCDEF";c.prototype.hexByte=function(d){return this.hexDigits.charAt((d>>4)&15)+this.hexDigits.charAt(d&15)};c.prototype.hexDump=function(g,d){var f="";for(var e=g;e<d;++e){f+=this.hexByte(this.get(e));switch(e&15){case 7:f+="  ";break;case 15:f+="\n";break;default:f+=" "}}return f};c.prototype.parseStringISO=function(g,d){var f="";for(var e=g;e<d;++e){f+=String.fromCharCode(this.get(e))}return f};c.prototype.parseStringUTF=function(h,e){var g="",d=0;for(var f=h;f<e;){d=this.get(f++);if(d<128){g+=String.fromCharCode(d)}else{if((d>191)&&(d<224)){g+=String.fromCharCode(((d&31)<<6)|(this.get(f++)&63))}else{g+=String.fromCharCode(((d&15)<<12)|((this.get(f++)&63)<<6)|(this.get(f++)&63))}}}return g};c.prototype.reTime=/^((?:1[89]|2\d)?\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/;c.prototype.parseTime=function(g,d){var f=this.parseStringISO(g,d);var e=this.reTime.exec(f);if(!e){return"Unrecognized time: "+f}var h=(e[1]>=50)?"19"+e[1]:"20"+e[1];f=h+"-"+e[2]+"-"+e[3]+"T"+e[4];if(e[5]){f+=":"+e[5];if(e[6]){f+=":"+e[6];if(e[7]){f+="."+e[7]}}}if(e[8]){f+=e[8];if(e[9]){f+=":"+e[9]}}return f};c.prototype.parseInteger=function(j,d){var f=d-j;if(f>4){f<<=3;var h=this.get(j);if(h==0){f-=8}else{while(h<128){h<<=1;--f}}return"("+f+" bit)"}var g=0;for(var e=j;e<d;++e){g=(g<<8)|this.get(e)}return g};c.prototype.parseBitString=function(m,e){var n=this.get(m);var h=((e-m-1)<<3)-n;var k="("+h+" bit)";if(h<=20){var l=n;k+=" ";for(var f=e-1;f>m;--f){var d=this.get(f);for(var g=l;g<8;++g){k+=(d>>g)&1?"1":"0"}l=0}}return k};c.prototype.parseOctetString=function(h,d){var f=d-h;var g="("+f+" byte) ";if(f>20){d=h+20}for(var e=h;e<d;++e){g+=this.hexByte(this.get(e))}if(f>20){g+=String.fromCharCode(8230)}return g};c.prototype.parseOID=function(j,e){var h,g=0,d=0;for(var f=j;f<e;++f){var k=this.get(f);g=(g<<7)|(k&127);d+=7;if(!(k&128)){if(h==undefined){h=parseInt(g/40)+"."+(g%40)}else{h+="."+((d>=31)?"bigint":g)}g=d=0}h+=String.fromCharCode()}return h};function a(f,d,e,h,g){this.stream=f;this.header=d;this.length=e;this.tag=h;this.sub=g}a.prototype.typeName=function(){if(this.tag==undefined){return"unknown"}var d=this.tag>>6;var e=(this.tag>>5)&1;var f=this.tag&31;switch(d){case 0:switch(f){case 0:return"EOC";case 1:return"BOOLEAN";case 2:return"INTEGER";case 3:return"BIT_STRING";case 4:return"OCTET_STRING";case 5:return"NULL";case 6:return"OBJECT_IDENTIFIER";case 7:return"ObjectDescriptor";case 8:return"EXTERNAL";case 9:return"REAL";case 10:return"ENUMERATED";case 11:return"EMBEDDED_PDV";case 12:return"UTF8String";case 16:return"SEQUENCE";case 17:return"SET";case 18:return"NumericString";case 19:return"PrintableString";case 20:return"TeletexString";case 21:return"VideotexString";case 22:return"IA5String";case 23:return"UTCTime";case 24:return"GeneralizedTime";case 25:return"GraphicString";case 26:return"VisibleString";case 27:return"GeneralString";case 28:return"UniversalString";case 30:return"BMPString";default:return"Universal_"+f.toString(16)}case 1:return"Application_"+f.toString(16);case 2:return"["+f+"]";case 3:return"Private_"+f.toString(16)}};a.prototype.content=function(){if(this.tag==undefined){return null}var f=this.tag>>6;if(f!==0){return(this.sub==null)?null:"("+this.sub.length+")"}var g=this.tag&31;var d=this.posContent();var e=Math.abs(this.length);switch(g){case 1:return(this.stream.get(d)==0)?"false":"true";case 2:return this.stream.parseInteger(d,d+e);case 3:return this.sub?"("+this.sub.length+" elem)":this.stream.parseBitString(d,d+e);case 4:return this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(d,d+e);case 6:return this.stream.parseOID(d,d+e);case 16:case 17:return"("+this.sub.length+" elem)";case 12:return this.stream.parseStringUTF(d,d+e);case 18:case 19:case 20:case 21:case 22:case 26:return this.stream.parseStringISO(d,d+e);case 23:case 24:return this.stream.parseTime(d,d+e)}return null};a.prototype.toString=function(){return this.typeName()+"@"+this.stream.pos+"[header:"+this.header+",length:"+this.length+",sub:"+((this.sub==null)?"null":this.sub.length)+"]"};a.prototype.posStart=function(){return this.stream.pos};a.prototype.posContent=function(){return this.stream.pos+this.header};a.prototype.posEnd=function(){return this.stream.pos+this.header+Math.abs(this.length)};a.prototype.fakeHover=function(d){this.node.className+=" hover";if(d){this.head.className+=" hover"}};a.prototype.fakeOut=function(d){var e=/ ?hover/;this.node.className=this.node.className.replace(e,"");if(d){this.head.className=this.head.className.replace(e,"")}};a.decodeLength=function(g){var d=g.get();var f=d&127;if(f==d){return f}if(f>3){throw"Length over 24 bits not supported at position "+(g.pos-1)}if(f==0){return -1}d=0;for(var e=0;e<f;++e){d=(d<<8)|g.get()}return d};a.hasContent=function(j,e,g){if(j&32){return true}if((j<3)||(j>4)){return false}var f=new c(g);if(j==3){f.get()}var i=f.get();if((i>>6)&1){return false}try{var h=a.decodeLength(f);return((f.pos-g.pos)+h==e)}catch(d){return false}};a.decode=function(k){if(!(k instanceof c)){k=new c(k,0)}var l=new c(k);var n=k.get();var h=a.decodeLength(k);var g=k.pos-l.pos;var m=null;if(a.hasContent(n,h,k)){var j=k.pos;if(n==3){k.get()}m=[];if(h>=0){var f=j+h;while(k.pos<f){m[m.length]=a.decode(k)}if(k.pos!==f){throw"Content size is not correct for container starting at offset "+j}}else{try{for(;;){var i=a.decode(k);if(i.tag==0){break}m[m.length]=i}h=j-k.pos}catch(d){throw"Exception while decoding undefined length content: "+d}}}else{k.pos+=h}return new a(l,g,h,n,m)};a.test=function(){var h=[{value:[39],expected:39},{value:[129,201],expected:201},{value:[131,254,220,186],expected:16702650}];for(var d=0,e=h.length;d<e;++d){var g=new c(h[d].value,0);var f=a.decodeLength(g);if(f!==h[d].expected){alert.write("In test["+d+"] expected "+h[d].expected+" got "+f+"\n")}}};var b={};b.decode=function(d){if(b.decoder==undefined){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var e="= \f\n\r\t\u00A0\u2028\u2029";var l=[];for(var m=0;m<64;++m){l[f.charAt(m)]=m}for(var n=0;n<e.length;++n){l[e.charAt(n)]=-1}b.decoder=l}var o=[];var g=0,k=0;for(var m=0;m<d.length;++m){var h=d.charAt(m);if(h=="="){break}h=b.decoder[h];if(h==-1){continue}if(h==undefined){throw"Illegal character at offset "+m}g|=h;if(++k>=4){o[o.length]=(g>>16);o[o.length]=(g>>8)&255;o[o.length]=g&255;g=0;k=0}else{g<<=6}}switch(k){case 1:throw"Base64 encoding incomplete: at least 2 bits missing";case 2:o[o.length]=(g>>10);break;case 3:o[o.length]=(g>>16);o[o.length]=(g>>8)&255;break}return o};b.re=/-----BEGIN [^-]+-----([A-Za-z0-9+\/=\s]+)-----END [^-]+-----|begin-base64[^\n]+\n([A-Za-z0-9+\/=\s]+)====/;b.unarmor=function(d){var e=b.re.exec(d);if(e){if(e[1]){d=e[1]}else{if(e[2]){d=e[2]}}}return b.decode(d)};return{ASN1:a,Base64:b,Stream:c}});