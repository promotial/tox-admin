define(function(i){var g=i("kendo"),f=i("modules/core/helpers"),e=i("modules/core/dialog-viewmodels"),d=i("modules/core/dialog-service"),j=i("modules/version-control/version-control-service"),h=i("modules/logging/logging-service"),a=i("text!./version-control-commit-template.html");i("css!./version-control-commit-styles.css");var c=window;var b=e.MessageBoxViewModel.extend({context:3,changedLinesCount:{inserted:0,modified:0,deleted:0},pendingChanges:[],selectionCount:0,commentMessage:"",isMerging:false,isLoading:false,init:function(){var k=this;e.MessageBoxViewModel.fn.init.apply(k,arguments);k.prepare();k.bind("bind",$.proxy(k.onBind,k))},prepare:function(){var s=this,p=j.GetPendingChanges(),r=j.GetPendingChangesForSelection();var q=j.GetRepositoryState();s.set("isMerging",q.CanCommit&&q.IsMerging);s.set("commentMessage",q.CommentText);s.set("pendingChanges",p);for(var m=0;m<r.length;m++){var n=p.indexOf(r[m]);s.pendingChanges[n].isSelected=true}for(var o=0;o<s.pendingChanges.length;o++){if(!s.pendingChanges[o].isSelected){s.pendingChanges[o].isSelected=false}}if(s.pendingChangesDS===undefined){s.pendingChangesDS=new g.data.DataSource({data:s.pendingChanges})}else{var l=s.pendingChanges.length>0?s.pendingChanges:[];s.pendingChangesDS.data(l)}if(s.filePathsDS!==undefined){s.filePathsDS.data([])}s.set("selectionCount",r.length);s.set("changedLinesCount",{inserted:0,modified:0,deleted:0})},onBind:function(m){var o=this,k=$("#uncommitedFilesGrid"),n=o.gridContentSelector="#uncommitedFilesGrid > div.k-grid-content";$("#commentsBox > input",m.view).placeholder();o.pendingChangesGrid=k.kendoGrid({dataSource:o.pendingChangesDS,columns:[{field:"isSelected",title:"&nbsp;",template:"<input type='checkbox' #if (isSelected) {#checked#}# />",width:"30px"},{field:"name",title:"Name",template:"<span class='document-type-icon ico-#=iconType#'></span>#=name#"},{field:"changeType",title:"Status",template:"<span title='#=changeType#'  class='ico-version-control change-type-#=changeType#' />",width:"50px"}],dataBound:function(q){var p=$("#uncommitedFilesGrid");$("input[type=checkbox]",n).on("click",function(t){var u=this,r=o.get("selectionCount"),s=o.pendingChangesGrid.dataItem(u.parentElement.parentElement);s.isSelected=u.checked;if(u.checked){r++}else{r--}o.set("selectionCount",r)})},change:function(p){o._previewChanges.call(o)},selectable:"multiple, row",scrollable:true}).data("kendoGrid");var l=$("<input id='checkAllPendingChanges' type='checkbox'></input>");l.click(function(t){var r=l.attr("checked");var q=$("input[type=checkbox]",n);for(var u=0;u<q.length;u++){var p=$(q[u]);var s=o.pendingChangesGrid.dataItem(p[0].parentElement.parentElement);p.attr("checked",r!==undefined)}if(r!==undefined){o.set("selectionCount",q.length)}else{o.set("selectionCount",0)}});$("#uncommitedFilesGrid table thead th:first").append(l);o.filePathsDS=new g.data.DataSource({data:[],model:{fields:{path:{type:"string"}}}});o.previewChangesGrid=$("#previewGrid").kendoGrid({columns:[{field:"path",title:" ",template:"<span class='document-type-icon ico-#=iconType#'></span>#=path#"}],dataSource:o.filePathsDS,detailInit:function(p){$("<div/>").appendTo(p.detailCell).kendoGrid({columns:[{field:"OldLineNumber",title:"Old",template:"<span>#=OldLineNumber#</span>"},{field:"NewLineNumber",title:"New",template:"<span>#=NewLineNumber#</span>"},{title:" ",attributes:{"class":"line-status-#=BlockContainerType#"}},{field:"LineContents",title:"Line"}],dataSource:new g.data.DataSource({data:o.fileLines,filter:{field:"FilePath",operator:"eq",value:p.data.path}})})},dataBound:function(){var q=this;q.expandRow(q.tbody.find("tr.k-master-row"));var p=q.tbody.find("tr.k-detail-row div.k-grid");o._hideEmptyColumns(p)}}).data("kendoGrid");o.set("selectionCount",o._getSelection().length)},_hideEmptyColumns:function(n){var s=this;if(n===undefined){return}for(var r=0;r<n.length;r++){var m=$(n[r]).data("kendoGrid");var o=m.dataSource.data();var q=0,l=0;for(var p=0;p<o.length;p++){var k=o[p];switch(k.BlockContainerType){case j.LineChangeType.Inserted:q+=1;break;case j.LineChangeType.Modified:break;case j.LineChangeType.Deleted:l+=1;break}}if(q===o.length){s._hideColumnByIndex(r,1)}if(l===o.length){s._hideColumnByIndex(r,2)}}},_hideColumnByIndex:function(m,l){var k=$("#previewGrid table tbody tr.k-detail-row");if(m>k.length-1){return}k=$(k[m]);k.find("td.k-detail-cell div.k-grid-content table tbody tr td:nth-child("+l+")").hide();k.find("td.k-detail-cell div.k-grid-header table colgroup col:nth-child("+l+")").hide();k.find("td.k-detail-cell div.k-grid-header table thead tr th:nth-child("+l+")").hide()},_getIconTypesFromSelection:function(){var p=this,k=p.pendingChangesGrid,n=[],o=k.tbody.find(">tr.k-state-selected");for(var l=0;l<o.length;l++){var m=k.dataItem(o[l]).iconType;n.push(m)}return n},_getFilePathsFromSelection:function(){var p=this,m=p.pendingChangesGrid,l=[],o=m.tbody.find(">tr.k-state-selected");for(var n=0;n<o.length;n++){var k=m.dataItem(o[n]).name;l.push(k)}return l},_previewChanges:function(){var o=this,l=o._getFilePathsFromSelection();var n=j.statusHash;var m=0;while(m<l.length){var k=l[m];if(f.isImageFile(k)||n[k]==="Deleted"||n[k]==="Added"){l.splice(m,1)}else{m++}}if(l===undefined||l.length===0){$("#previewGrid").children().hide();o.set("changedLinesCount",{inserted:0,modified:0,deleted:0});return}o.fileLines=[];j.GetDiff({contextSize:o.context,filePaths:l}).done($.proxy(this._onDiffReceived,this))},_onDiffReceived:function(u,o){var v=this;if(u===undefined||u.length===0){return}if(u.length!==o.length){return}var m={inserted:0,deleted:0,modified:0};for(var p=0;p<u.length;p++){var t=u[p].DiffLineBlock;for(var r=0;r<t.length;r++){if(t[r].NewLineNumber===undefined){t[r].NewLineNumber=""}if(t[r].OldLineNumber===undefined){t[r].OldLineNumber=""}var n=t[r].BlockContainerType;switch(n){case j.LineChangeType.Inserted:m.inserted+=1;break;case j.LineChangeType.Deleted:m.deleted+=1;break;case j.LineChangeType.Modified:m.modified+=1;break}t[r].FilePath=o[p];v.fileLines.push(t[r])}}v.set("changedLinesCount",m);var q=v._getIconTypesFromSelection();var l=[];for(var s=0;s<o.length;s++){l.push({path:o[s],iconType:q[s]})}v.filePathsDS.data(l);$("#previewGrid").children().show()},onContextSliderChange:function(k){this._previewChanges()}.attribute("track",{featureCategory:c.TrackingTags.featureCategory.VersionControl.name,featureName:c.TrackingTags.featureCategory.VersionControl.features.ContextChange}),previewSummary:function(){var l=this,k=l.get("changedLinesCount");return[[k.inserted,"inserted"].join(" "),[k.modified,"modified"].join(" "),[k.deleted,"deleted"].join(" ")].join(", ")},initializeView:function(k){this._view=k},canCommit:function(){var l=this,k;k=(l.get("selectionCount")>0&&l.get("commentMessage")&&!l.get("isLoading"))||(l.get("isMerging")&&l.get("commentMessage")&&!l.get("isLoading"));return k},onCommit:function(){var m=this,l=m._getSelectionFileNames(true),k=m.get("commentMessage");m.set("isLoading",true);h.logOutputMessage(g.format("Commit: {0}\n",k)+l.join("\n"));j.Commit({workspaceName:iceConfiguration.solutionName,commentText:k,filePaths:l}).done($.proxy(m.onAfterCommit,m))}.attribute("track",{featureCategory:c.TrackingTags.featureCategory.VersionControl.name,featureName:c.TrackingTags.featureCategory.VersionControl.features.CommitChanges}),onAfterCommit:function(){var k=this;h.logOutputMessage("Commit Done.");j.Track().done($.proxy(k._onTrackResult,k))},canRevert:function(){var k=this;return(k.get("selectionCount")>0&&!k.get("isLoading"))},onRevert:function(){var m=this,k=m._getSelection(),l=f.filterPendingChangesBySelection(k);if(k===undefined||k.length===0){return}d.showFileListConfirmationDialog("Version Control Revert",{message:"Are you sure you want to revert these items?",fileList:l,accept:function(){j.RevertFiles(l).done(function(){m.set("isLoading",true);m.onAfterRevert()})}})}.attribute("track",{featureCategory:c.TrackingTags.featureCategory.VersionControl.name,featureName:c.TrackingTags.featureCategory.VersionControl.features.Revert}),onAfterRevert:function(){var k=this;h.logOutputMessage("Revert Done.");j.Track().done($.proxy(k._onTrackResult,k))},_onTrackResult:function(){var l=this;l.prepare();var k=j.GetRepositoryState();l.set("isMerging",k.CanCommit&&k.IsMerging);l.set("commentMessage",k.CommentText);l.set("isLoading",false);l._attemptClose()},_attemptClose:function(){var l=this,k=l.get("pendingChanges");if(k.length===0){l.closeDialog()}},_getSelectionFileNames:function(l){var n=this,k=$("#uncommitedFilesGrid"),m=[];$("input[type=checkbox]:"+(l?"checked":"not(:checked)"),n.gridContentSelector).each(function(q,r){var o=$(r).parent().parent(),p=n.pendingChangesGrid.dataItem(o);m.push(p.name)});return m},_getSelection:function(){var m=this,k=$("#uncommitedFilesGrid"),l=[];$("input[type=checkbox]:checked",m.gridContentSelector).each(function(p,q){var n=$(q).parent().parent(),o=m.pendingChangesGrid.dataItem(n);l.push(o)});return l},pendingSummary:function(){var q=this,k=0,o=0,p=0,m=0,l=q.get("pendingChanges");for(var n=0;n<l.length;n++){switch(l[n].changeType){case j.ChangeType.Added:k++;break;case j.ChangeType.Modified:o++;break;case j.ChangeType.Renamed:p++;break;case j.ChangeType.Deleted:m++;break;default:}}return[[k,"added"].join(" "),[o,"modified"].join(" "),[p,"renamed"].join(" "),[m,"deleted"].join(" ")].join(", ")}});return{getTemplate:function(){return a},getViewModel:function(){return new b()}}});