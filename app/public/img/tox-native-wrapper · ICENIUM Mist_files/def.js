(function(a){if(typeof exports=="object"&&typeof module=="object"){return exports.init=a}if(typeof define=="function"&&define.amd){return define({init:a})}tern.def={init:a}})(function(f,h){function g(r,s){return Object.prototype.hasOwnProperty.call(r,s)}var q=f.TypeParser=function(t,u,r,s){this.pos=u||0;this.spec=t;this.base=r;this.forceNew=s};q.prototype={eat:function(r){if(r.length==1?this.spec.charAt(this.pos)==r:this.spec.indexOf(r,this.pos)==this.pos){this.pos+=r.length;return true}},word:function(s){var t="",r,s=s||/[\w$]/;while((r=this.spec.charAt(this.pos))&&s.test(r)){t+=r;++this.pos}return t},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(x,A){var s=[],y=[];if(!this.eat(")")){for(var w=0;;++w){var t=this.spec.indexOf(": ",this.pos),r;if(t!=-1){r=this.spec.slice(this.pos,t);if(/^[$\w?]+$/.test(r)){this.pos=t+2}else{r=null}}y.push(r);s.push(this.parseType());if(!this.eat(", ")){this.eat(")")||this.error();break}}}var z,u,v;if(this.eat(" -> ")){if(A&&this.spec.indexOf("!",this.pos)>-1){z=h.ANull;u=this.parseRetType()}else{z=this.parseType()}}else{z=h.ANull}if(A&&(v=this.base)){h.Fn.call(this.base,x,h.ANull,s,y,z)}else{v=new h.Fn(x,h.ANull,s,y,z)}if(u){v.computeRet=u}return v},parseType:function(u,x){if(this.eat("fn(")){return this.parseFnType(u,x)}else{if(this.eat("[")){var t=this.parseType();this.eat("]")||this.error();if(x&&this.base){h.Arr.call(this.base,t);return this.base}return new h.Arr(t)}else{if(this.eat("+")){var v=this.word(/[\w$<>\.!]/);var r=m(v+".prototype");if(!(r instanceof h.Obj)){r=m(v)}if(!(r instanceof h.Obj)){return r}if(x&&this.forceNew){return new h.Obj(r)}return h.getInstance(r)}else{if(this.eat("?")){return h.ANull}else{var w=this.word(/[\w$<>\.!]/),s=h.cx();switch(w){case"number":return s.num;case"string":return s.str;case"bool":return s.bool;case"<top>":return s.topScope}if(s.localDefs&&w in s.localDefs){return s.localDefs[w]}return m(w)}}}}},parseBaseRetType:function(){if(this.eat("[")){var u=this.parseRetType();this.eat("]")||this.error();return function(w,t){return new h.Arr(u(w,t))}}else{if(this.eat("!")){var r=this.word(/\d/);if(r){r=Number(r);return function(t,w){return w[r]||h.ANull}}else{if(this.eat("this")){return function(t){return t}}else{if(this.eat("custom:")){var s=this.word(/[\w$]/);return c[s]||function(){return h.ANull}}else{this.error()}}}}}var v=this.parseType();return function(){return v}},extendRetType:function(r){var s=this.word(/[\w<>$!]/)||this.error();if(s=="!ret"){return function(w,t){var u=r(w,t);if(u.retval){return u.retval}var v=new h.AVal;u.propagate(new h.IsCallee(h.ANull,[],null,v));return v}}return function(u,t){return r(u,t).getProp(s)}},parseRetType:function(){var r=this.parseBaseRetType();while(this.eat(".")){r=this.extendRetType(r)}return r}};function n(v,u,r,s){var w=new q(v,null,r,s).parseType(u,true);if(/^fn\(/.test(v)){for(var t=0;t<w.args.length;++t){(function(y){var x=w.args[y];if(x instanceof h.Fn&&x.args&&x.args.length){a(w,function(z,B){var A=B[y];if(A){A.propagate(new h.IsCallee(h.cx().topScope,x.args,null,h.ANull))}})}})(t)}}return w}function a(r,s,u){var t=r.computeRet,v=r.retval;r.computeRet=function(z,w){var x=s(z,w);var y=t?t(z,w):v;return u?x:y}}var l=f.parseEffect=function(t,u){if(t.indexOf("propagate ")==0){var C=new q(t,10);var y=C.parseRetType();if(!C.eat(" ")){C.error()}var A=C.parseRetType();a(u,function(E,D){y(E,D).propagate(A(E,D))})}else{if(t.indexOf("call ")==0){var r=t.indexOf("and return ",5)==5;var C=new q(t,r?16:5);var w=C.parseRetType(),z=null,v=[];if(C.eat(" this=")){z=C.parseRetType()}while(C.eat(" ")){v.push(C.parseRetType())}a(u,function(I,D){var F=w(I,D);var J=z?z(I,D):h.ANull,E=[];for(var G=0;G<v.length;++G){E.push(v[G](I,D))}var H=r?new h.AVal:h.ANull;F.propagate(new h.IsCallee(J,E,null,H));return H},r)}else{if(t.indexOf("custom ")==0){var s=c[t.slice(7).trim()];if(s){a(u,s)}}else{if(t.indexOf("copy ")==0){var C=new q(t,5);var x=C.parseRetType();C.eat(" ");var B=C.parseRetType();a(u,function(F,D){var E=x(F,D),G=B(F,D);E.forAllProps(function(I,J,H){if(H&&I!="<i>"){G.propagate(new h.PropHasSubset(I,J))}})})}else{throw new Error("Unknown effect type: "+t)}}}}};var b;var m=f.parsePath=function(A){var u=h.cx(),t=u.paths[A],y=A;if(t!=null){return t}u.paths[A]=h.ANull;var s=b||u.topScope;if(u.localDefs){for(var x in u.localDefs){if(A.indexOf(x)==0){if(A==x){return u.paths[A]=u.localDefs[A]}if(A.charAt(x.length)=="."){s=u.localDefs[x];A=A.slice(x.length+1);break}}}}var z=A.split(".");for(var w=0;w<z.length&&s!=h.ANull;++w){var B=z[w];if(B.charAt(0)=="!"){if(B=="!proto"){s=(s instanceof h.Obj&&s.proto)||h.ANull}else{var v=s.getFunctionType();if(!v){s=h.ANull}else{if(B=="!ret"){s=v.retval.getType()||h.ANull}else{var r=v.args[Number(B.slice(1))];s=(r&&r.getType())||h.ANull}}}}else{if(s instanceof h.Obj){var C=s.props[B];if(!C||C.isEmpty()){s=h.ANull}else{s=C.types[0]}}}}u.paths[y]=s==h.ANull?null:s;return s};function e(r){var s=Object.create(r.prototype);s.props=Object.create(null);s.isShell=true;return s}function k(s){if(!s["!type"]){return false}for(var r in s){if(r!="!type"&&r!="!doc"&&r!="!url"&&r!="!span"){return false}}return true}function o(r,w,u){if(!r){var x=w["!type"];if(x){if(/^fn\(/.test(x)){r=e(h.Fn)}else{if(x.charAt(0)=="["){r=e(h.Arr)}else{throw new Error("Invalid !type spec: "+x)}}}else{if(w["!stdProto"]){r=h.cx().protos[w["!stdProto"]]}else{r=e(h.Obj)}}r.name=u}for(var t in w){if(g(w,t)&&t.charCodeAt(0)!=33){var s=w[t];if(typeof s=="string"||k(s)){continue}var v=r.defProp(t);o(v.getType(),s,u?u+"."+t:t).propagate(v)}}return r}function p(r,C,z){if(r.isShell){delete r.isShell;var D=C["!type"];if(D){n(D,z,r)}else{var A=C["!proto"]&&n(C["!proto"]);h.Obj.call(r,A instanceof h.Obj?A:true,z)}}var t=C["!effects"];if(t&&r instanceof h.Fn){for(var u=0;u<t.length;++u){l(t[u],r)}}for(var y in C){if(g(C,y)&&y.charCodeAt(0)!=33){var v=C[y],x=r.defProp(y),w=z?z+"."+y:y;var E=x.getType();if(typeof v=="string"){if(E){continue}n(v,w).propagate(x)}else{if(!k(v)){p(E,v,w)}else{if(!E){n(v["!type"],w,null,true).propagate(x);E=x.getType()}else{continue}}var s=v["!doc"],F=v["!url"],B=v["!span"];if(s){if(E&&E instanceof h.Obj){E.doc=s}x.doc=s}if(F){if(E&&E instanceof h.Obj){E.url=F}x.url=F}if(B){if(E&&E instanceof h.Obj){E.span=B}x.span=B}}}}}function d(s,v){var r=h.cx();h.addOrigin(r.curOrigin=s["!name"]||"env#"+r.origins.length);r.loading=s;r.localDefs=r.definitions[r.curOrigin]=Object.create(null);o(v,s);var t=s["!define"];if(t){for(var u in t){var w=t[u];r.localDefs[u]=typeof w=="string"?m(w):o(null,w,u)}for(var u in t){var w=t[u];if(typeof w!="string"){p(r.localDefs[u],t[u],u)}}}p(v,s);r.curOrigin=r.loading=r.localDefs=null}f.load=function(r,t){if(!t){t=h.cx().topScope}var s=b;b=t;try{d(r,t)}finally{b=s}};var c=Object.create(null);h.registerFunction=function(s,r){c[s]=r};var j=h.constraint("created, target, spec",{addType:function(w){if(w instanceof h.Obj&&this.created++<5){var s=new h.Obj(w),v=this.spec;if(v instanceof h.AVal){v=v.getType()}if(v instanceof h.Obj){for(var u in v.props){var r=v.props[u].types[0];var t=s.defProp(u);if(r&&r instanceof h.Obj&&r.props.value){var x=r.props.value.getType();if(x){t.addType(x)}}}}this.target.addType(s)}}});h.registerFunction("Object_create",function(r,t,s){if(s&&s.length&&s[0].type=="Literal"&&s[0].value==null){return new h.Obj()}var u=new h.AVal;if(t[0]){t[0].propagate(new j(0,u,t[1]))}return u});var i=h.constraint("args, target",{addType:function(s){if(!(s instanceof h.Fn)){return}var r=Math.max(0,this.args.length-1);this.target.addType(new h.Fn(s.name,this.args[0]||h.ANull,s.args.slice(r),s.argNames.slice(r),s.retval))}});h.registerFunction("Function_bind",function(t,r){var s=new h.AVal;t.propagate(new i(r,s));return s});h.registerFunction("Array_ctor",function(r,s){var t=new h.Arr;if(s.length!=1||!s[0].hasType(h.cx().num)){var u=t.getProp("<i>");for(var v=0;v<s.length;++v){s[v].propagate(u)}}return t});return f});