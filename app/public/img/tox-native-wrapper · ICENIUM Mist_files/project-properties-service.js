define(function(y){var m,o,j=y("kendo"),f=y("modules/core/helpers"),d=y("modules/workspace/cordova-service"),C=y("modules/version-control/version-control-service"),B=y("modules/workspace/solution-settings-service"),k=y("modules/core/navigation-service"),l=y("modules/project-navigator/project-navigator-module"),z=y("modules/core/rest-proxy"),A=z.init(window.location.host,serviceConfiguration.backendServiceScheme),h=y("text!./data/ios-background-modes.json"),i=y("text!./data/ios-icons.json"),b=y("text!./data/android-icons.json");var c=window,a={RELOAD_SOLUTION_REQUESTED:"reloadSolutionRequested",GROUP_NAME_GENERAL:{id:"general",displayName:"General"},GROUP_NAME_IOS_GENERAL:{id:"ios-general",displayName:"iOS"},GROUP_NAME_IOS_ICONS:{id:"ios-icons",displayName:"Icons"},GROUP_NAME_IOS_SPLASH_SCREENS:{id:"ios-splash-screens",displayName:"Splash Screens"},GROUP_NAME_ANDROID_GENERAL:{id:"android-general",displayName:"Android"},GROUP_NAME_ANDROIND_PERMISSIONS:{id:"android-permissions",displayName:"Permissions"},GROUP_NAME_PLUGINS:{id:"cordova-plugins",displayName:"Plugins"}};i=f.ensureJSON(i);h=f.ensureJSON(h);function e(F,E){var H=this,G=[];if(E===undefined){return[]}for(var D=0;D<E.length;D++){G.push(new g(F.solution.text,F.text,E[D].sizeText,E[D].text,E[D].uploadUrl,E[D].imageUrl))}return G}var g=j.Class.extend({init:function(G,E,F,H,J,D){var I=this;I.sizeText=F;I.text=H;I.uploadUrl=j.format("\\{0}\\{1}\\{2}",G,E,J);I.imageUrl=A.fileSystemService.getContent.url({path:j.format("/{0}/{1}/{2}",G,E,D)})},uploadImage:function(D){var E=this;return A.fileSystemService.save({path:E.uploadUrl,content:D})}});var s=j.data.ObservableObject.extend({events:{MODEL_CHANGED:"modelChanged"},id:"",displayName:"",parentGroup:null,isLoaded:false,dependentGroups:[],_dependencies:null,_isLoading:false,_project:null,_lastValues:null,init:function(E,D){var F=this;F._project=E;F._lastValues={};F._dependencies=D;j.data.ObservableObject.fn.init.apply(F,[]);F.bind("change",$.proxy(F.onChange,F))},onChange:function(D){var E=this;if(E._isLoading){return}else{E.trigger(E.events.MODEL_CHANGED,D)}},getProject:function(){var D=this;if(D._project===undefined){return null}return D._project},setProject:function(D){var E=this;E._project=D},getProjectProperties:function(){var E=this,D=E.getProject();if(D!==null){return D.properties}else{return{}}},saveData:function(E){var F=this,D=$.Deferred();$.when(F._save()).done(function(){F._notifyVersionControl();D.resolve()});return D.promise()},loadData:function(E){var F=this,D=$.Deferred();F._isLoading=true;if(F.get("isLoaded")&&!E){F._isLoading=false;D.resolve()}else{$.when(F._load()).done(function(){F.set("isLoaded",true);F._isLoading=false;D.resolve()})}return D.promise()},_save:function(){return true},_load:function(){return true},_saveProperty:function(E){var G=this,F,D=$.Deferred();if(G._propertyNamesMap===undefined||G._propertyNamesMap[E]===undefined||!G._isChanged(E)){D.resolve(false);return D.promise()}F=G._propertyNamesMap[E];l.solutionController.setItemProperty(F,G.getProject(),G.get(E),function(){G._syncProjectProperty(E);D.resolve(true)});return D.promise()},_syncProjectProperty:function(D,F){var G=this,E;if(G.getProject()===null||G._propertyNamesMap===undefined||G._propertyNamesMap[D]===undefined){return}E=G._propertyNamesMap[D];if(F===undefined){F=G.get(D)}G.getProject().properties[E]=F},_notifyVersionControl:function(){C.Track()},_isChanged:function(D){var E=this;if((E._lastValues===undefined||E._lastValues[D]===undefined||E._lastValues[D]!==E.get(D))){return true}return false},_storeLastValues:function(){}});var u=s.extend({id:a.GROUP_NAME_GENERAL.id,displayName:a.GROUP_NAME_GENERAL.displayName,appVersion:"",applicationIdentifier:"",cordovaVersion:"",cordovaVersions:null,deviceOrientations:"",_propertyNamesMap:{appVersion:"BundleVersion",applicationIdentifier:"AppIdentifier",deviceOrientations:"DeviceOrientations",cordovaVersion:"FrameworkVersion"},_load:function(){var F=this,D=$.Deferred(),E=F.getProjectProperties();d.getCordovaVersionsLoadedPromise().done(function(){F.set("appVersion",E.BundleVersion||"1.0");F.set("cordovaVersions",d.cordovaVersions());F.set("applicationIdentifier",E.AppIdentifier||"");F.set("cordovaVersion",E.FrameworkVersion||"");F.set("deviceOrientations",E.DeviceOrientations||"");F._storeLastValues();D.resolve()});return D.promise()},_save:function(){var E=this,D=$.Deferred();$.when(E._saveProperty("appVersion"),E._saveProperty("applicationIdentifier"),E._saveProperty("deviceOrientations"),E._saveCordovaVersion()).done(function(){E._storeLastValues();D.resolve(true)});return D.promise()},_saveCordovaVersion:function(){var G=this,E=$.Deferred(),F="cordovaVersion",D=G.get(F);if(!G._isChanged("cordovaVersion")){return}A.cordovaService.migrate({solutionName:G.getProject().solution.text,projectName:G._project.text,targetVersion:D}).done(function(){G._syncProjectProperty(F);l.solutionController.changeCordovaVersion();if(G._lastValues[F]&&G._lastValues[F].startsWith("2")&&G.cordovaVersion.startsWith("3")){G.trigger(a.RELOAD_SOLUTION_REQUESTED)}E.resolve(true)});return E.promise()},_storeLastValues:function(){var D=this;D._lastValues.appVersion=D.get("appVersion");D._lastValues.cordovaVersion=D.get("cordovaVersion");D._lastValues.applicationIdentifier=D.get("applicationIdentifier");D._lastValues.deviceOrientations=D.get("deviceOrientations")}});var v=s.extend({id:a.GROUP_NAME_IOS_GENERAL.id,displayName:a.GROUP_NAME_IOS_GENERAL.displayName,iOSStatusBarStyle:"",iOSDisplayName:"",iOSDeviceFamily:"",iOSBackgroundMode:"",codeSignIdentity:null,codeSignIdentitiesList:null,_propertyNamesMap:{iOSDisplayName:"iOSDisplayName",iOSStatusBarStyle:"iOSStatusBarStyle",iOSDeviceFamily:"iOSDeviceFamily",iOSBackgroundMode:"iOSBackgroundMode"},_load:function(){var H=this,D,E,F=$.Deferred(),G=H.getProjectProperties();B.getSolutionSettingsLoadedPromise().done(function(){D=B.getCodeSigningIdentities(c.DevicePlatforms.iOS,G.AppIdentifier||"");E=H._getCodeSignIdentity(D);H.set("iOSStatusBarStyle",G.iOSStatusBarStyle||"");H.set("iOSDisplayName",G.iOSDisplayName||"");H.set("iOSBackgroundMode",G.iOSBackgroundMode||"");H.set("iOSDeviceFamily",G.iOSDeviceFamily||"");H.set("codeSignIdentitiesList",D);H.set("codeSignIdentity",E);H._storeLastValues();F.resolve()});return F.promise()},_save:function(){var E=this,D=$.Deferred();$.when(E._saveProperty("iOSStatusBarStyle"),E._saveProperty("iOSDisplayName"),E._saveProperty("iOSBackgroundMode"),E._saveProperty("iOSDeviceFamily"),E._updateCodeSignIdentitySelect()).done(function(){E._storeLastValues();D.resolve(true)});return D.promise()},_updateCodeSignIdentitySelect:function(D){var F=this,E=F.get("codeSignIdentity");if(E===undefined||!F._isChanged(E)){return true}return B.updateCodeSigningIdentity(F.getProject().getProjectIdentifier(),c.DevicePlatforms.iOS,E.cryptographicIdentityId,E.provisionId)},_getCodeSignIdentity:function(D){var I=this,H=I.getProjectProperties(),G=I.getProject().getProjectIdentifier(),E=B.getSelectedCodeSignIdentity(H.AppIdentifier,G,c.DevicePlatforms.iOS);for(var F=0;F<D.length;F++){if(D[F].provisionId===E.provisionId&&D[F].cryptographicIdentityId===E.cryptographicIdentityId){return D[F]}}},_storeLastValues:function(){var D=this;D._lastValues.iOSStatusBarStyle=D.get("iOSStatusBarStyle");D._lastValues.iOSDisplayName=D.get("iOSDisplayName");D._lastValues.iOSBackgroundMode=D.get("iOSBackgroundMode");D._lastValues.iOSDeviceFamily=D.get("iOSDeviceFamily");D._lastValues.codeSignIdentities=D.get("codeSignIdentities");D._lastValues.selectedCodeSignIdentity=D.get("selectedCodeSignIdentity")}});var w=s.extend({id:a.GROUP_NAME_IOS_ICONS.id,displayName:a.GROUP_NAME_IOS_ICONS.displayName,iPhoneIconsIOs6List:null,iPhoneIconsIOs7List:null,iPadIconsIOs6List:null,iPadIconsIOs7List:null,spotlightSearchResultsIconsIPhoneIOs6List:null,spotlightSearchResultsIconsIPadIOs6List:null,spotlightSearchResultsIconsIOs7List:null,_load:function(){var E=this,D=E.getProject();E.set("iPhoneIconsIOs6List",e(D,i.iPhoneIconsIOs6));E.set("iPhoneIconsIOs7List",e(D,i.iPhoneIconsIOs7));E.set("iPadIconsIOs6List",e(D,i.iPadIconsIOs6));E.set("iPadIconsIOs7List",e(D,i.iPadIconsIOs7));E.set("spotlightSearchResultsIconsIPhoneIOs6",e(D,i.spotlightSearchResultsIconsIPhoneIOs6));E.set("spotlightSearchResultsIconsIPadIOs6",e(D,i.spotlightSearchResultsIconsIPadIOs6));E.set("spotlightSearchResultsIconsIOs7List",e(D,i.spotlightSearchResultsIconsIOs7));return true}});var x=s.extend({id:a.GROUP_NAME_IOS_SPLASH_SCREENS.id,displayName:a.GROUP_NAME_IOS_SPLASH_SCREENS.displayName,iPhoneSplashScreensList:null,iPadSplashScreensList:null,_load:function(){var E=this,D=E.getProject();E.set("iPhoneSplashScreensList",e(D,i.iPhoneSplashScreens));E.set("iPadSplashScreensList",e(D,i.iPadSplashScreens));return true}});var q=s.extend({id:a.GROUP_NAME_ANDROID_GENERAL.id,displayName:a.GROUP_NAME_ANDROID_GENERAL.displayName,androidVersionCode:"",androidHardwareAcceleration:"",permissionsList:null,androidIconsList:null,androidSplashScreensList:null,_propertyNamesMap:{androidVersionCode:"AndroidVersionCode",androidHardwareAcceleration:"AndroidHardwareAcceleration"},_load:function(){var G=this,D,E=G.getProject(),F=G.getProjectProperties();if(F.AndroidHardwareAcceleration==="True"){D=true}else{D=false}G.set("androidVersionCode",F.AndroidVersionCode||"1");G.set("androidHardwareAcceleration",D);G.set("androidIconsList",e(E,b.androidIcons));G.set("androidSplashScreensList",e(E,b.androidSplashScreens));G._storeLastValues();return true},_save:function(){var E=this,D=$.Deferred();$.when(E._saveProperty("androidVersionCode"),E._saveProperty("androidHardwareAcceleration")).done(function(){E._storeLastValues();D.resolve(true)});return D.promise()},_storeLastValues:function(){var D=this;D._lastValues.androidVersionCode=D.get("androidVersionCode");D._lastValues.androidHardwareAcceleration=D.get("androidHardwareAcceleration")}});var r=s.extend({id:a.GROUP_NAME_ANDROIND_PERMISSIONS.id,displayName:a.GROUP_NAME_ANDROIND_PERMISSIONS.displayName,_propertyNamesMap:{permissionsList:"AndroidPermissions"},_load:function(){var D=this;D.set("permissionsList",D._getPermissionsList());return true},_save:function(){var H=this,D=$.Deferred(),G,F="permissionsList",E=H.get(F);G=$.map(E,function(I){if(I.selected){return I}});l.solutionController.setAndroidPermissions(H.getProject(),G,function(I){H._syncProjectProperty(F,I);D.resolve()},true);return D.promise()},_getPermissionsList:function(){var I=this,H,G,E=[],F=I.getProject(),D=F.getPermissions()||{selected:[],remaining:[]};H=$.map(D.selected,function(J){J.selected=true;return J});G=$.map(D.remaining,function(J){J.selected=false;return J});E=H.concat(G);E.sort(function(J,K){if(J.Name<K.Name){return -1}else{if(J.Name>K.Name){return 1}else{return 0}}});return E}});var t=s.extend({id:a.GROUP_NAME_PLUGINS.id,displayName:a.GROUP_NAME_PLUGINS.displayName,pluginsGroups:null,dependentGroups:[a.GROUP_NAME_GENERAL.id],_propertyNamesMap:{selectedPluginsIdentifiers:"CorePlugins"},init:function(){var D=this;D.pluginsGroups={};s.fn.init.apply(D,arguments);D._dependencies.general.bind("change",function(E){if(E.field==="cordovaVersion"){D.loadData(true)}})},_load:function(){var E=this,D=$.Deferred();E._dependencies.general.loadData().done(function(){var F=E._dependencies.general.cordovaVersion;d.getPlugins(F).done(function(G){var H=E._getPluginsGroups(G);E.set("pluginsGroups",H);E._storeLastValues();D.resolve()})});return D.promise()},_save:function(){var E=this,D;D=E.getSelectedPluginsIdentifiers();E.selectedPluginsIdentifiers=D;E._saveProperty("selectedPluginsIdentifiers");return true},getSelectedPluginsIdentifiers:function(){var J=this,I=[],E=J.get("pluginsGroups"),F=E.corePlugins,D=E.advancedPlugins;for(var G=0;G<F.length;G++){if(F[G].selected===true){I.push(F[G].identifier)}}for(var H=0;H<D.length;H++){if(D[H].selected===true){I.push(D[H].identifier)}}return I.join(";")},_getPluginsGroups:function(E){var M=this,J,K,I,H,F=[],D=[],L=M.getProject().getUsedPluginsIdentification(E);for(var G=0;G<E.length;G++){J=E[G],I=false,H=J.identifier;if(L.indexOf(H)!==-1){I=true}K={identifier:H,name:J.name,version:J.version,platform:J.platform,description:J.description,docAddress:J.docAddress,selected:I,xmlUri:M.getPluginXmlUrl(H)};if(K.identifier.startsWith("org.apache.cordova")){K.isAdvanced=false;F.push(K)}else{K.isAdvanced=true;D.push(K)}}return{advancedPlugins:D,corePlugins:F}},getPluginXmlUrl:function(D){var F=this,G="/plugins/"+D+"/plugin.xml",E=k.getMobileFileAddress(F._project.text,G,null,F._dependencies.general.cordovaVersion);return E}});var n=j.Observable.extend({properties:null,consts:a,events:{NEW_MODEL_INSTANCIATED:"newModelInstanciated"},init:function(){var D=this;D.properties={};j.Observable.fn.init.apply(D,arguments)},getAllProperties:function(K){var M=this,L,G,H,I,J,D,E,F;G=M.getPropertyGroup(a.GROUP_NAME_GENERAL.id,K);H=M.getPropertyGroup(a.GROUP_NAME_IOS_GENERAL.id,K);I=M.getPropertyGroup(a.GROUP_NAME_IOS_ICONS.id,K);J=M.getPropertyGroup(a.GROUP_NAME_IOS_SPLASH_SCREENS.id,K);D=M.getPropertyGroup(a.GROUP_NAME_ANDROID_GENERAL.id,K);E=M.getPropertyGroup(a.GROUP_NAME_ANDROIND_PERMISSIONS.id,K);F=M.getPropertyGroup(a.GROUP_NAME_PLUGINS.id,K);L=[G,H,I,J,D,E,F];return L},getPropertyGroup:function(E,H){var K=this,I,D,G,J=[u,v,w,x,q,r,t];if(K.properties[E]!==undefined){return K.properties[E]}for(var F=0;F<J.length;F++){I=J[F];if(I.prototype.id===E){D=K.getDependencies(I.prototype.dependentGroups,H);G=new I(H,D);K.properties[E]=G;K.trigger(K.events.NEW_MODEL_INSTANCIATED,G);return G}}return null},getDependencies:function(D,H){var I=this,F="",E={};for(var G=0;G<D.length;G++){F=D[G];E[F]=I.getPropertyGroup(F,H)}return E}});m=new n();var p=j.Observable.extend({init:function(){var F=this,E,D;m.bind(m.events.NEW_MODEL_INSTANCIATED,$.proxy(F.handleNewModule,F));l.solutionService.bind(c.SOLUTION_OPENED,function(G){E=G.solution.getMobileProject();D=m.properties;for(var H in D){D[H].setProject(E);D[H].loadData(true)}})},handleNewModule:function(D){D.bind(a.RELOAD_SOLUTION_REQUESTED,function(){l.solutionController.reloadSolution()})}});o=new p();return m});