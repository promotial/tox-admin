define(function(k){var b=k("modules/core/base-classes"),e=k("modules/core/core-module"),c=k("modules/core/base-commands"),q=k("modules/view-pane/view-pane-service"),l=k("modules/workspace/solution-frame-service"),i=k("dom!viewPaneNavigationRegion"),n=k("text!./view-pane-navigation-template.html"),m=k("text!./view-pane-navigation-item-template.html"),a={VIEW_NAVIGATION_SCROLL_LEFT:"navigationScrollLeft",VIEW_NAVIGATION_SCROLL_RIGHT:"navigationScrollRight"};var d=window;var p=e.ViewRendererBase.extend({init:function(){var r=this;e.ViewRendererBase.fn.init.apply(r,arguments);r.openedTabsQueue=[];r._pane=$("#"+d.VIEWPANE_NAVIGATOR_REGION)},bind:function(r){var s=this;s.viewModel=r.viewModel;s.viewModel.bind(a.VIEW_NAVIGATION_SCROLL_LEFT,$.proxy(s.scrollLeft,s));s.viewModel.bind(a.VIEW_NAVIGATION_SCROLL_RIGHT,$.proxy(s.scrollRight,s));s.viewModel.bind(d.VIEW_OPENED,$.proxy(s.onViewOpened,s));s.viewModel.bind(d.VIEW_CLOSED,$.proxy(s.onViewClosed,s));s.viewModel.bind(d.VIEW_ACTIVATED,$.proxy(s.onViewActivated,s));s.viewModel.bind(d.VIEW_LOADED,$.proxy(s.onViewLoaded,s));s.viewModel.bind(d.VIEW_KEY_CHANGE,$.proxy(s.onFilePathChanged,s));s.viewModel.bind(d.CENTER_SPLITTER_RESIZE,$.proxy(s.initializeScrolling,s));s.view=r.view;s.tabStrip=$(s.view).find("#viewPaneTabStrip").data("kendoTabStrip");s.tabStrip.element.on("mousedown",".k-close",function(t){var u=$(this).closest("li").index();q.closeByIndex(u);t.preventDefault()});s.tabStrip.element.on("mousedown",".k-item",function(u){var t;if(u.which===2){u.preventDefault();t=s._findTabElement(u.target);q.closeByIndex(s._tabIndexOf(t))}})},onViewOpened:function(s){var u=this,r,t=u.tabStrip;t.append({text:""});r=u._getTabElement(u._getTabsCount()-1);e.viewRenderer.renderInside(m,s.viewItem,$(".k-link",r));r.data("view-item",s.viewItem);t.enable(r,false);u._enqueueTab(r);u.viewModel.set("openItemCount",u.viewModel.get("openItemCount")+1);u.initializeScrolling()},onViewClosed:function(s){var u=this,t,r=u._getTabElement(s.index);u.tabStrip.remove(r);u._dequeueTab(r);t=u._getNextTabToSelect();if(t&&u.tabStrip.select().length===0){u.tabStrip.select(t)}u.viewModel.set("openItemCount",u.viewModel.get("openItemCount")-1);u.initializeScrolling()},onViewLoaded:function(s){var t=this,r=t._getTabElement(s.index);t.tabStrip.enable(r,true)},onViewActivated:function(s){var t=this,r=t._getTabElement(s.index);t.tabStrip.select(r);t._enqueueExistingTab(r)},onFilePathChanged:function(s){var t=this,r=t._getTabElement(s.index);r.attr("title",s.newKey)},_getTabsCount:function(){return this.tabStrip.tabGroup.children("li").length},_getTabElement:function(r){return this.tabStrip.tabGroup.children("li").eq(r)},_tabIndexOf:function(r){return this.tabStrip.tabGroup.children("li").index($(r))},_findTabElement:function(r){return $(r).closest("li")},_enqueueTab:function(r){var s=this;s.openedTabsQueue.push(r[0])},_enqueueExistingTab:function(s){var t=this;if(s[0]===t.openedTabsQueue[t.openedTabsQueue.length-1]){return}for(var r=0;r<t.openedTabsQueue.length;r++){if(t.openedTabsQueue[r]===s[0]){t.openedTabsQueue.splice(r,1);break}}t._enqueueTab(s)},_dequeueTab:function(s){var t=this;if(s){var r=t.openedTabsQueue.indexOf(s[0]);if(r>=0){return t.openedTabsQueue.splice(r,1)}}if(t.openedTabsQueue.length===0){return}t.openedTabsQueue.splice(t.openedTabsQueue.length-1,1)},_getNextTabToSelect:function(){if(this.openedTabsQueue.length===0){return null}return this.openedTabsQueue[this.openedTabsQueue.length-1]},initializeScrolling:function(){var r=this;window.setTimeout(function(){var t=r.tabStrip,s;r.viewModel.set("paneWidth",r._pane.width());r.viewModel.set("tabStripWidth",t.element.width());s=(r.viewModel.get("tabStripWidth")>r.viewModel.get("paneWidth"));if(r.viewModel.get("notEnoughSpace")!==s){r.viewModel.set("notEnoughSpace",s);r.resetScroll()}r.viewModel._scrollButtonsWidth=r._pane.find("#scrollButtons").width()},1)},scrollLeft:function(){this.offSetTabStripItems(5)},scrollRight:function(){this.offSetTabStripItems(-5)},offSetTabStripItems:function(s){var v=this,r,u=v.getTabStripItems(),t=u.position();v.viewModel.set("offset",(t.left-v.viewModel._scrollButtonsWidth+s));u.css({left:v.viewModel.get("offset")});r=((v.viewModel.canScrollLeft()&&(s>0))||(v.viewModel.canScrollRight()&&(s<0)));if(r&&v.viewModel.get("isScrollingStarted")){window.setTimeout(function(){v.offSetTabStripItems(s)},15)}},getTabStripItems:function(){return this._pane.find("#viewPaneTabStrip ul")},resetScroll:function(){var r=this.getTabStripItems();r.css({left:0})}});var o=b.ViewModelBase.extend({_scrollButtonsWidth:0,paneWidth:0,tabStripWidth:0,scrollOffset:10,offset:0,isScrollingStarted:false,notEnoughSpace:false,openItemCount:0,init:function(){var r=this;b.ViewModelBase.fn.init.apply(r,arguments);q.bind(d.VIEW_OPENED,$.proxy(r.onViewOpened,r));q.bind(d.VIEW_CLOSED,$.proxy(r.onViewClosed,r));q.bind(d.VIEW_ACTIVATED,$.proxy(r.onViewActivated,r));q.bind(d.VIEW_LOADED,$.proxy(r.onViewLoaded,r));q.bind(d.VIEW_KEY_CHANGE,$.proxy(r.onFilePathChanged,r));l.bind(d.CENTER_SPLITTER_RESIZE,$.proxy(r.initializeScrolling,r))},onViewOpened:function(r){var s=this;s.trigger(d.VIEW_OPENED,{viewItem:r.viewItem})},onViewClosed:function(r){var s=this;s.trigger(d.VIEW_CLOSED,{index:r.index})},onViewActivated:function(r){var s=this;s.trigger(d.VIEW_ACTIVATED,{index:r.index})},onViewLoaded:function(r){var s=this;s.trigger(d.VIEW_LOADED,{index:r.index,type:r.type,key:r.key})},initializeScrolling:function(r){var s=this;s.trigger(d.CENTER_SPLITTER_RESIZE,{})},onFilePathChanged:function(r){var s=this;s.trigger(d.VIEW_KEY_CHANGE,{index:r.index,newKey:r.newKey})},onTabSelected:function(r){var s=this,t=$(r.item).data("view-item");q.activeItem(t)},scrollLeft:function(){var r=this;r.set("isScrollingStarted",true);r.trigger(a.VIEW_NAVIGATION_SCROLL_LEFT,{})},scrollRight:function(){var r=this;r.set("isScrollingStarted",true);r.trigger(a.VIEW_NAVIGATION_SCROLL_RIGHT,{})},stopScroll:function(){var r=this;r.set("isScrollingStarted",false)},canScrollLeft:function(){var r=this;return(r.get("offset")<0)},canScrollRight:function(){var s=this,r=s.get("tabStripWidth")+s.get("offset")+s._scrollButtonsWidth;return(r+s.get("scrollOffset")>s.get("paneWidth"))}});var g=c.CommandBase.extend({init:function(){c.CommandBase.fn.init.apply(this,arguments)},canExecute:function(){return(q.activeItem()?true:false)}});var h={CloseTabCommand:g.extend({init:function(){g.fn.init.apply(this,arguments)},execute:function(){q.closeActive()}}),CloseAllTabsCommand:g.extend({init:function(){g.fn.init.apply(this,arguments)},execute:function(){q.saveModifiedItemsWithConfirmation().done(function(){q.closeAll()})}}),SelectNextTabCommand:g.extend({init:function(){g.fn.init.apply(this,arguments)},execute:function(){q.activateNextItem(+1)}}),SelectPrevTabCommand:g.extend({init:function(){g.fn.init.apply(this,arguments)},execute:function(){q.activateNextItem(-1)}})};function j(){e.commandService.registerCommand(new h.CloseTabCommand(d.COMMAND_CLOSE_TAB,"Close Tab",[d.CODE_EDITOR_COMMANDS],[{region:d.VIEWPANE_REGION,keyShortcut:{modifiers:[d.KEY_CTRL],keys:[d.KEY_Q],keysOSX:[d.KEY_W]}}])).registerCommand(new h.CloseAllTabsCommand(d.COMMAND_CLOSE_ALL_TABS,"Close All Tabs",[d.CODE_EDITOR_COMMANDS],[{region:d.VIEWPANE_REGION,keyShortcut:{modifiers:[d.KEY_CTRL,d.KEY_SHIFT],keys:[d.KEY_Q],keysOSX:[d.KEY_W]}}])).registerCommand(new h.SelectNextTabCommand(d.COMMAND_SELECT_NEXT_TAB,"Select Next Tab",[d.CODE_EDITOR_COMMANDS],[{region:d.VIEWPANE_REGION,keyShortcut:{modifiers:[d.KEY_CTRL],keys:[d.KEY_GRAVE_ACCENT],preventDefaultBrowserAction:true}}])).registerCommand(new h.SelectPrevTabCommand(d.COMMAND_SELECT_NEXT_TAB,"Select Previous Tab",[d.CODE_EDITOR_COMMANDS],[{region:d.VIEWPANE_REGION,keyShortcut:{modifiers:[d.KEY_CTRL,d.KEY_SHIFT],keys:[d.KEY_GRAVE_ACCENT],preventDefaultBrowserAction:true}}]))}function f(){var r=new p();e.loaderService.triggerEvent(d.VIEWPANE_NAVIGATION_LOADED);r.render(n,new o(),i);j()}f()});