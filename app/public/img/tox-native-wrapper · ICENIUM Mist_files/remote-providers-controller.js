define(function(l){var h,g=l("kendo"),b=l("modules/core/core-module"),d=l("modules/core/dialog-service"),e=l("modules/version-control/remote-providers-service"),j=l("modules/version-control/oauth-services"),k=l("modules/version-control/remote-providers-modules"),n=l("text!../workspace-operations/wizard-dialog-template.html"),f=l("text!./remote-providers-index-template.html"),c=l("text!./remote-providers-create-repo-template.html"),a=l("text!./remote-providers-auth-template.html"),m=l("text!./remote-providers-success.html");var i=g.Observable.extend({remoteUrl:"",wizardPages:{index:{model:k.IndexPageViewModel,template:f},authgithub:{model:k.GitHubAuthViewModel,template:a},github:{model:k.GitHubViewModel,template:c},success:{model:k.SuccessViewModel,template:m}},init:function(){var o=this;o._pages=[];o._currentPage=null;g.Observable.fn.init.apply(o,arguments)},selectIndex:function(){var o=this;o.selectPage({key:"index",data:o.remoteUrl})},selectPage:function(o,p){var u=this,s=o.key||o,q=o.data||p;if(u._currentPage){u._currentPage.element.hide()}if(s==="index"){q=u.remoteUrl}var v=b.viewRenderer,r=$("<div>"),t={};t.model=new u.wizardPages[s].model(u.pageHostViewModel,q);t.element=r;$("#wiz-pages").append(r);v.render(u.wizardPages[s].template,t.model,r);u._pages[s]=t;u._currentPage=u._pages[s];u._currentPageKey=s;u._initModule(t.model,s);u._subscribeToEvents(t.model,s)},_initModule:function(p,o){var q=this;switch(o){case"authgithub":q._authFlow("github");break;case"github":q.loadGitHubRepos(p);break;default:}},_subscribeToEvents:function(p,o){var q=this;switch(o){case"index":q.pageHostViewModel.unbind(p.events.VERSION_CONTROL_VALIDATE_GITURL);q.pageHostViewModel.unbind(p.events.VERSION_CONTROL_REMOVE_REMOTE_REPO);q.pageHostViewModel.bind(p.events.VERSION_CONTROL_VALIDATE_GITURL,$.proxy(q._validateRemoteRepo,q));q.pageHostViewModel.bind(p.events.VERSION_CONTROL_REMOVE_REMOTE_REPO,$.proxy(q.setRemoteRepo,q));break;case"authgithub":q.pageHostViewModel.unbind(p.events.VERSION_CONTROL_VALIDATE_CREDENTIALS);q.pageHostViewModel.bind(p.events.VERSION_CONTROL_VALIDATE_CREDENTIALS,$.proxy(q._validateGitHubCredentials,q));break;case"github":q.pageHostViewModel.unbind(p.events.VERSION_CONTROL_SET_REMOTE_REPO);q.pageHostViewModel.unbind(p.events.VERSION_CONTROL_CREATE_REPO);q.pageHostViewModel.bind(p.events.VERSION_CONTROL_SET_REMOTE_REPO,$.proxy(q.setRemoteRepo,q));q.pageHostViewModel.bind(p.events.VERSION_CONTROL_CREATE_REPO,$.proxy(q.createGitHubRepo,q));break;default:}},_subscribeHostViewModelToEvents:function(p,o){var q=this;q.pageHostViewModel.bind(q.pageHostViewModel.events.VERSION_CONTROL_SELECT_PAGE,$.proxy(q.selectPage,q));q.pageHostViewModel.bind(q.pageHostViewModel.events.ERROR_SET_REMOTE,function(){d.showMessageBox("Icenium","An error occured while setting remote repository url.")})},_authFlow:function(o){var p=this;j.isUserAuthenticated(o).done(function(){p.selectPage(o)}).fail(function(){p._currentPage.model.showError("Cannot authenticate with GitHub with the currently stored credentials.")})},_validateGitHubCredentials:function(o){var r=this,p=o.credentials,s=o.viewModel,q=o.storeCredentials;j.validateGitHubCredentials(p).done(function(t){r._onUserAuthGitHub(q,p)}).fail(function(t){s.validCredentials=false;s.validator.validate()})},_onUserAuthGitHub:function(p,o){var q=this;if(p){j.storeCredentials("github",o)}q.selectPage("github")},_validateRemoteRepo:function(o){var r=this,q=o.remoteRepoUrl,s=o.viewModel;if(q===null||q===""){s.validCredentials=false;s.validator.validate();return}var p=e.getProviderByUrl(q);if(p!==null){s.validGitUrl=true;s.validator.validate();r.setRemoteRepo({remoteRepoUrl:q})}else{s.validGitUrl=false;s.validator.validate()}},setRemoteRepo:function(o){var r=this,q=o.remoteRepoUrl,p=o.inviteCollaboratorsUrl;b.server.versionControlService.setRemote({workspaceName:iceConfiguration.solutionName,remoteUrl:q}).done(function(){r.remoteUrl=q;if(r._currentPageKey==="index"){r._currentPage.model.updateUI()}else{r.selectPage("success",{inviteCollaboratorsUrl:p})}}).fail(function(s){r._currentPage.model.showError("Error Setting Remote Repository.")})},loadGitHubRepos:function(p){var o=this;j.getGitHubRepositories().done(function(q){if(q){p.set("gitRepoList",new g.data.DataSource({data:q}));p.set("gitRepoListLoading",false)}}).fail(function(q){o._currentPage.model.showError("Error Loading Repositories.")})},createGitHubRepo:function(o){var s=this,q=o.repoName,p=o.repoDescription,r=o.repoPrivate;j.createGitHubRepo(q,p,r).done(function(t){s.setRemoteRepo({remoteRepoUrl:t.cloneUrl,inviteCollaboratorsUrl:t.inviteCollaboratorsUrl})}).fail(function(t){s._currentPage.model.showError(t)})},showConfigRemoteRepoDialog:function(o){var q=this,p=$(n),r=new k.ConfigureRemoteRepoViewModel(o,q.wizardPages);q.remoteUrl=o;q.pageHostViewModel=r;d.showModalDialog("Configure Remote Repository",{template:p,viewModel:r});q.selectIndex();q._subscribeHostViewModelToEvents();return r.getPromise()}});h=new i();return h});