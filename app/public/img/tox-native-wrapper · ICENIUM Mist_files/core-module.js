define(function(A){var k={},q=A("kendo"),n=A("modules/core/helpers"),b=A("modules/core/base-commands"),G=A("./view-renderer"),h=A("./data-loss-protection-service"),x=A("./progress-service"),t=A("../logging/logging-service"),F=A("./user-settings-service"),i=A("./dialog-service"),E=A("modules/tracking/tracking-service"),B=A("./rest-proxy"),w=A("modules/notifications/notifications-service"),v=A("./navigation-service"),C=B.init(window.location.host,serviceConfiguration.backendServiceScheme);ice=ice||{};ice.server=C;k.server=C;var g=window,a={WEBSTORE_APP_MESSAGE:"Icenium is available in the Chrome Web Store. Click to add it to Chrome.",WEBSTORE_APP_TITLE:"Chrome Web Store Application"};var f=q.Observable.extend({init:function(){var e=this;q.Observable.fn.init.apply(e,arguments);e._categories={};e._commands=[]},registerCommand:function(I){var M=this;var e=I.categories();for(var J=0;J<e.length;J++){M.addToCategory(e[J],I)}k.keyBindingService.registerCommandInRegion(I);if(M._commands.indexOf(I)===-1){M._commands.push(I);M.trigger(g.COMMAND_REGISTERED,{command:I})}var L=I.getSubCommands();if(L&&L.length>0){for(var K=0;K<L.length;K++){k.keyBindingService.registerCommandInRegion(L[K])}}return M},addToCategory:function(I,J){var L=this;var e=L._categories[I];if(!e){e=new Array(g.COMMAND_ORDERINGS[I].length);L._categories[I]=e}if(e.indexOf(J)===-1){var K=g.COMMAND_ORDERINGS[I].indexOf(J.identifier);e[K]=J}},getCommandsByCategory:function(e){var I=this._categories[e];I=n.removeArrayPaddings(I);return(I)?I:[]},getCommandFromCategory:function(e,J){var I=this._categories[e],K=g.COMMAND_ORDERINGS[e].indexOf(J);return I[K]},getCategorizedCommands:function(){var e=this._categories;var J=[];for(var I in e){J.push({category:I,commands:n.removeArrayPaddings(e[I])})}return J}});var r=q.Observable.extend({init:function(){var e=this;q.Observable.fn.init.apply(e,arguments);e.regions={};e.focusedRegionName=null;e.matchingCommands=null;e.modalDialogCommands=null;e.keyQueue=[];$(document).bind("keydown",$.proxy(e.globalKeyHandler,e))},globalKeyHandler:function(I){var K=this;if(i&&i.isModalDialogShown()){K.modalDialogCommands=K.regions[g.GLOBAL_REGION].commands.slice()}else{K.modalDialogCommands=null}var J=K._prepareKeyPress(I);K._tryExecuteQueue(J,I)},registerCommandInRegion:function(e){var L=this;var K=e.regionSettings;for(var J in K){var I=L.regions[J];if(!I){I=L.regions[J]=new l(J,e);I.bind(g.REGION_FOCUSED,$.proxy(L.onRegionFocused,L))}else{I.commands.push(e)}}},clearRegionSelection:function(){this.onRegionFocused({})},focusRegion:function(e){this.onRegionFocused({name:e})},onRegionFocused:function(e){var K=this;var J=K.focusedRegionName;var I=e.name;if(J!==I){K.trigger(g.REGION_FOCUS_CHANGE,{oldRegionName:K.focusedRegionName,newRegionName:I});K.focusedRegionName=I;K.keyQueue.length=0}},getRegions:function(){var M=this.regions;var N=[];var I=function(U){var Q=U.commands;var V=[];var S=Q.length;if(Q&&S>0){for(var R=0;R<S;R++){var O=Q[R];var P=O.text;var T=O.getParent();if(T){P=T.text+"->"+P}V.push({commandName:P,shortcut:O.serializeRegionShortcut(U.regionId)})}}return V};for(var K in M){var J=M[K];var L="";switch(J.regionId){case g.GLOBAL_REGION:L="Global";break;case g.SOLUTION_MENU_REGION:L="Solution Menu";break;case g.BOTTOM_REGION:L="Bottom";break;case g.CODE_EDITOR_REGION:L="Code Editor";break;case g.VIEWPANE_REGION:L="View Pane Region";break;case g.PROJECT_NAVIGATOR_REGION:L="Project Navigator";break;case g.WORKSPACE_REGION:L="Dashboard";break;case g.WORKSPACE_BACK_REGION:L="Dashboard Back";break;case g.SENSORS_REGION:L="Sensors";break;case g.USER_MENU_REGION:L="User Menu";break;case g.VIEWPANE_NAVIGATOR_REGION:L="Document Navigation";break;case g.EVERLIVE_NAVIGATOR_REGION:L="Everlive Navigator";break;default:L="Unassigned to region";break}var e=I(J);if(e.length>0){N.push({regionName:L,commands:e})}}return N},_tryExecuteQueue:function(O,e){var T=this;var R=T.keyQueue;var N=R.length;var S=T.focusedRegionName;var Q=T.modalDialogCommands;var P=(Q)?Q:T.matchingCommands;var K;if(P){K=P}else{K=(S&&T.regions[S])?T.regions[S].commands.slice():[];K=(T.regions[g.GLOBAL_REGION])?K.concat(T.regions[g.GLOBAL_REGION].commands.slice()):K;P=T.matchingCommands=[]}for(var M=0;M<K.length;M++){var I=K[M];if(I.regionSettings[g.GLOBAL_REGION]){S=g.GLOBAL_REGION}var L=I.regionSettings[S];if(T._modifiersMatch(L.modifiers.slice(),O.modifiers.slice())&&L.keys[N]&&L.keys[N]===O.key){R.push(O);if(L.keys.length===(N+1)){if(L.preventDefaultBrowserAction){e.preventDefault()}T.keyQueue.length=0;P.length=0;T._executeCommand(I,S);break}else{P.push(I)}}else{var J=P.indexOf(I);if(J!==-1){P.splice(J,1)}}}if(P.length===0){T.matchingCommands=null}},_modifiersMatch:function(e,I){if(e.length!==I.length){return false}var L=true;for(var J=0;J<e.length;J++){var K=I.indexOf(e[J]);if(K===-1){L=false;break}else{I.splice(K,1)}}return L},_executeCommand:function(e,I){if((e.canExecute&&e.canExecute())||(!e.canExecute&&e.canExecuteCore)){e.execute();e.executeLogLambda(function(){E.logEvent(e.featureCategory,e.featureName+"[keyboard]")})}},_prepareKeyPress:function(I){var K={modifiers:[],key:I.keyCode},J=BrowserDetect.OS==="Mac";if(J&&I.metaKey){K.modifiers.push(g.KEY_CMD)}if(I.ctrlKey){K.modifiers.push(g.KEY_CTRL)}if(I.shiftKey){K.modifiers.push(g.KEY_SHIFT)}if(I.altKey){K.modifiers.push(g.KEY_ALT)}return K}});var l=q.Observable.extend({init:function(K,e){var L=this;q.Observable.fn.init.apply(L,[]);L.regionId=K;L.commands=[e];var I=L.handledEvent="mouseup";var J=L.eventHandler=$.proxy(L.clickHandler,L);$("#"+K).bind(I,J)},clickHandler:function(I){var J=this;J.trigger(g.REGION_FOCUSED,{name:J.regionId})},dispose:function(){var e=this;$("#"+e.regionId).unbind(e.handledEvent,e.eventHandler)}});var s=q.Observable.extend({init:function(){q.Observable.fn.init.apply(this,arguments)},triggerEvent:function(e){this.trigger(e)}});var H=q.Class.extend({init:function(){},render:function(J,K,I){var e=$(I).html(J);this.bindViewModel(K,I);return e},renderInside:function(J,K,I){var e=$(J);if(e.length!==1){e=$("<div>").append(e)}$(I).append(e);this.bindViewModel(K,e[0]);return e},bindViewModel:function(I,e){q.bind(e,I);this.bind({viewModel:I,view:e})},bind:function(e){}});var m=q.Observable.extend({init:function(){var e=this;q.Observable.fn.init.apply(e,arguments);e.regionAdapters={}},addItemToRegion:function(I,e){this.regionAdapters[I].addItem(e)},addItemsToRegion:function(J,I){for(var e=0;e<I.length;e++){this.addItemToRegion(J,I[e])}},registerRegionAdapter:function(J,e,I){var K=this;I=I||{};e.regionName=J;K.regionAdapters[J]=e;e.attachToElement($("#"+J),I);K.trigger(g.REGION_ADAPTER_REGISTERED,{regionName:J})},disposeRegionAdapter:function(e){this.regionAdapters[e].dispose();delete this.regionAdapters[e]},initializeCommands:function(I,e){var J=this;J.addItemsToRegion(I,k.commandService.getCommandsByCategory(e))},bindToRegionAdapterEvent:function(J,e,I){return this._bindingOperation("bind",J,e,I)},unbindFromRegionAdapterEvent:function(J,e,I){return this._bindingOperation("unbind",J,e,I)},initializeMenu:function(J,e,I){this._initRegionAdapter(u,J,e,I)},getRegionItem:function(K,I){var J=this.regionAdapters[K],e=null;if(J){e=J.getItemByText(I)}return(e)?e:null},_initRegionAdapter:function(L,K,e,I){var M=this;M.registerRegionAdapter(K,new L(),I);M.initializeCommands(K,e);var J=function(N){var O=N.command;if(O.hasCategory(e)){k.commandService.unbind(g.COMMAND_REGISTERED,J);k.frameService.disposeRegionAdapter(K);M._initRegionAdapter(L,K,e,I)}};k.commandService.bind(g.COMMAND_REGISTERED,J)},_bindingOperation:function(J,L,e,I){var K=this.regionAdapters[L];if(K){K[J](e,I);return true}return false}});var y=q.Observable.extend({init:function(){var e=this;q.Observable.fn.init.apply(e,arguments);e.panes={};e.adapterWidget=null},attachToElement:function(e){},addItem:function(e){},dispose:function(){$(this.adapterWidget.element).remove()}});var u=y.extend({init:function(){var e=this;y.fn.init.apply(e,arguments);e.adapterWidget=null},attachToElement:function(I,e){var L=this;var K=$("<ul></ul>").appendTo(I);var J=k.commandMenuService.buildMenu(K,e);J.bind(g.MENU_ITEM_CLICKING,$.proxy(L.onItemClicked,L));L.adapterWidget=J;$(J.element).data("commands",[]);$(J.element).data("configuration",e)},addItem:function(e){var P=this;var L=P.adapterWidget;var I=$(L.element).data("commands");var J=$(L.element).data("configuration");if(I.indexOf(e)===-1){var M=k.commandMenuService.addItem(L,null,true,e,J,P.regionName);I.push(e);var O=e.getSubCommands();for(var K=0;K<O.length;K++){var N=O[K];k.commandMenuService.addItem(L,M,true,N,J)}}},onItemClicked:function(e){this.trigger(g.MENU_ITEM_CLICKING,e)}});var D=y.extend({init:function(){y.fn.init.apply(this,arguments)},attachToElement:function(e){this.adapterWidget=$(e).kendoTabStrip({animation:false}).data("kendoTabStrip")},addItem:function(e){var K=this.adapterWidget;K.append({text:e.name,content:"&nbsp;"});var J=K.tabGroup;var I=J.children("li").length;$(K.contentElement(I-1)).append(e.element);K.select(J.children("li").eq(0))},getItemByText:function(J){var M=this.adapterWidget;var K=M.tabGroup;var L=K.children("li");var I=-1;for(var e=0;e<L.length;e++){if($(L[e]).text()===J){I=e;break}}return(I>-1)?M.contentElement(I):null}});var d=q.Observable.extend({init:function(){q.Observable.fn.init.apply(this,arguments)},buildMenu:function(J,e){var K=e.orientation||"horizontal";var I=e.cssClass;if(!J){J=$("<ul></ul>")}if(I){$(J).addClass(I)}return $(J).kendoMenu({select:this.onMenuItemClicked,open:this.onMenuOpen,orientation:K,closeOnClick:false}).data("kendoMenu")},buildContextMenu:function(I,Q,J){var U=this;var R=$("<div></div>").kendoPopup({collision:"fit"}).appendTo("body").data("kendoPopup");var O=$("<ul></ul>").addClass("k-context-menu").kendoMenu({orientation:"vertical",select:Q,animation:{open:{effects:"fadeIn",duration:200}},open:U.onMenuOpen,closeOnClick:false}).appendTo(R.element).data("kendoMenu");O.element.data("commands",I);for(var K=0;K<I.length;K++){var e=I[K];var M=e.isApplicable(J.dataItem);var P=null;if(M){P=U.addItem(O,null,M,e,J)}var T=e.getSubCommands();for(var N=0;N<T.length;N++){var S=T[N];var L=S.isApplicable(J.dataItem);if(L){U.addItem(O,P,L,S,J)}}}U.bind(g.CONTEXT_MENU_OPENING,function(){R.wrapper.hide()});O.openOn=function(V,W,X){U.trigger(g.CONTEXT_MENU_OPENING);R.options.anchor=V;R.open(W,X)};O.hideContextMenu=function(){O.close();R.wrapper.hide()};O.disposeContextMenu=function(){O.close();R.wrapper.remove();R.element.remove()};return O},addItem:function(P,R,L,I,J,U){var W=this;var Q=null;if(R){Q=R}else{W.initializeCommand(I);Q=P.element}var T="";var N=J.dontRenderText?"":I.text;if(I.regionSettings){for(var O in I.regionSettings){T=O;break}}var V="";if(T){V=I.serializeRegionShortcut(T)}if(V){P.append({text:N+"<div class='menu-item-shortcut-container'><span class='menu-item-shortcut'>"+V+"</span></div>",encoded:false},Q)}else{P.append({text:N,encoded:!I.renderAsHTML},Q)}var X=J.dontRenderText?I.text:"";var e=$("li:last",Q);e.attr("title",X);e.data("command",I);e.data("menu",P);e.data("configuration",J);e.data("regionName",U);if(L){e.show()}else{e.hide()}if(!I.renderAsHTML){W.addMenuItemClass(e,I.text,J)}var K=I.getCssClass();if(K){e.addClass(K)}var M=Q.children("li").length;if(J.selection&&(M===1)){e.addClass("k-state-selected")}var S=function(){$(e).removeClass("k-state-hover");P.enable(e,I.canExecute())};if(!R){S()}I.bind(g.COMMAND_ENABLED_CHANGED,S);return e},addMenuItemClass:function(I,K,e){if(e.shouldAddMenuClass){var J=e.menuClassPrefix||"m";$("span.k-link",I).addClass(J+K.replace(/\s*/g,"").replace(/\./g,"_"))}},initializeCommand:function(e){if(e.canExecute){e.raiseCanExecuteChanged()}},onMenuItemClicked:function(e){var I=$(e.item).data("command"),J=$(e.item).data("configuration"),K=$(e.item).data("regionName");this.trigger(g.MENU_ITEM_CLICKING,{itemCommand:I});if(I){if(J.selection){$(">.k-state-selected",$(e.item).parent()).removeClass("k-state-selected");$(e.item).addClass("k-state-selected")}I.execute();I.executeLogLambda(function(){E.logEvent(I.featureCategory,I.featureName)})}},onMenuOpen:function(e){var I=$(e.item).data("command"),J=$(e.item).data("configuration"),L=$(e.item).data("regionName");for(var K=0;K<I.subCommands.length;K++){I.subCommands[K].raiseCanExecuteChanged()}}});var c=b.CommandBase.extend({init:function(){var e=this;b.CommandBase.fn.init.apply(e,arguments)},execute:function(){i.closeCurrentModalDialog()}});function z(){k.commandService.registerCommand(new c(g.COMMAND_CLOSE_CURRENT_MODAL_DIALOG,"Close Dialog",[g.GLOBAL_NON_UI_COMMANDS],[{region:g.GLOBAL_REGION,keyShortcut:{modifiers:[],keys:[g.KEY_ESC],preventDefaultBrowserAction:true}}]))}function p(){var I="Cannot install Chrome App at the moment. ",L="iceWebStoreAppSuppressed",K=false,e=window.chrome||null;if(window.localStorage&&window.localStorage.getItem(L)==="true"){K=true}function J(O,M){var N=I+(M.message||M);t.logOutputMessage(N);w.removeNotification(O)}if(!K&&e&&e.app&&!e.app.isInstalled){w.addNotification({message:a.WEBSTORE_APP_MESSAGE,title:a.WEBSTORE_APP_TITLE,type:w.notificationTypes.CHROME_WEBSTORE,clickCallback:function(N){try{e.webstore.install("",function(){w.removeNotification(N)},function(O){J(N,O)})}catch(M){J(N,M)}},deleteCallback:function(){window.localStorage.setItem(L,true)}})}}function o(){var e="Icenium sync process has not finished yet. To avoid potential data loss exit Icenium later.";function I(K){K.bind(K.events.APP_BEFORE_UNLOAD,J)}function J(K){if(B.requestService.hasPendingRequests()){K.objections.push(e)}}}k.ViewRendererBase=H;k.viewRenderer=G;k.progressService=x;k.userSettingsService=F;k.dataLossProtectionService=h;k.RegionAdapterBase=y;k.MenuRegionAdapter=u;k.TabStripRegionAdapter=D;k.commandService=new f();k.keyBindingService=new r();k.navigationService=v;k.loaderService=new s();k.frameService=new m();k.commandMenuService=new d();o();z();try{p()}catch(j){t.logOutputMessage("Unable to complete check for Chrome App. "+j.message)}return k});