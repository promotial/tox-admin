define(function(F){var x=F("kendo"),e=F("modules/core/base-classes"),n=F("modules/core/core-module"),g=F("modules/core/base-commands"),p=F("modules/core/dialog-viewmodels"),N=F("modules/core/wizard-viewmodels"),B=F("modules/project-navigator/project-navigator-module"),o=F("modules/core/dialog-service"),l=F("modules/workspace-operations/build-service"),J=F("modules/workspace/solution-settings-service"),A=F("modules/options/options-module"),L=F("modules/view-pane/view-pane-service"),C=F("modules/project-navigator/project-navigator-module"),y=F("modules/logging/logging-service"),K=F("modules/tracking/tracking-service"),j=F("text!./wizard-dialog-template.html"),s=F("text!./run-w-index-template.html"),c=F("text!./run-w-android-template.html"),w=F("text!./run-w-ion-template.html"),D=F("text!./run-w-provision-template.html"),t=F("text!./run-w-install-ion-template.html"),h=F("text!./browser-not-supported-template.html"),a={DIALOG_CAPTION_BUILD:"Build",DIALOG_CAPTION_ION:"Install Icenium Ion",URL_ITUNES_ION:"itms-apps://itunes.apple.com/app/icenium-ion/id527547398?mt=8"};F(["noamd/kendo.dataviz.qrcode.min"]);F("css!./wizard-dialog.css");var m=window;var k=N.BaseWizardViewModel.extend({init:function(O,Q){var P=this;N.BaseWizardViewModel.fn.init.apply(P,arguments)}});var r=N.BasePageViewModel.extend({init:function(O){var P=this;P.buildConfig=J.solutionSettings().BuildConfiguration;N.BasePageViewModel.fn.init.apply(P,arguments)}});var v=N.BasePageViewModel.extend({qrCodeImageSrc:m.IMG_SRC_PLACEHOLDER,init:function(O){var P=this;N.BasePageViewModel.fn.init.apply(P,arguments);P.set("hasError",false);P.set("hasQrCode",false);O.project.getLiveSyncTokenAsync().done(function(Q){var R=n.navigationService.getIonAppPackageAddress(Q);P.set("qrCodeLink",R);P.set("hasQrCode",true)}).fail(function(Q){P.set("errorText","Unable to get LiveSync token");P.set("hasError",true)})},onInstallIon:function(){var O=new u();o.showConfirmationDialog(a.DIALOG_CAPTION_ION,{template:t,viewModel:O})}});var u=p.MessageBoxViewModel.extend({qrCodeLink:a.URL_ITUNES_ION});var f=N.BasePageViewModel.extend({init:function(O){var P=this;N.BasePageViewModel.fn.init.apply(P,arguments);P.project=O.project;P.token=""},setBuildRequestData:function(P){var Q=this,O=J.solutionSettings().BuildConfiguration||m.BUILD_CONFIG_DEBUG;Q.platform=P;Q.buildRequestData={Properties:{Platform:Q.platform,Configuration:O}}},build:function(){var Q=this;Q.set("isBuildRunning",true);Q.set("hasError",false);y.logOutputMessage("Build solution started: "+iceConfiguration.solutionName);var O=Q.platform==="Android"?m.TrackingTags.featureCategory.Build.features.Android:m.TrackingTags.featureCategory.Build.features.iOS;K.logEvent(m.TrackingTags.featureCategory.Build.name,O);Q.buildRequestData.Properties.Platform=Q.platform;function P(){l.buildProject({project:Q.project.getProjectInfo(),request:Q.buildRequestData}).done($.proxy(Q.onBuildFinished,Q)).fail($.proxy(Q.onBuildError,Q))}Q.project.getLiveSyncTokenAsync().done(function(R){Q.token=R;if(Q.buildRequestData.Properties.Configuration===m.BUILD_CONFIG_DEBUG){Q.buildRequestData.Properties.LiveSyncToken=R}P()}).fail($.proxy(Q.onBuildError,Q))},onBuildFinished:function(S){var T=this,R="",O="";if(!T.get("isBuildRunning")){return}T.set("isBuildRunning",false);if(!S||!S.ResultsByTarget){T.setError("Server exception",S.Exception.Message);return}if(S.Errors&&S.Errors.length>0){T.setError("Build failed",S.Output);return}if(S.ResultsByTarget){var P=S.ResultsByTarget.Build.Items;for(var Q=0;Q<P.length;Q++){if(P[Q].Platform===T.platform){R=P[Q].FullPath}}}T.set("outputPath",R);n.navigationService.getMobilePackageShortAddress(T.token,R).done(function(U){T.set("downloadLink",U)});T.getQrCodeLink(R).done(function(U){T.set("qrCodeLink",U)});y.logOutputMessage(S.Output)},getQrCodeLink:function(O){var P=this;return n.navigationService.getMobilePackageShortAddress(P.token,O)},onBuildError:function(O){var P=this;P.set("isBuildRunning",false);P.setError("Unexpected server error",O.statusText||O.Message)},setError:function(P,O){var Q=this;Q.set("hasError",true);Q.set("errorText",P);Q.set("errorDetails",O);y.logOutputMessage(["Exception",P,O].join(": "))},hasBuildResult:function(){var O=this;return !O.get("isBuildRunning")&&!O.get("hasError")},onErrorDatailsClick:function(){var Q=this,P=Q.get("errorText"),O=Q.get("errorDetails");o.showMessageBox("Exception: "+P,O)},onRebuildClick:function(){this.build()},onCancelClick:function(){var O=this;O.set("isBuildRunning",false);O.setError("Build has been canceled","")},qrCodeImageSrc:m.IMG_SRC_PLACEHOLDER});var b=f.extend({init:function(){var O=this;f.fn.init.apply(O,arguments);O.setBuildRequestData(m.DevicePlatforms.Android);O.build()}});var d=f.extend({init:function(){var O=this;f.fn.init.apply(O,arguments);O.setBuildRequestData(m.DevicePlatforms.iOS);O.set("showProvisionsSelector",true);O.set("isReleaseBuild",false);O.set("selectedProvision",x.observable({ProvisionedDevices:[],ExpirationDate:"2013-03-19T13:01:35+02:00"}));O.set("selectedCryptographicIdentityId",null);O.set("selectedProvisionValidCertificates",[]);O.set("selectedProvisionInvalidCertificates",[]);O.set("hasValidCert",false);O.set("hasInvalidCert",false);O.bind("bind",$.proxy(O.onBind,O))},onBind:function(){var O=this;O.initProvisions()},initProvisions:function(){var Q=this;Q.appProvisions=J.getProvisionCandidates(Q.project.properties.AppIdentifier,[m.ProvisionTypeEnum.Development,m.ProvisionTypeEnum.AdHoc]);Q.set("hasProvisions",(Q.appProvisions&&Q.appProvisions.length));$("#provisionList").kendoDropDownList({dataTextField:"Name",dataValueField:"Id",dataSource:new x.data.DataSource({data:Q.appProvisions}),template:"${ data.Name } (${ data.ProvisionType })",change:function(R){Q.set("selectedProvision",R.sender.dataItem());Q.matchCertificates()}});var O=$("#provisionList").data("kendoDropDownList");O.list.width(300);if(Q.appProvisions.length>0){Q.selectProjectSettings();var P=Q.get("selectedProvision").Identifier;O.select(function(R){return R.Identifier===P})}},onBuildClick:function(){var P=this,O=P.get("selectedProvision");if(O&&P.get("selectedCryptographicIdentityId")){P.buildRequestData.Properties.MobileProvisionIdentifier=O.Identifier;P.buildRequestData.Properties.iOSCodesigningIdentity=P.get("selectedCryptographicIdentityId");P.buildRequestData.Properties.iOSAppIdentifierPrefix=O.ApplicationIdentifierPrefix;P.buildRequestData.Properties.iOSCanBeDebugged=(O.ProvisionType===m.ProvisionTypeEnum.Development).toString().toLowerCase();if(P.get("isReleaseBuild")){P.buildRequestData.Properties.Configuration=m.BUILD_CONFIG_RELEASE}}else{o.showConfirmationDialog("Build ",{message:"No matching certificate was found for selected provision.",accept:function(){P.set("isBuildRunning",false)},cancelVisible:false,rejectVisible:false,acceptText:"Ok"});P.set("isBuildRunning",false);return}P.set("showProvisionsSelector",false);P.build();P.set("hasQrCode",(O.ProvisionType===m.ProvisionTypeEnum.AdHoc))},getQrCodeLink:function(O){var P=this;return n.navigationService.getMobilePackageITMSShortLinks(P.token,O)},createIdentifier:function(P){var O=P.indexOf("*");if(O<0){return P}return(P.substring(0,O)+this._project.properties.ProjectName.split(" ").join(""))},onImportCertClick:function(){var O=this;A.showOptionsDialog("General/Certification Management").always($.proxy(O.matchCertificates,O))},onProvisionsOptionsClick:function(){var O=this;A.showOptionsDialog("Mobile/iOS").always($.proxy(O.initProvisions,O))},selectProjectSettings:function(){var Q=this,P;var O=J.getSelectedCodeSignIdentity(Q.project.properties.AppIdentifier,Q.project.getProjectIdentifier(),Q.platform);if(O){P=Q._findProvisionById(O.provisionId)}if(!P&&Q.appProvisions&&Q.appProvisions.length){P=Q.appProvisions[0]}Q.set("selectedProvision",P);Q.matchCertificates();if(O){Q.set("selectedCryptographicIdentityId",O.cryptographicIdentityId)}},matchCertificates:function(){var Z=this,Y=Z.get("selectedProvision"),Q=Z.get("selectedCryptographicIdentityId"),P=J.getCodeSignIdentityByProvision(Y),S=false,R=false,aa=[],U=[],X=null;Z.set("selectedCryptographicIdentityId",null);for(var T=0,W=P.length;T<W;T++){var O=P[T];O.rowid="cert-row-"+T;var V=O.isValid&&x.parseDate(O.expirationDate)>=new Date();if(V){if(!S){X=O.name}aa.push(O);S=true}else{U.push(O);R=true}}Z.set("hasValidCert",S);Z.set("hasInvalidCert",R);Z.set("selectedProvisionValidCertificates",aa);Z.set("selectedProvisionInvalidCertificates",U);Z.set("selectedCryptographicIdentityId",X)},_findProvisionById:function(Q){var R=this;for(var O=0;O<R.appProvisions.length;O++){var P=R.appProvisions[O];if(P.Identifier===Q){return P}}return null},onSelectProvisionClick:function(){var O=this;O.set("showProvisionsSelector",true)}});var M={index:{model:r,template:s},android:{model:b,template:c},ion:{model:v,template:w},provision:{model:d,template:D}};var I=g.CommandBase.extend({init:function(){var O=this;g.CommandBase.fn.init.apply(O,arguments);O.buildDialogOpenRequested=false;O.buildDialogOpened=false;O.featureCategory=m.TrackingTags.featureCategory.Build.name;O.featureName=m.TrackingTags.featureCategory.Build.features.ShowBuildDialog},execute:function(){L.saveModifiedFiles($.proxy(this._afterSaveAll,this))},_afterSaveAll:function(){var Q=this,P=C.solutionService.solution();if(P){var O=P.getMobileProject();if(O.properties.ProjectTypeGuids===m.MOBILE_PROJECT_GUID){Q.buildMobile(O)}else{o.showMessageBox(a.DIALOG_CAPTION_BUILD,"Exception: Missing mobile project!")}}},projectContainsStartUpFile:function(Q){for(var O=0;O<Q.childItems().length;O++){var P=Q.childItems(O);if(P.text&&(P.text.toLowerCase()===m.MOBILE_STARTUP_FILE)){return true}}return false},buildMobile:function(P){var Q=this;if(!Q.buildDialogOpened&&!Q.buildDialogOpenRequested){if(!Q.projectContainsStartUpFile(P)){o.showMessageBox(a.DIALOG_CAPTION_BUILD,"Warning: The project should contain an '"+m.MOBILE_STARTUP_FILE+"' file.");return}Q.buildDialogOpenRequested=true;var O=function(){if(!J.areSettingsLoaded()){window.setTimeout(O,200)}else{var R=new k(P,M);var S=o.showModalDialog(a.DIALOG_CAPTION_BUILD,{viewModel:R,template:j});R.getPromise().always(function(){Q.buildDialogOpened=false});Q.buildDialogOpenRequested=false;Q.buildDialogOpened=true}};O()}},canExecute:function(){return true}});var H=g.CommandBase.extend({init:function(){var O=this;g.CommandBase.fn.init.apply(O,arguments)},execute:function(){},getType:function(){return m.COMMAND_RUN_ROOT}});var G=g.CommandBase.extend({init:function(){var P=this;g.CommandBase.fn.init.apply(P,arguments);if(L){P.onViewPaneNavigationLoaded()}else{n.loaderService.bind(m.VIEWPANE_NAVIGATION_LOADED,$.proxy(P.onViewPaneNavigationLoaded,P))}var O=arguments[0];if(O===m.COMMAND_RUN_PROJECT_GALAXY_S2){P.deviceID=m.DEVICE_ID_GALAXY_S2}else{if(O===m.COMMAND_RUN_PROJECT_ANDROID_TABLET){P.deviceID=m.DEVICE_ID_ANDROID_TABLET}else{if(O===m.COMMAND_RUN_PROJECT_IPAD){P.deviceID=m.DEVICE_ID_IPAD}else{if(O===m.COMMAND_RUN_PROJECT_IPHONE5){P.deviceID=m.DEVICE_ID_IPHONE5}else{P.deviceID=m.DEVICE_ID_IPHONE4}}}}P.featureCategory=m.TrackingTags.featureCategory.RunInSimulator.name;P.featureName=P.deviceID;P.saving=false;P.simulatorWindow=null;P.isDeploymentRunning=false;n.dataLossProtectionService.bind(m.APP_BEFORE_UNLOAD,$.proxy(P.onBeforeUnload,P))},onBeforeUnload:function(){var O=this;if(O.simulatorWindow){O.simulatorWindow.parent=null;O.simulatorWindow.close()}},onViewPaneNavigationLoaded:function(){L.bind(m.FILE_SAVED,$.proxy(this.onFileSaved,this));L.bind(m.ALL_FILES_SAVED,$.proxy(this.onAllFilesSaved,this));L.bind(m.SAVING_FILES_FAILED,$.proxy(this.onAllFilesSaveFailed,this))},execute:function(){var P=this,O=L.saveAllModifiedFiles();P.saving=O;P._afterSaveAll.apply(P,arguments);return},_afterSaveAll:function(){var Q=this,O,P=C.solutionService.solution();if(P){O=P.getMobileProject();Q.projectInfo=O.getProjectItemInfo();Q.isDeploymentRunning=true;Q.startApp()}},projectContainsStartUpFile:function(Q){for(var O=0;O<Q.childItems().length;O++){var P=Q.childItems(O);if(P.text&&(P.text.toLowerCase()===m.MOBILE_STARTUP_FILE)){return true}}return false},startApp:function(){var Q=this;Q.isDeploymentRunning=false;var P=C.solutionService.solution();var O=P.getMobileProject();if(O.properties.ProjectTypeGuids===m.MOBILE_PROJECT_GUID){if(!Q.projectContainsStartUpFile(O)){o.showMessageBox("Simulator","The project should contain an '"+m.MOBILE_STARTUP_FILE+"' file.");return}Q.openSimulator(O)}else{}},startWebApp:function(O){n.navigationService.openWebWindow(O.Result)},openSimulator:function(S){var T=this,R=n.navigationService,U=R.getMobileSimulatorAddress(S.properties.ProjectName,T.deviceID,S.properties.FrameworkVersion),V=navigator.userAgent.toLowerCase(),P=/chrome/.test(V),Q=/safari/.test(V),O=!!navigator.__proto__;if(P||(Q&&O)){T.simulatorWindow=z(U,T.deviceID,T.saving)}else{o.showConfirmationDialog("Simulator is not supported in this browser",{template:h,viewModel:new i()})}},onFileSaved:function(O){var R=this;if(R.simulatorWindow){if(!R.saving){if(R.simulatorWindow.closed){delete R.simulatorWindow;R.simulatorWindow=null}else{var Q=C.solutionService.solution();var P=Q.getMobileProject();R.openSimulator(P)}}}},onAllFilesSaved:function(){var O=this;if(O.simulatorWindow){if(O.saving){O.saving=false;O.onFileSaved()}}},onAllFilesSaveFailed:function(){var O=this;if(O.simulatorWindow){O.saving=false;O.simulatorWindow.parent=null;O.simulatorWindow.close()}},canExecute:function(){return !this.isDeploymentRunning},getType:function(){return m.COMMAND_RUN_ROOT}});var i=p.ConfirmationDialogViewModel.extend({init:function(){var O=this;p.ConfirmationDialogViewModel.fn.init.apply(O,arguments)},rejectVisible:false,acceptText:m.OK_TEXT});function q(P){var O=n.navigationService.prepareBaseUrl(iceConfiguration.baseUrl)+"Simulator?targetUrl="+encodeURIComponent(P);O=O.replace(/https/g,"http");return O}function z(Y,P,U){var W=q(Y);if(U){var V=iceConfiguration.backendServiceScheme+"://"+window.location.host+window.iceRootAlias+"SimulatorSaving.html";return window.open(V,"iceSimulator_"+P,"toolbar=0, scrollbars=1, location=0, status=1, menubar=0, resizable=0, width=1200, height=786")}var X=C.solutionService.solution();var T=X.getMobileProject();var S=T.properties.iOSStatusBarStyle;var Q=T.properties.DeviceOrientations;var R=false;var O=T.properties.FrameworkVersion;if(T._getResourceItem(m.IPHONE_5_SPLASH_RESOURCE_PATH,"Resource")){R=true}W+="&iOSStatusBarStyle="+encodeURIComponent(S);W+="&allowedOrientation="+encodeURIComponent(Q);W+="&fullResolution="+encodeURIComponent(R);W+="&cordovaVersion="+encodeURIComponent(O);return window.open(W,"iceSimulator_"+P,"toolbar=0, scrollbars=1, location=0, status=1, menubar=0, resizable=0, width=1200, height=786")}function E(){var O=new H(m.COMMAND_RUN_ROOT,"Run",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS]);O.addCommand(new I(m.COMMAND_BUILD_SOLUTION,"Build",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS],[{region:m.GLOBAL_REGION,keyShortcut:{modifiers:[m.KEY_CTRL],keys:[m.KEY_B],modifiersOSX:[m.KEY_CMD],preventDefaultBrowserAction:true}}],[])).addCommand(new g.SeparatorCommand(m.COMMAND_IN_SIMULATOR_SEPARATOR,"In Simulator",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS],null)).addCommand(new G(m.COMMAND_RUN_PROJECT_IPHONE,"iPhone",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS],[{region:m.GLOBAL_REGION,keyShortcut:{modifiers:[m.KEY_CTRL],keys:[m.KEY_F6],modifiersOSX:[m.KEY_CMD]}}])).addCommand(new G(m.COMMAND_RUN_PROJECT_IPHONE5,"iPhone5",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS],[{region:m.GLOBAL_REGION,keyShortcut:{modifiers:[m.KEY_CTRL],keys:[m.KEY_F10],modifiersOSX:[m.KEY_CMD]}}])).addCommand(new G(m.COMMAND_RUN_PROJECT_IPAD,"iPad",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS],[{region:m.GLOBAL_REGION,keyShortcut:{modifiers:[m.KEY_CTRL],keys:[m.KEY_F8],modifiersOSX:[m.KEY_CMD]}}])).addCommand(new g.SeparatorCommand(m.COMMAND_SIMULATOR_GROUP1_SEPARATOR,"",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS])).addCommand(new G(m.COMMAND_RUN_PROJECT_ANDROID_TABLET,"Android Tablet",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS],[{region:m.GLOBAL_REGION,keyShortcut:{modifiers:[m.KEY_CTRL],keys:[m.KEY_F9],modifiersOSX:[m.KEY_CMD]}}],[])).addCommand(new G(m.COMMAND_RUN_PROJECT_GALAXY_S2,"Android Phone",[m.SOLUTION_MENU_COMMANDS,m.PROJECT_NAVIGATOR_NODE_COMMANDS],[{region:m.GLOBAL_REGION,keyShortcut:{modifiers:[m.KEY_CTRL],keys:[m.KEY_F7],modifiersOSX:[m.KEY_CMD]}}]));n.commandService.registerCommand(O)}E();n.frameService.initializeMenu(m.SOLUTION_MENU_REGION,m.SOLUTION_MENU_COMMANDS,{shouldAddMenuClass:true})});