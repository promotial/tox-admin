define(function(x){var p,s=x("kendo"),r=x("modules/core/helpers"),e=x("modules/core/core-module"),a=x("modules/core/base-commands"),g=x("modules/core/dialog-viewmodels"),f=x("modules/core/dialog-service"),y=x("modules/find-replace/search-controler"),z=x("modules/view-pane/view-pane-service"),c=x("modules/code-editor/code-editor-module"),l=x("text!./find-in-document-template.html"),A=x("dom!viewPaneToolsRegion");x("css!./find-replace.css");var d=window;var h="flat-menu",i={textSearch:"Find Text",caseSenseSearch:"Case Sensitive",regexSearch:"Regex format: '/regex/'"},b={text:"Case Sensitive",regex:"Disabled. RegExp is by default CaseSense. If you want a CaseInsensitive RegExp: '/regex/i'"};var q=s.Observable.extend({init:function(){var B=this;s.Observable.fn.init.apply(B,arguments);B._subscribeToEvents();B._editor=null;B._findIsShown=false},_subscribeToEvents:function(B){var C=this;if(!B){y.bind(d.OPEN_FIND_DIALOG,$.proxy(C.onOpenFindDialog,C));y.bind(d.OPEN_FIND_DIALOG_FOR_REPLACE,$.proxy(C.onOpenFindDialogForReplace,C))}else{z.bind(d.VIEW_ACTIVATED,$.proxy(C.onActiveViewChanged,C));z.bind(d.VIEW_DEACTIVATED,$.proxy(C.onActiveViewChanged,C))}},initEditorToolsRegion:function(D){var C=this;e.frameService.initializeMenu(d.VIEW_TOOLS_REGION,d.VIEW_PANE_TOOLS_COMMANDS,{dontRenderText:true,cssClass:h,shouldAddMenuClass:true});C.viewPaneToolsRegionElement=D;var B=true;C._subscribeToEvents(B)},isFindInDocumentPossible:function(){var B=z.activeItem(),E=false,D=false;if(B){var C=c.getEditorByFile(B.key);E=C?true:false;D=!r.isImageFile(B.filePath)}return E&&D},showFindReplaceInDocument:function(C,D){var E=this;var G=E._findViewModel=new o(C,D);var B;var F=function(H){B=H};e.keyBindingService.focusRegion(null);E._findIsShown=true;f.showNonModalDialog("Find",{template:l,viewModel:G,viewInitialized:F,active:function(){G.initializeView(B)},width:"415px"});G.getPromise().always(function(){E._findIsShown=false;e.keyBindingService.focusRegion(d.VIEWPANE_REGION)})},onOpenFindDialog:function(B,D){var E=this;var C=B.editor;if(E._findIsShown){E._findViewModel.dialog().close()}E.showFindReplaceInDocument(C,D)},onOpenFindDialogForReplace:function(B){var C=true;this.onOpenFindDialog(B,C)},onActiveViewChanged:function(){var B=this;var C=B.viewPaneToolsRegionElement;if(C){$(C).css("display",B.isFindInDocumentPossible()?"":"none")}},isFindInDocumentShown:function(){return this._findIsShown},isReplaceVisible:function(){var B=this;if(B._findViewModel!==undefined&&B._findViewModel.isReplaceVisible){return true}return false}});var j=a.CommandBase.extend({init:function(){var B=this;a.CommandBase.fn.init.apply(B,arguments);z.bind(d.VIEW_ACTIVATED,$.proxy(B.onActiveViewChanged,B));z.bind(d.VIEW_DEACTIVATED,$.proxy(B.onActiveViewChanged,B));B.featureCategory=d.TrackingTags.featureCategory.FindReplace.name},canExecute:function(){var C=this;var B=p.isFindInDocumentPossible();if(B){C._editor=c.getEditorByFile(z.activeItem().key)}return B},onActiveViewChanged:function(){this.raiseCanExecuteChanged()}});var k=j.extend({init:function(){var B=this;j.fn.init.apply(B,arguments);B.featureName=d.TrackingTags.featureCategory.FindReplace.features.FindText},execute:function(){y.initFindInDocument({editor:this._editor})}});var w=j.extend({init:function(){var B=this;j.fn.init.apply(this,arguments);B.featureName=d.TrackingTags.featureCategory.FindReplace.features.ReplaceText},execute:function(){y.initReplaceInDocument({editor:this._editor})}});var m=j.extend({init:function(){var B=this;j.fn.init.apply(this,arguments);B.featureName=d.TrackingTags.featureCategory.FindReplace.features.FindNextMatch},execute:function(){var B=this._editor;y.findNextInDocument({editor:B})}});var n=j.extend({init:function(){var B=this;j.fn.init.apply(this,arguments);B.featureName=d.TrackingTags.featureCategory.FindReplace.features.FindPreviousMatch},execute:function(){var B=this._editor;y.findPreviousInDocument({editor:B})}});var v=j.extend({init:function(){var B=this;j.fn.init.apply(this,arguments);B.featureName=d.TrackingTags.featureCategory.FindReplace.features.ReplaceCurrentText},execute:function(){var C=this._editor;var B={editor:C};if(p.isReplaceVisible()){y.replaceCurrentInDocument(B);y.findNextInDocument(B)}}});var u=j.extend({init:function(){var B=this;j.fn.init.apply(this,arguments);B.featureName=d.TrackingTags.featureCategory.FindReplace.features.ReplaceAll},execute:function(){var C=this._editor;var B={editor:C};if(p.isReplaceVisible()){y.replaceAllInDocument(B)}}});var o=g.DialogViewModelBase.extend({init:function(B,C){var D=this;D._editor=B;g.DialogViewModelBase.fn.init.apply(this,arguments);D.set("isReplaceVisible",C?true:false);D._subscribeToEvents();D.bind("bind",function(E){var I=D._view=E.view;var H=function(J){J.stopPropagation();J.preventDefault()};var G=D._textFieldElement=$("#searchBox input",I);var F=$("#replaceBox input",I);G.mouseup(function(J){H(J)}).keydown($.proxy(D.onSearchTextKeyDown,D)).keyup($.proxy(D.onSearchTextChange,D));F.keydown($.proxy(D.onReplaceTextKeyDown,D)).keyup($.proxy(D.onReplaceTextChange,D));$(I).closest(".k-window").keydown(function(J){if(J.keyCode===d.KEY_ESC){H(J);D.onCloseFindDialog()}else{if(J.altKey&&(J.keyCode===d.KEY_R)){H(J);D.onRegexClick()}else{if(J.altKey&&(J.keyCode===d.KEY_C)){H(J);D.onCaseSenseClick()}}}});D.resetSearchPlaceholderText();if(BrowserDetect.browser==="Explorer"){$(D._textFieldElement).placeholder()}})},searchedValue:"",replaceValue:"",searchPlaceholderText:"",replacePlaceholderText:"Replace With",isCaseSenseSearch:false,isRegexSearch:false,isReplaceVisible:false,_subscribeToEvents:function(){var B=this;y.bind(d.CLOSE_FIND_DIALOG,$.proxy(B.onCloseFindDialog,B));c.bind(d.CODE_EDITOR_ACTIVATED,$.proxy(B.reinitDialog,B))},reinitDialog:function(B){this.reinit(B.editor)},onCloseFindDialog:function(){var B=this;if(B.dialog()){B.closeDialog()}},reinit:function(C){var F=this,B=C.codeEditor,D=B.getSelection(),E=C.searchState;F._editor=C;B.setCursor(B.getCursor());if(E){F.set("searchedValue",E.text);F.set("replaceValue",E.replaceText);F.set("isRegexSearch",E.isRegex);F.set("isCaseSenseSearch",E.isCaseSense)}else{F.set("searchedValue","");F.set("replaceValue","");F.set("isRegexSearch",false);F.set("isCaseSenseSearch",false)}if(D){F.set("searchedValue",D)}if(F.get("searchedValue").length>0){F._restartFindInDocument()}F.focusAndSelect()},focusAndSelect:function(){var B=this._textFieldElement;setTimeout(function(){B.get(0).select();B.focus()},10)},onSearchTextChange:function(B){var G=this;var C=G._editor;var F=C.searchState;var E=F?F.text:"";var D=G.get("searchedValue");if(E!==D){G._restartFindInDocument()}},onReplaceTextChange:function(B){var G=this;var C=G._editor;var F=C.searchState;var E=F?F.replaceText:"";var D=G.get("replaceValue");if(E!==D){G._restartFindInDocument()}},onSearchTextKeyDown:function(B){var C=this;if(B.keyCode===d.KEY_ENTER&&!B.shiftKey){C.onFindNext();B.preventDefault();B.stopPropagation()}else{if(B.keyCode===d.KEY_ENTER&&B.shiftKey){C.onFindPrevious();B.preventDefault();B.stopPropagation()}}},onReplaceTextKeyDown:function(B){var C=this;if(B.keyCode===d.KEY_ENTER&&!B.shiftKey){C.onReplace();B.preventDefault();B.stopPropagation()}else{if(B.keyCode===d.KEY_ENTER&&B.shiftKey){C.onFindNext();B.preventDefault();B.stopPropagation()}}},clearSearchText:function(){this.set("searchedValue","")},clearReplaceText:function(){this.set("replaceValue","")},onFindNext:function(){var B=this._editor;y.findNextInDocument({editor:B})},onFindPrevious:function(){var B=this._editor;y.findPreviousInDocument({editor:B})},onReplace:function(){var C=this._editor;var B={editor:C};y.replaceCurrentInDocument(B);y.findNextInDocument(B)},onReplaceAll:function(){var C=this._editor;var B={editor:C};y.replaceAllInDocument(B)},onClose:function(){var B=this._editor;y.clearFindInDocument({editor:B});this.set("isReplaceVisible",false);B.codeEditor.focus();g.DialogViewModelBase.fn.onClose.apply(this,arguments)},onCaseSenseClick:function(){var B=this;if(!B.get("isRegexSearch")){B.set("isCaseSenseSearch",!B.get("isCaseSenseSearch"));B.resetSearchPlaceholderText();B._restartFindInDocument()}},caseSenseOptionClass:function(){var C=this;var B=["button","first-button","find-case"];if(C.get("isCaseSenseSearch")){B.push("checked")}if(C.get("isRegexSearch")){B.push("disabled")}return B.join(" ")},toggleReplaceButtonClass:function(){var C=this;var B=["button","first-button","last-button"];if(C.get("isReplaceVisible")){B.push("checked")}return B.join(" ")},caseSenseTitle:function(){return this.get("isRegexSearch")?b.regex:b.text},onRegexClick:function(){var B=this;B.set("isRegexSearch",!B.get("isRegexSearch"));B.resetSearchPlaceholderText();B._restartFindInDocument()},resetSearchPlaceholderText:function(){var E=this;var C=E.get("isRegexSearch");var B=E.get("isCaseSenseSearch");var D=i.textSearch;if(C){D=i.regexSearch}else{if(B){D=i.caseSenseSearch}}E.set("searchPlaceholderText",D)},regexOptionClass:function(){var B=["button","last-button","find-regex"];if(this.get("isRegexSearch")){B.push("checked")}return B.join(" ")},initializeView:function(D){var C=this,B=C._editor;C._view=D;C.reinit(B)},replaceVisibilityToggle:function(){var B=this;B.set("isReplaceVisible",!B.get("isReplaceVisible"))},_restartFindInDocument:function(){var E=this;var B=E._editor;var D=E.get("searchedValue");var C=E.get("replaceValue");y.findInDocument({editor:B,text:D,replaceText:C,isCaseSense:E.get("isCaseSenseSearch"),isRegex:E.get("isRegexSearch")})}});function t(){e.commandService.registerCommand(new k(d.COMMAND_FIND_IN_DOCUMENT,"Find in Document",[d.CODE_EDITOR_COMMANDS,d.VIEW_PANE_TOOLS_COMMANDS],[{region:d.GLOBAL_REGION,keyShortcut:{modifiers:[d.KEY_CTRL],keys:[d.KEY_F],modifiersOSX:[d.KEY_CMD],preventDefaultBrowserAction:true}}])).registerCommand(new w(d.COMMAND_REPLACE_IN_DOCUMENT,"Replace in Document",[d.CODE_EDITOR_COMMANDS],[{region:d.GLOBAL_REGION,keyShortcut:{modifiers:[d.KEY_CTRL],keys:[d.KEY_H],modifiersOSX:[d.KEY_CMD],preventDefaultBrowserAction:true}}])).registerCommand(new m(d.COMMAND_FIND_NEXT_IN_DOCUMENT,"Find Next",[d.CODE_EDITOR_COMMANDS],[{region:d.GLOBAL_REGION,keyShortcut:{modifiers:[],keys:[d.KEY_F3],preventDefaultBrowserAction:true}}])).registerCommand(new n(d.COMMAND_FIND_PREVIOUS_IN_DOCUMENT,"Find Previous",[d.CODE_EDITOR_COMMANDS],[{region:d.GLOBAL_REGION,keyShortcut:{modifiers:[d.KEY_SHIFT],keys:[d.KEY_F3],preventDefaultBrowserAction:true}}])).registerCommand(new v(d.COMMAND_REPLACE_CURRENT_IN_DOCUMENT,"Replace",[d.CODE_EDITOR_COMMANDS],[{region:d.GLOBAL_REGION,keyShortcut:{modifiers:[],keys:[d.KEY_F4],preventDefaultBrowserAction:true}}])).registerCommand(new u(d.COMMAND_REPLACE_ALL_IN_DOCUMENT,"Replace All",[d.CODE_EDITOR_COMMANDS],[{region:d.GLOBAL_REGION,keyShortcut:{modifiers:[d.KEY_SHIFT],keys:[d.KEY_F4],preventDefaultBrowserAction:true}}]))}p=new q();t();p.initEditorToolsRegion(A);return p});