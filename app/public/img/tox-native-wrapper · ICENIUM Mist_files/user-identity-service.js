define(function(d,a){var b=d("kendo"),e=d("modules/core/rest-proxy"),f=e.init(window.location.host,serviceConfiguration.backendServiceScheme),c=d("modules/notifications/notifications-service"),g=new (d("noamd/spark-md5"));var h=b.Class.extend({DAYS_TO_WARN_BEFORE_TRIAL_EXPIRE:3,ONE_DAY:24*60*60*1000,TRIAL_LICENSE:"Trial",MISSING_DATE_TEXT:"",MSG_RES:{subscriptionExpiredTitle:"Payment Required",subscriptionExpiredText:"Your subscription has expired. Click Subscribe to manage your subscription. Note: After you renew your subscription,log out and log back in for the changes to take effect.",subscriptionExpirationNotificationMessageTitle:"Subscription expiration",subscriptionExpiredNotificationMessage:"Your subscription has expired. Click here to manage your account.",subscriptionExpiresInLessThanNotificationMessage:"Your subscription has expired and you have less than {0} to renew it. Click here to manage your account.\n\nTo avoid seeing this message again, enable auto-renewal in your account settings.",trialExpiredNotificationMessage:"Your trial has expired. Click here to subscribe.",trialExpiresInLessThanNotificationMessage:"Your trial expires in less than {0}. Click here to subscribe.",subscriptionExpired:"Your subscription has expired.",subscriptionExpiresInLessThan:"Your subscription has expired and you have less than {0} to renew it."},EDITION_TYPE:{IceUlt:"Icenium Ultimate Edition",IcePro:"Icenium Professional Edition",IceDev:"Icenium Developer Edition"},USER_ACTION_URL:{accountTrialUri:"/account/trial",accountSubscriptionUri:"/account/subscription",accountRenewUri:"/account/renew"},userInfo:null,init:function(){var i=this;i._promise=f.authenticationService.getLoggedInUser().done(function(k){i.userInfo=k;try{iceConfiguration.loggedUser=$.trim(k.email.toLowerCase());k.emailMD5=g.hash($.trim(k.email.toLowerCase()))}catch(j){}k.isTrial=(k.tenant&&k.tenant.license&&k.tenant.license===i.TRIAL_LICENSE);i.checkNotifications()});e.requestService.bind(e.requestService.events.REQUEST_ERROR,$.proxy(i.onRequestError,i))},onRequestError:function(i){var j=this;if(i.errorCode===402){j.notifyAboutSubscriptionExpiration(i.error,i.message)}},isSubscriptionExpired:function(){var i=this,j=new Date(),k=i.getUserInfoDetails();if(k===undefined||k.expireDate===undefined){return false}return(k.expireDate<j)},notifyAboutSubscriptionExpiration:function(k,i){var j=this;c.addNotification({message:i,title:k,type:c.notificationTypes.WARNING,clickCallback:$.proxy(function(){window.open(j.getUserActionUrl(),"icenium-subscribe")},j)})},checkNotifications:function(){var p=this,r=p.userInfo;if(r&&r.tenant&&r.tenant.expSoft&&r.tenant.expStrict){try{var i,m,o=b.parseDate(r.tenant.expStrict),n=b.parseDate(r.tenant.expSoft),q=new Date(),j=(o.getTime()-q.getTime())/(p.ONE_DAY),l=p.MSG_RES.subscriptionExpirationNotificationMessageTitle,s="";if(o){if(r.isTrial&&j>=0&&j<=p.DAYS_TO_WARN_BEFORE_TRIAL_EXPIRE){s=b.format(p.MSG_RES.trialExpiresInLessThanNotificationMessage,p.daysToText(Math.ceil(j)))}else{if(r.isTrial&&o<=q){p.expireTooltip=p.MSG_RES.subscriptionExpired;s=p.MSG_RES.trialExpiredNotificationMessage}else{if(o<=q){p.expireTooltip=p.MSG_RES.subscriptionExpired;s=p.MSG_RES.subscriptionExpiredNotificationMessage}else{if(n<=q){p.expireTooltip=b.format(p.MSG_RES.subscriptionExpiresInLessThan,p.daysToText(Math.ceil(j)));s=b.format(p.MSG_RES.subscriptionExpiresInLessThanNotificationMessage,p.daysToText(Math.ceil(j)))}}}}if(s!==""){i=p.getUserActionUrl();m=c.notificationTypes.WARNING;c.addNotification({message:s,title:l,type:m,clickCallback:$.proxy(function(){window.open(i,"icenium-subscribe")},p)})}}}catch(k){}}},daysToText:function(i){return(i<=1?"a day":i+" days")},getInitPromise:function(){return this._promise},getUserInfoDetails:function(){var j=this,i,l=j.userInfo,k=new Date();if(!l||!l.tenant){return}i={edition:(l.tenant?j.EDITION_TYPE[l.tenant.edition]:"N/A"),email:(l.email?l.email:""),userName:l.name,emailMD5:(l.emailMD5?l.emailMD5:"00000000000000000000000000000000"),expireDate:((l&&l.tenant&&l.tenant.expSoft)?b.parseDate(l.tenant.expSoft):j.MISSING_DATE_TEXT),strictExpireDate:((l.tenant.expStrict)?b.parseDate(l.tenant.expStrict):j.MISSING_DATE_TEXT),showExpireTooltip:false,expireTooltip:j.expireTooltip||"",userActionUrl:j.getUserActionUrl()};i.showExpireTooltip=(i.expireDate<k);if(l.isTrial){i.edition+=" (Trial)"}return i},getUserActionUrl:function(){var k=this,l=new Date(),m=k.userInfo,j=((m&&m.tenant&&m.tenant.expSoft)?b.parseDate(m.tenant.expSoft):l),i=(j<=l);if(m&&m.isTrial){return k.USER_ACTION_URL.accountTrialUri}else{if(i){return k.USER_ACTION_URL.accountRenewUri}else{return k.USER_ACTION_URL.accountSubscriptionUri}}}});return new h()});