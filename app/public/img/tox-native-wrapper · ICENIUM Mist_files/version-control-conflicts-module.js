define(function(h){var f=h("kendo"),d=h("modules/core/core-module"),e=h("modules/core/dialog-viewmodels"),p=h("modules/version-control/version-control-service"),n=h("modules/tracking/tracking-service"),a=h("modules/core/base-commands"),g=h("modules/project-navigator/project-navigator-module"),m=g.solutionController,o=h("text!./version-control-conflicts-template.html");h("css!./version-control-conflicts-styles.css");var c=window,l={Local:"LatestVersion",Remote:"RemoteVersion",Workspace:"WorkspaceVersion"};var i=a.CommandBase.extend({init:function(){var q=this;a.CommandBase.fn.init.apply(q,arguments);q.versionToResolve=l.Local;q.featureCategory=c.TrackingTags.featureCategory.VersionControl.name;q.featureName=c.TrackingTags.featureCategory.VersionControl.features.ResolveLocal},execute:function(){var q=this;q.scope.resolveConflicts.call(q.scope,q.versionToResolve)},isApplicable:function(){return true}});var j=i.extend({init:function(){var q=this;i.fn.init.apply(q,arguments);q.versionToResolve=l.Remote;q.featureCategory=c.TrackingTags.featureCategory.VersionControl.name;q.featureName=c.TrackingTags.featureCategory.VersionControl.features.ResolveRemote}});var k=i.extend({init:function(){var q=this;i.fn.init.apply(q,arguments);q.versionToResolve=l.Workspace;q.featureCategory=c.TrackingTags.featureCategory.VersionControl.name;q.featureName=c.TrackingTags.featureCategory.VersionControl.features.ResolveWorkspace}});var b=e.MessageBoxViewModel.extend({init:function(q){var r=this;r.context=3;e.MessageBoxViewModel.fn.init.apply(r,arguments);r.prepare();r.registerCommands();r.changedLinesCount="";r.conflictingFilesNumber=0;r.conflictingLinesNumber=0;r.selectionCount=0;r.conflictingFiles=[];r.consts=window;r.bind("bind",$.proxy(r.onBind,r))},registerCommands:function(){var q=this;q.consts=window;d.commandService.registerCommand(new i(q.consts.COMMAND_RESOLVE_TO_LOCAL_VERSION,"Resolve to Local Version",[q.consts.RESOLVE_CONFLICTS_COMMANDS],[],q)).registerCommand(new j(q.consts.COMMAND_RESOLVE_TO_REMOTE_VERSION,"Resolve to Remote Version",[q.consts.RESOLVE_CONFLICTS_COMMANDS],[],q)).registerCommand(new k(q.consts.COMMAND_RESOLVE_TO_WORKSPACE_VERSION,"Resolve to Workspace Version",[q.consts.RESOLVE_CONFLICTS_COMMANDS],[],q))},resolveConflicts:function(s){var r=this,q=r._getSelectedConflictingFiles();p.Resolve({versionToResolve:s,conflictingFiles:q}).done(function(){p.Track().done(function(){for(var u=0;u<q.length;u++){var t="\\"+iceConfiguration.solutionName+"\\"+q[u];m.reloadItemByPath(t)}r.prepare()})})},prepare:function(){var r=this;r.conflictingFiles=p.GetConflictingFiles();r.set("conflictingFilesNumber",r.conflictingFiles.length);r.set("conflictingLinesNumber",0);r.set("selectionCount",r.conflictingFiles.length);if(r.filePathsDS!==undefined){r.filePathsDS.data([])}if(r.conflictingFilesDS===undefined){r.conflictingFilesDS=new f.data.DataSource({data:r.conflictingFiles})}else{var q=r.conflictingFiles.length>0?r.conflictingFiles:[];r.conflictingFilesDS.data(q)}},onBind:function(){var q=this;q.createResolveButton();q.createConflictingFilesGrid();q.createConflictingLinesGrid()},createResolveButton:function(){var t=this;var r=function(u){var w=u.item;var v=$(w).data("command");if(v&&v.canExecute()){var x=$(w).data("menu"),y=$(w).data("regionName");x.hideContextMenu();v.execute();v.executeLogLambda(function(){n.logEvent(v.featureCategory,v.featureName)})}};var q=d.commandService.getCommandsByCategory(t.consts.RESOLVE_CONFLICTS_COMMANDS);t.contextMenu=d.commandMenuService.buildContextMenu(q,r,{shouldAddMenuClass:true});var s=function(u){if(t.contextMenu&&t.contextMenu.element&&$(t.contextMenu.element).is(":visible")){t.contextMenu.hideContextMenu()}else{t.contextMenu.openOn(this)}u.preventDefault();u.stopPropagation()};$("#"+t.consts.RESOLVE_CONFLICTS_BUTTON).bind("click",s)},createConflictingFilesGrid:function(){var q=this;q.conflictingFilesGrid=$("#conflictingFilesGrid").kendoGrid({dataSource:q.conflictingFilesDS,columns:[{field:"isSelected",title:"&nbsp;",template:"<input type='checkbox' #if (isSelected) {#checked#}# />",width:"30px"},{field:"name",title:"Name",template:"<span class='document-type-icon ico-#=iconType#'></span>#=name#"},{field:"changeType",title:"Status",template:"<span title='#=changeType#'  class='ico-version-control change-type-#=changeType#' />",width:"50px"}],dataBound:function(s){var r=$("#conflictingFilesGrid");$("input[type=checkbox]",r).on("click",function(v){var w=this,t=q.get("selectionCount"),u=q.conflictingFilesGrid.dataItem(w.parentElement.parentElement);u.isSelected=w.checked;if(w.checked){t++}else{t--}q.set("selectionCount",t)})},change:function(r){q._previewConflictingLines.call(q)},selectable:"multiple, row",scrollable:true}).data("kendoGrid")},createConflictingLinesGrid:function(){var q=this;q.filePathsDS=new f.data.DataSource({data:[],model:{fields:{path:{type:"string"}}}});q.conflictingLinesGrid=$("#conflictingLinesGrid").kendoGrid({columns:[{field:"path",title:" ",template:"<span class='document-type-icon ico-#=iconType#'></span>#=path#"}],dataSource:q.filePathsDS,detailInit:function(r){$("<div/>").appendTo(r.detailCell).kendoGrid({columns:[{field:"OldLineNumber",title:"Old",template:"<span>#=OldLineNumber#</span>"},{field:"NewLineNumber",title:"New",template:"<span>#=NewLineNumber#</span>"},{title:" ",attributes:{"class":"line-status-#=BlockContainerType#"},template:"<span title='#=BlockContainerType#'  class='ico-version-control change-type-#=BlockContainerType#' />"},{field:"LineContents",title:"Line"}],dataSource:new f.data.DataSource({data:q.fileLines,filter:{field:"FilePath",operator:"eq",value:r.data.path}})})},dataBound:function(){var r=this;r.expandRow(r.tbody.find("tr.k-master-row"))}}).data("kendoGrid")},_previewConflictingLines:function(){var r=this,q=r._getFilePathsFromSelection();if(q===undefined||q.length===0){$("#conflictingLinesGrid").children().hide();r.set("changedLinesCount",{inserted:0,modified:0,deleted:0});return}r.fileLines=[];p.GetConflicts({contextSize:r.context,filePaths:q}).done($.proxy(r._onConflictingLinesReceived,r))},_onConflictingLinesReceived:function(z,t){var A=this;if(z===undefined||z.length===0){return}if(z.length!==t.length){return}var s=0;for(var u=0;u<z.length;u++){var y=z[u].DiffLineBlock;for(var w=0;w<y.length;w++){if(y[w].NewLineNumber===undefined){y[w].NewLineNumber=""}if(y[w].OldLineNumber===undefined){y[w].OldLineNumber=""}var r=y[w].BlockContainerType;if(r===p.LineChangeType.Local){s++}y[w].FilePath=t[u];A.fileLines.push(y[w])}}A.set("conflictingLinesNumber",s);var v=A._getIconTypesFromSelection();var q=[];for(var x=0;x<t.length;x++){q.push({path:t[x],iconType:v[x]})}A.filePathsDS.data(q)},_getSelectedConflictingFiles:function(){var s=this,q=$("#conflictingFilesGrid"),r=[];$("input[type=checkbox]:checked",q).each(function(v,w){var t=$(w).parent().parent(),u=s.conflictingFilesGrid.dataItem(t);r.push(u.name)});return r},canResolve:function(){return this.get("selectionCount")>0},_getFilePathsFromSelection:function(){var v=this,s=v.conflictingFilesGrid,r=[],u=s.tbody.find(">tr.k-state-selected");for(var t=0;t<u.length;t++){var q=s.dataItem(u[t]).name;r.push(q)}return r},_getIconTypesFromSelection:function(){var v=this,q=v.conflictingFilesGrid,t=[],u=q.tbody.find(">tr.k-state-selected");for(var r=0;r<u.length;r++){var s=q.dataItem(u[r]).iconType;t.push(s)}return t},onContextSliderChange:function(){var q=this;q._previewConflictingLines()},conflictingFilesSummary:function(){return this.get("conflictingFilesNumber")+" conflicts"},conflictingLinesSummary:function(){return this.get("conflictingLinesNumber")+" conflicts"}});return{getTemplate:function(){return o},getViewModel:function(){return new b()}}});