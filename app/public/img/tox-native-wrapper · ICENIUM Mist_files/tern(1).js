(function(a){if(typeof exports=="object"&&typeof module=="object"){return a(exports,require("./infer"),require("./signal"),require("acorn/acorn"),require("acorn/util/walk"))}if(typeof define=="function"&&define.amd){return define(["exports","./infer","./signal","acorn/acorn","acorn/util/walk"],a)}a(self.tern||(self.tern={}),tern,tern.signal,acorn,acorn.walk)})(function(l,C,R,a,X){var L=Object.create(null);l.registerPlugin=function(Z,Y){L[Z]=Y};var i={debug:false,async:false,getFile:function(Y,Z){if(this.async){Z(null,null)}},defs:[],plugins:{},fetchTimeout:1000};var M={completions:{takesFile:true,run:o},properties:{run:v},type:{takesFile:true,run:z},documentation:{takesFile:true,run:q},definition:{takesFile:true,run:p},refs:{takesFile:true,fullFile:true,run:w},rename:{takesFile:true,fullFile:true,run:e},files:{run:H}};l.defineQueryType=function(Z,Y){M[Z]=Y};function n(Y){this.name=Y;this.scope=this.text=this.ast=this.lineOffsets=null}n.prototype.asLineChar=function(Y){return d(this,Y)};function V(Y,aa,Z){Y.text=aa;Y.ast=C.parse(aa,Z.passes);Y.lineOffsets=null}var Q=l.Server=function(aa){this.cx=null;this.options=aa||{};for(var Z in i){if(!aa.hasOwnProperty(Z)){aa[Z]=i[Z]}}this.handlers=Object.create(null);this.files=[];this.uses=0;this.pending=0;this.asyncError=null;this.passes=Object.create(null);this.defs=aa.defs.slice(0);for(var ab in aa.plugins){if(aa.plugins.hasOwnProperty(ab)&&ab in L){var Y=L[ab](this,aa.plugins[ab]);if(Y&&Y.defs){this.defs.push(Y.defs)}if(Y&&Y.passes){for(var ac in Y.passes){if(Y.passes.hasOwnProperty(ac)){(this.passes[ac]||(this.passes[ac]=[])).push(Y.passes[ac])}}}}}this.reset()};Q.prototype=R.mixin({addFile:function(Y,Z){k(this,Y,Z)},delFile:function(aa){for(var Z=0,Y;Z<this.files.length;++Z){if((Y=this.files[Z]).name==aa){g(this,Y);this.files.splice(Z--,1);return}}},reset:function(){this.cx=new C.Context(this.defs,this);this.uses=0;for(var Z=0;Z<this.files.length;++Z){var Y=this.files[Z];Y.scope=null}this.signal("reset")},request:function(Z,Y){var aa=D(Z);if(aa){return Y(aa)}var ab=this;j(this,Z,function(ad,ac){Y(ad,ac);if(ab.uses>40){ab.reset();b(ab,function(){})}})},findFile:function(Y){return s(this.files,Y)},flush:function(Y){var Z=this.cx;b(this,function(aa){if(aa){return Y(aa)}C.withContext(Z,Y)})},startAsyncAction:function(){++this.pending},finishAsyncAction:function(Y){if(Y){this.asyncError=Y}if(--this.pending==0){this.signal("everythingFetched")}}});function j(af,Z,Y){if(Z.query&&!M.hasOwnProperty(Z.query.type)){return Y("No query type '"+Z.query.type+"' defined")}var ad=Z.query;if(!ad){Y(null,{})}var ab=Z.files||[];if(ab.length){++af.uses}for(var ac=0;ac<ab.length;++ac){var aa=ab[ac];k(af,aa.name,aa.type=="full"?aa.text:null)}if(!ad){b(af,function(){});return}var ae=M[ad.type];if(ae.takesFile){if(typeof ad.file!="string"){return Y(".query.file must be a string")}if(!/^#/.test(ad.file)){k(af,ad.file)}}b(af,function(ag){if(ag){return Y(ag)}var ah=ae.takesFile&&N(af,ab,ad.file);if(ae.fullFile&&ah.type=="part"){return Y("Can't run a "+ad.type+" query on a file fragment")}C.withContext(af.cx,function(){var aj;try{aj=ae.run(af,ad,ah)}catch(ai){if(af.options.debug&&ai.name!="TernError"){console.error(ai.stack)}return Y(ai)}Y(null,aj)})})}function c(Z,Y){C.withContext(Z.cx,function(){Y.scope=Z.cx.topScope;Z.signal("beforeLoad",Y);C.markVariablesDefinedBy(Y.scope,Y.name);C.analyze(Y.ast,Y.name,Y.scope,Z.passes);C.purgeMarkedVariables(Y.scope);Z.signal("afterLoad",Y)});return Y}function k(ab,aa,ac){var Z=s(ab.files,aa);if(Z){if(ac){g(ab,Z,ac)}return}var Y=new n(aa);ab.files.push(Y);if(ac){V(Y,ac,ab)}else{if(ab.options.async){ab.startAsyncAction();ab.options.getFile(aa,function(ad,ae){V(Y,ae||"",ab);ab.finishAsyncAction(ad)})}else{V(Y,ab.options.getFile(aa)||"",ab)}}}function g(aa,Y,Z){if(Y.scope){C.withContext(aa.cx,function(){C.purgeTypes(Y.name);C.markVariablesDefinedBy(Y.scope,Y.name);C.purgeMarkedVariables(Y.scope)});Y.scope=null}if(Z!=null){V(Y,Z,aa)}}function m(ae,Y){var Z=true,ad=false;for(var ac=0;ac<ae.files.length;++ac){var ab=ae.files[ac];if(ab.text!=null){continue}if(ae.options.async){Z=false;ae.options.getFile(ab.name,function(af,ag){if(af&&!ad){ad=true;return Y(af)}V(ab,ag||"",ae);m(ae,Y)})}else{try{V(ab,ae.options.getFile(ab.name)||"",ae)}catch(aa){return Y(aa)}}}if(Z){Y()}}function W(aa,Y){var Z=function(){aa.off("everythingFetched",Z);clearTimeout(ab);b(aa,Y)};aa.on("everythingFetched",Z);var ab=setTimeout(Z,aa.options.fetchTimeout)}function b(ad,Y){if(ad.pending){return W(ad,Y)}var aa=ad.fetchError;if(aa){ad.fetchError=null;return Y(aa)}var Z=true;for(var ac=0;ac<ad.files.length;++ac){var ab=ad.files[ac];if(ab.text==null){Z=false}else{if(ab.scope==null){c(ad,ab)}}}if(Z){Y()}else{W(ad,Y)}}function s(Y,ab){for(var aa=0;aa<Y.length;++aa){var Z=Y[aa];if(Z.name==ab&&Z.type!="part"){return Z}}}function A(Z){var Y=Z.indexOf("\n");if(Y<0){return Z}return Z.slice(0,Y)}function u(ab,Z,ac){var ad=Math.max(0,ac-500),Y=null;if(!/^\s*$/.test(ab)){for(;;){var aa=Z.indexOf(ab,ad);if(aa<0||aa>ac+500){break}if(Y==null||Math.abs(Y-ac)>Math.abs(aa-ac)){Y=aa}ad=aa+ab.length}}return Y}function P(Z){for(var Y=0;Z;++Y,Z=Z.prev){}return Y}function U(Z){var Y=new Error(Z);Y.name="TernError";return Y}function N(ah,ac,ad){var aa=ad.match(/^#(\d+)$/);if(!aa){return s(ah.files,ad)}var Y=ac[aa[1]];if(!Y){throw U("Reference to unknown file "+ad)}if(Y.type=="full"){return s(ah.files,Y.name)}var ag=Y.backing=s(ah.files,Y.name);var ae=Y.offset;if(Y.offsetLines){ae={line:Y.offsetLines,ch:0}}Y.offset=ae=O(ag,Y.offsetLines==null?Y.offset:{line:Y.offsetLines,ch:0},true);var ab=A(Y.text);var Z=u(ab,ag.text,ae);var af=Z==null?Math.max(0,ag.text.lastIndexOf("\n",ae)):Z;C.withContext(ah.cx,function(){C.purgeTypes(Y.name,af,af+Y.text.length);var ay=Y.text,aq;if(aq=ay.match(/(?:"([^"]*)"|([\w$]+))\s*:\s*function\b/)){var at=X.findNodeAround(Y.backing.ast,af,"ObjectExpression");if(at&&at.node.objType){var ap={type:at.node.objType,prop:aq[2]||aq[1]}}}if(Z&&(aq=ab.match(/^(.*?)\bfunction\b/))){var aj=aq[1].length,az="";for(var an=0;an<aj;++an){az+=" "}ay=az+ay.slice(aj);var ai=true}var ax=C.scopeAt(ag.ast,af,ag.scope);var aw=C.scopeAt(ag.ast,af+ay.length,ag.scope);var av=Y.scope=P(ax)<P(aw)?aw:ax;C.markVariablesDefinedBy(ax,Y.name,af,af+Y.text.length);Y.ast=C.parse(Y.text,ah.passes);C.analyze(Y.ast,Y.name,av,ah.passes);C.purgeMarkedVariables(ax);tieTogether:if(ap||ai){var ar=C.scopeAt(Y.ast,ab.length,ax);if(!ar.fnType){break tieTogether}if(ap){var au=ap.type.getProp(ap.prop);au.addType(ar.fnType)}else{if(ai){var ao=C.scopeAt(ag.ast,af+ab.length,ag.scope);if(ao==ax||!ao.fnType){break tieTogether}var am=ao.fnType,al=ar.fnType;if(!al||(al.name!=am.name&&am.name)){break tieTogether}for(var an=0,ak=Math.min(am.args.length,al.args.length);an<ak;++an){am.args[an].propagate(al.args[an])}am.self.propagate(al.self);al.retval.propagate(am.retval)}}}});return Y}function F(Y){return typeof Y=="number"||typeof Y=="object"&&typeof Y.line=="number"&&typeof Y.ch=="number"}function D(Y){if(Y.query){if(typeof Y.query.type!="string"){return".query.type must be a string"}if(Y.query.start&&!F(Y.query.start)){return".query.start must be a position"}if(Y.query.end&&!F(Y.query.end)){return".query.end must be a position"}}if(Y.files){if(!Array.isArray(Y.files)){return"Files property must be an array"}for(var aa=0;aa<Y.files.length;++aa){var Z=Y.files[aa];if(typeof Z!="object"){return".files[n] must be objects"}else{if(typeof Z.text!="string"){return".files[n].text must be a string"}else{if(typeof Z.name!="string"){return".files[n].name must be a string"}else{if(Z.type=="part"){if(!F(Z.offset)&&typeof Z.offsetLines!="number"){return".files[n].offset must be a position"}}else{if(Z.type!="full"){return'.files[n].type must be "full" or "part"'}}}}}}}}var J=25;function t(Z,aa){var ae=Z.text,ab=Z.lineOffsets||(Z.lineOffsets=[0]);var ac=0,Y=0;var ad=Math.min(Math.floor(aa/J),ab.length-1);var ac=ab[ad],Y=ad*J;while(Y<aa){++Y;ac=ae.indexOf("\n",ac)+1;if(ac==0){return null}if(Y%J==0){ab.push(ac)}}return ac}function O(Y,aa,ab){if(typeof aa!="number"){var Z=t(Y,aa.line);if(Z==null){if(ab){aa=Y.text.length}else{throw U("File doesn't contain a line "+aa.line)}}else{aa=Z+aa.ch}}if(aa>Y.text.length){if(ab){aa=Y.text.length}else{throw U("Position "+aa+" is outside of file.")}}return aa}function d(Z,ae){if(!Z){return{line:0,ch:0}}var ad=Z.lineOffsets||(Z.lineOffsets=[0]);var af=Z.text,ab,ac;for(var aa=ad.length-1;aa>=0;--aa){if(ad[aa]<=ae){ab=aa*J;ac=ad[aa]}}for(;;){var Y=af.indexOf("\n",ac);if(Y>=ae||Y<0){break}ac=Y+1;++ab}return{line:ab,ch:ae-ac}}function K(ab,Y,aa){if(ab.lineCharPositions){var Z=d(Y,aa);if(Y.type=="part"){Z.line+=Y.offsetLines!=null?Y.offsetLines:d(Y.backing,Y.offset).line}return Z}else{return aa+(Y.type=="part"?Y.offset:0)}}function f(Y){for(var Z in Y){if(Y[Z]==null){delete Y[Z]}}return Y}function I(Y,Z,aa){if(aa!=null){Y[Z]=aa}}function h(Y,aa){if(typeof Y!="string"){Y=Y.name;aa=aa.name}var Z=/^[A-Z]/.test(Y),ab=/^[A-Z]/.test(aa);if(Z==ab){return Y<aa?-1:Y==aa?0:1}else{return Z?1:-1}}function G(Z,aa,Y){return Z.type=="Literal"&&typeof Z.value=="string"&&Z.start==aa-1&&Z.end<=Y+1}function o(ae,ad,Z){if(ad.end==null){throw U("missing .query.end field")}var aj=O(Z,ad.end),ai=aj,af=Z.text;while(aj&&a.isIdentifierChar(af.charCodeAt(aj-1))){--aj}if(ad.expandWordForward!==false){while(ai<af.length&&a.isIdentifierChar(af.charCodeAt(ai))){++ai}}var ah=af.slice(aj,ai),Y=[];if(ad.caseInsensitive){ah=ah.toLowerCase()}var ak=ad.types||ad.depths||ad.docs||ad.urls||ad.origins;function aa(ap,ao,am){if(ad.omitObjectPrototype!==false&&ao==ae.cx.protos.Object&&!ah){return}if(ad.filter!==false&&ah&&(ad.caseInsensitive?ap.toLowerCase():ap).indexOf(ah)!=0){return}for(var an=0;an<Y.length;++an){var al=Y[an];if((ak?al.name:al)==ap){return}}var aq=ak?{name:ap}:ap;Y.push(aq);if(ad.types||ad.docs||ad.urls||ad.origins){var at=ao?ao.props[ap]:C.ANull;C.resetGuessing();var ar=at.getType();aq.guess=C.didGuess();if(ad.types){aq.type=C.toString(ar)}if(ad.docs){I(aq,"doc",at.doc||ar&&ar.doc)}if(ad.urls){I(aq,"url",at.url||ar&&ar.url)}if(ad.origins){I(aq,"origin",at.origin||ar&&ar.origin)}}if(ad.depths){aq.depth=am}}var ab=C.findExpressionAround(Z.ast,null,aj,Z.scope,"MemberExpression");if(ab&&(ab.node.computed?G(ab.node.property,aj,ai):ab.node.object.end<aj)){var ac=ab.node.property;ac=ac.type=="Literal"?ac.value.slice(1):ac.name;ab.node=ab.node.object;var ag=C.expressionType(ab);if(ag){C.forAllPropertiesOf(ag,aa)}if(!Y.length&&ad.guess!==false&&ag&&ag.guessProperties){ag.guessProperties(function(an,am,al){if(an!=ac&&an!="?"){aa(an,am,al)}})}if(!Y.length&&ah.length>=2&&ad.guess!==false){for(var ac in ae.cx.props){aa(ac,ae.cx.props[ac][0],0)}}}else{C.forAllLocalsAt(Z.ast,aj,Z.scope,aa)}if(ad.sort!==false){Y.sort(h)}return{start:K(ad,Z,aj),end:K(ad,Z,ai),completions:Y}}function v(ac,ab){var Z=ab.prefix,Y=[];for(var aa in ac.cx.props){if(aa!="<i>"&&(!Z||aa.indexOf(Z)==0)){Y.push(aa)}}if(ab.sort!==false){Y.sort(h)}return{completions:Y}}var r=l.findQueryExpr=function(aa,ab,ae){if(ab.end==null){throw U("missing .query.end field")}if(ab.variable){var ac=C.scopeAt(aa.ast,O(aa,ab.end),aa.scope);return{node:{type:"Identifier",name:ab.variable,start:ab.end,end:ab.end+1},state:ac}}else{var ad=ab.start&&O(aa,ab.start),Y=O(aa,ab.end);var Z=C.findExpressionAt(aa.ast,ad,Y,aa.scope);if(Z){return Z}Z=C.findExpressionAround(aa.ast,ad,Y,aa.scope);if(Z&&(ae||(ad==null?Y:ad)-Z.node.start<20||Z.node.end-Y<20)){return Z}throw U("No expression at the given position.")}};function z(Y,ac,ab){var Z=r(ab,ac);C.resetGuessing();var ae=C.expressionType(Z);if(ac.preferFunction){ae=ae.getFunctionType()||ae.getType()}else{ae=ae.getType()}if(Z.node.type=="Identifier"){var aa=Z.node.name}else{if(Z.node.type=="MemberExpression"&&!Z.node.computed){var aa=Z.node.property.name}}if(ac.depth!=null&&typeof ac.depth!="number"){throw U(".query.depth must be a number")}var ad={guess:C.didGuess(),type:C.toString(ae,ac.depth),name:ae&&ae.name,exprName:aa};if(ae){T(ae,ad)}return f(ad)}function q(Y,ac,aa){var Z=r(aa,ac);var ae=C.expressionType(Z);var ad={url:ae.url,doc:ae.doc};var ab=ae.getType();if(ab){T(ab,ad)}return f(ad)}function E(aa,Y){var Z=X.findNodeAt(Y,aa.start,aa.end,aa.type,C.fullVisitor);return Z&&Z.node==aa}function T(ab,aa){if(!aa.url){aa.url=ab.url}if(!aa.doc){aa.doc=ab.doc}if(!aa.origin){aa.origin=ab.origin}var Z,Y=C.cx().protos;if(!aa.url&&!aa.doc&&ab.proto&&(Z=ab.proto.hasCtor)&&ab.proto!=Y.Object&&ab.proto!=Y.Function&&ab.proto!=Y.Array){aa.url=Z.url;aa.doc=Z.doc}}var B=l.getSpan=function(Z){if(!Z.origin){return}if(Z.originNode){var Y=Z.originNode;if(/^Function/.test(Y.type)&&Y.id){Y=Y.id}return{origin:Z.origin,node:Y}}if(Z.span){return{origin:Z.origin,span:Z.span}}};var S=l.storeSpan=function(ac,aa,ab,ad){ad.origin=ab.origin;if(ab.span){var Z=/^(\d+)\[(\d+):(\d+)\]-(\d+)\[(\d+):(\d+)\]$/.exec(ab.span);ad.start=aa.lineCharPositions?{line:Number(Z[2]),ch:Number(Z[3])}:Number(Z[1]);ad.end=aa.lineCharPositions?{line:Number(Z[5]),ch:Number(Z[6])}:Number(Z[4])}else{var Y=s(ac.files,ab.origin);ad.start=K(aa,Y,ab.node.start);ad.end=K(aa,Y,ab.node.end)}};function p(ah,ad,ab){var aa=r(ab,ad);C.resetGuessing();var ak=C.expressionType(aa);if(C.didGuess()){return{}}var af=B(ak);var ae={url:ak.url,doc:ak.doc,origin:ak.origin};if(ak.types){for(var ac=ak.types.length-1;ac>=0;--ac){var aj=ak.types[ac];T(aj,ae);if(!af){af=B(aj)}}}if(af&&af.node){var ag=s(ah.files,af.origin);if(ab.type=="part"&&ab.name==af.origin&&af.node&&E(af.node,ab.ast)){ag=ab}var ai=K(ad,ag,af.node.start),Z=K(ad,ag,af.node.end);ae.start=ai;ae.end=Z;ae.file=af.origin;var Y=Math.max(0,af.node.start-50);ae.contextOffset=af.node.start-Y;ae.context=ag.text.slice(Y,Y+50)}else{if(af){ae.file=af.origin;S(ah,ad,af,ae)}}return f(ae)}function y(ai,af,ab,aa,Y){var ad=aa.node.name;for(var ah=aa.state;ah&&!(ad in ah.props);ah=ah.prev){}if(!ah){throw U("Could not find a definition for "+ad+" "+!!ai.cx.topScope.props.x)}var ak,ag=[];function aj(al){return function(an,ap){if(Y){for(var ao=ap;ao!=ah;ao=ao.prev){var am=ao.hasProp(Y);if(am){throw U("Renaming `"+ad+"` to `"+Y+"` would make a variable at line "+(d(al,an.start).line+1)+" point to the definition at line "+(d(al,am.name.start).line+1))}}}ag.push({file:al.name,start:K(af,al,an.start),end:K(af,al,an.end)})}}if(ah.node){ak="local";if(Y){for(var ae=ah.prev;ae;ae=ae.prev){if(Y in ae.props){break}}if(ae){C.findRefs(ah.node,ah,Y,ae,function(al){throw U("Renaming `"+ad+"` to `"+Y+"` would shadow the definition used at line "+(d(ab,al.start).line+1))})}}C.findRefs(ah.node,ah,ad,ah,aj(ab))}else{ak="global";for(var ac=0;ac<ai.files.length;++ac){var Z=ai.files[ac];C.findRefs(Z.ast,Z.scope,ad,ah,aj(Z))}}return{refs:ag,type:ak,name:ad}}function x(af,ad,Z,ac){var ab=C.expressionType(Z).getType();if(!ab){throw U("Couldn't determine type of base object.")}var ae=[];function ag(ah){return function(ai){ae.push({file:ah.name,start:K(ad,ah,ai.start),end:K(ad,ah,ai.end)})}}for(var aa=0;aa<af.files.length;++aa){var Y=af.files[aa];C.findPropRefs(Y.ast,Y.scope,ab,ac.name,ag(Y))}return{refs:ae,name:ac.name}}function w(af,ae,Z){var Y=r(Z,ae,true);if(Y&&Y.node.type=="Identifier"){return y(af,ae,Z,Y)}else{if(Y&&Y.node.type=="MemberExpression"&&!Y.node.computed){var ac=Y.node.property;Y.node=Y.node.object;return x(af,ae,Y,ac)}else{if(Y&&Y.node.type=="ObjectExpression"){var ad=O(Z,ae.end);for(var aa=0;aa<Y.node.properties.length;++aa){var ab=Y.node.properties[aa].key;if(ab.start<=ad&&ab.end>=ad){return x(af,ae,Y,ab)}}}}}throw U("Not at a variable or property name.")}function e(af,ad,ab){if(typeof ad.newName!="string"){throw U(".query.newName should be a string")}var aa=r(ab,ad);if(!aa||aa.node.type!="Identifier"){throw U("Not at a variable.")}var Z=y(af,ad,ab,aa,ad.newName),ae=Z.refs;delete Z.refs;Z.files=af.files.map(function(ah){return ah.name});var Y=Z.changes=[];for(var ac=0;ac<ae.length;++ac){var ag=ae[ac];ag.text=ad.newName;Y.push(ag)}return Z}function H(Y){return{files:Y.files.map(function(Z){return Z.name})}}l.version="0.4.1"});